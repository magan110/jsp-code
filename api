using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Http;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;

namespace MyFirstApi.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class DsrController : ControllerBase
    {
        private readonly DatabaseHelper _db;

        // max‐length constants
        private const int LDocuNumb   = 16;
        private const int LDsrParam   = 2;
        private const int LCusRtlFl   = 2;
        private const int LCusRtlCd   = 8;
        private const int LDeptCode   = 6;
        private const int LStatFlag   = 1;
        private const int LCreateId   = 10;
        private const int LUpdateId   = 10;
        private const int LRemLong    = 500;
        private const int LRemShort   = 50;
        private const int LAtchNmId   = 100;
        private const int LLatLong    = 30;
        private const int LAreaCode   = 3;
        private const int LCuRtType   = 2;
        private const int LRetlStFl   = 1;
        private const int LPinCodeN   = 6;
        private const int LCityName   = 40;
        private const int LDistrict   = 35;
        private const int LCstBisTy   = 2;
        private const int LPendWith   = 10;
        private const int LLtLgDist   = 100;
        private const int LApprRemk   = 100;
        private const int LRefOrdNo   = 16;
        private const int LIsTilRtl   = 1;

        public DsrController(DatabaseHelper db) => _db = db;

        // --------------------------------------------------------------------
        // 1) Generic CRUD
        // --------------------------------------------------------------------

        [HttpGet]
        public IActionResult GetAll()
        {
            try
            {
                var rows = _db.WebSessBean("SELECT * FROM dptDSRActvt", new Dictionary<string, object>());
                return Ok(rows);
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        [HttpGet("{docuNumb}")]
        public IActionResult Get(string docuNumb)
        {
            try
            {
                var rows = _db.WebSessBean(
                    "SELECT * FROM dptDSRActvt WHERE docuNumb = @docuNumb",
                    new Dictionary<string, object> { ["@docuNumb"] = docuNumb });
                if (rows.Count == 0) return NotFound();
                return Ok(rows[0]);
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        [HttpPost]
        public ActionResult<DsrRequest> Create([FromBody] DsrRequest req)
        {
            var bad = Validate(req);
            if (bad != null) return bad;

            const string sql = @"
INSERT INTO dptDSRActvt
  (docuNumb, docuDate, deptCode, statFlag, createId, updateId,
   dsrParam, cusRtlFl, cusRtlCd,
   dsrRem01, dsrRem02, dsrRem03, dsrRem04,
   dsrRem05, dsrRem06, dsrRem07, dsrRem08,
   dsrRem09, dsrRem10,
   atchNmId, locaCapr, latitute, lgtitute,
   areaCode, cuRtType,
   retlStFl, pinCodeN, cityName, district,
   cstBisTy, pendWith, ltLgDist, apprRemk,
   ordInsFl, refOrdNo, isTilRtl,
   ordExDat, dsrParTy,
   createDt, updateDt)
VALUES
  (@docuNumb, @docuDate, @deptCode, @statFlag, @createId, @updateId,
   @dsrParam, @cusRtlFl, @cusRtlCd,
   @dsrRem01, @dsrRem02, @dsrRem03, @dsrRem04,
   @dsrRem05, @dsrRem06, @dsrRem07, @dsrRem08,
   @dsrRem09, @dsrRem10,
   @atchNmId, @locaCapr, @latitute, @lgtitute,
   @areaCode, @cuRtType,
   @retlStFl, @pinCodeN, @cityName, @district,
   @cstBisTy, @pendWith, @ltLgDist, @apprRemk,
   @ordInsFl, @refOrdNo, @isTilRtl,
   @ordExDat, @dsrParTy,
   GETDATE(), GETDATE());";

            var p = new Dictionary<string, object>
            {
                ["@docuNumb"] = req.docuNumb,
                ["@docuDate"] = req.docuDate,
                ["@deptCode"] = req.deptCode,
                ["@statFlag"] = req.statFlag,
                ["@createId"] = req.createId,
                ["@updateId"] = req.updateId,
                ["@dsrParam"] = req.dsrParam,
                ["@cusRtlFl"] = req.cusRtlFl,
                ["@cusRtlCd"] = req.cusRtlCd,
                ["@dsrRem01"] = req.dsrRem01,
                ["@dsrRem02"] = req.dsrRem02,
                ["@dsrRem03"] = req.dsrRem03,
                ["@dsrRem04"] = req.dsrRem04,
                ["@dsrRem05"] = req.dsrRem05,
                ["@dsrRem06"] = req.dsrRem06,
                ["@dsrRem07"] = req.dsrRem07,
                ["@dsrRem08"] = req.dsrRem08,
                ["@dsrRem09"] = req.dsrRem09,
                ["@dsrRem10"] = req.dsrRem10,
                ["@atchNmId"] = req.atchNmId,
                ["@locaCapr"] = req.locaCapr,
                ["@latitute"] = req.latitute,
                ["@lgtitute"] = req.lgtitute,
                ["@areaCode"] = req.areaCode,
                ["@cuRtType"] = req.cuRtType,
                ["@retlStFl"] = req.retlStFl,
                ["@pinCodeN"] = req.pinCodeN,
                ["@cityName"] = req.cityName,
                ["@district"] = req.district,
                ["@cstBisTy"] = req.cstBisTy,
                ["@pendWith"] = req.pendWith,
                ["@ltLgDist"] = req.ltLgDist,
                ["@apprRemk"] = req.apprRemk,
                ["@ordInsFl"] = req.ordInsFl,
                ["@refOrdNo"] = req.refOrdNo,
                ["@isTilRtl"] = req.isTilRtl,
                ["@ordExDat"] = req.ordExDat ?? (object)DBNull.Value,
                ["@dsrParTy"] = req.dsrParTy
            };

            try
            {
                _db.WebSessBean(sql, p);
                return CreatedAtAction(nameof(Get), new { docuNumb = req.docuNumb }, req);
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        [HttpPut("{docuNumb}")]
        public IActionResult Update(string docuNumb, [FromBody] DsrRequest req)
        {
            var bad = Validate(req);
            if (bad != null) return bad;

            const string sql = @"
UPDATE dptDSRActvt
   SET docuDate = @docuDate, deptCode = @deptCode, statFlag = @statFlag,
       updateId = @updateId, dsrParam = @dsrParam, cusRtlFl = @cusRtlFl,
       cusRtlCd = @cusRtlCd, dsrRem01 = @dsrRem01, dsrRem02 = @dsrRem02,
       dsrRem03 = @dsrRem03, dsrRem04 = @dsrRem04, dsrRem05 = @dsrRem05,
       dsrRem06 = @dsrRem06, dsrRem07 = @dsrRem07, dsrRem08 = @dsrRem08,
       dsrRem09 = @dsrRem09, dsrRem10 = @dsrRem10, atchNmId = @atchNmId,
       locaCapr = @locaCapr, latitute = @latitute, lgtitute = @lgtitute,
       areaCode = @areaCode, cuRtType = @cuRtType, retlStFl = @retlStFl,
       pinCodeN = @pinCodeN, cityName = @cityName, district = @district,
       cstBisTy = @cstBisTy, pendWith = @pendWith, ltLgDist = @ltLgDist,
       apprRemk = @apprRemk, ordInsFl = @ordInsFl, refOrdNo = @refOrdNo,
       isTilRtl = @isTilRtl, ordExDat = @ordExDat, dsrParTy = @dsrParTy,
       updateDt = GETDATE()
 WHERE docuNumb = @docuNumb;";

            var p = new Dictionary<string, object>
            {
                ["@docuNumb"] = docuNumb,
                ["@docuDate"] = req.docuDate,
                ["@deptCode"] = req.deptCode,
                ["@statFlag"] = req.statFlag,
                ["@updateId"] = req.updateId,
                ["@dsrParam"] = req.dsrParam,
                ["@cusRtlFl"] = req.cusRtlFl,
                ["@cusRtlCd"] = req.cusRtlCd,
                ["@dsrRem01"] = req.dsrRem01,
                ["@dsrRem02"] = req.dsrRem02,
                ["@dsrRem03"] = req.dsrRem03,
                ["@dsrRem04"] = req.dsrRem04,
                ["@dsrRem05"] = req.dsrRem05,
                ["@dsrRem06"] = req.dsrRem06,
                ["@dsrRem07"] = req.dsrRem07,
                ["@dsrRem08"] = req.dsrRem08,
                ["@dsrRem09"] = req.dsrRem09,
                ["@dsrRem10"] = req.dsrRem10,
                ["@atchNmId"] = req.atchNmId,
                ["@locaCapr"] = req.locaCapr,
                ["@latitute"] = req.latitute,
                ["@lgtitute"] = req.lgtitute,
                ["@areaCode"] = req.areaCode,
                ["@cuRtType"] = req.cuRtType,
                ["@retlStFl"] = req.retlStFl,
                ["@pinCodeN"] = req.pinCodeN,
                ["@cityName"] = req.cityName,
                ["@district"] = req.district,
                ["@cstBisTy"] = req.cstBisTy,
                ["@pendWith"] = req.pendWith,
                ["@ltLgDist"] = req.ltLgDist,
                ["@apprRemk"] = req.apprRemk,
                ["@ordInsFl"] = req.ordInsFl,
                ["@refOrdNo"] = req.refOrdNo,
                ["@isTilRtl"] = req.isTilRtl,
                ["@ordExDat"] = req.ordExDat ?? (object)DBNull.Value,
                ["@dsrParTy"] = req.dsrParTy
            };

            try
            {
                var count = _db.WebSessBean(sql, p).Count;
                if (count == 0) return NotFound();
                return NoContent();
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        [HttpDelete("{docuNumb}")]
        public IActionResult Delete(string docuNumb)
        {
            try
            {
                var count = _db.WebSessBean(
                    "DELETE FROM dptDSRActvt WHERE docuNumb = @docuNumb",
                    new Dictionary<string, object> { ["@docuNumb"] = docuNumb }
                ).Count;
                if (count == 0) return NotFound();
                return NoContent();
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        // --------------------------------------------------------------------
        // 2) Internal Team Meeting
        // --------------------------------------------------------------------
        public class InternalTeamMeetingDto
        {
            public DateTime SubmissionDate   { get; set; }
            public DateTime ReportDate       { get; set; }
            public string   MeetWith         { get; set; } = "";
            public string   DiscussionPoints { get; set; } = "";
            public string   Learnings        { get; set; } = "";
            public string   CreateId         { get; set; } = "SYSTEM";
        }

        [HttpPost("internalTeamMeeting")]
        public IActionResult CreateInternalTeamMeeting([FromBody] InternalTeamMeetingDto dto)
        {
            if (string.IsNullOrWhiteSpace(dto.MeetWith))
                return BadRequest("MeetWith is required.");
            if (string.IsNullOrWhiteSpace(dto.DiscussionPoints))
                return BadRequest("DiscussionPoints is required.");
            if (string.IsNullOrWhiteSpace(dto.Learnings))
                return BadRequest("Learnings is required.");

            // 16-char docuNumb: "INTMT" + timestamp
            var docuNumb = "INTMT" + DateTime.UtcNow.ToString("yyMMddHHmmss").PadRight(11, '0');
            docuNumb = docuNumb.Substring(0, 16);

            const string sql = @"
INSERT INTO dptDSRActvt
  (docuNumb, docuDate, deptCode, statFlag, createId, updateId,
   dsrParam, cusRtlFl, cusRtlCd,
   dsrRem01, dsrRem02, dsrRem03,
   createDt, updateDt)
VALUES
  (@docuNumb, @docuDate, '', '', @createId, '',
   '52','', '',
   @dsrRem01,@dsrRem02,@dsrRem03,
   @createDt, GETDATE());";

            var p = new Dictionary<string, object>
            {
                ["@docuNumb"] = docuNumb,
                ["@docuDate"] = dto.ReportDate,
                ["@createId"] = dto.CreateId,
                ["@dsrRem01"] = dto.MeetWith,
                ["@dsrRem02"] = dto.DiscussionPoints,
                ["@dsrRem03"] = dto.Learnings,
                ["@createDt"] = dto.SubmissionDate
            };

            try
            {
                _db.WebSessBean(sql, p);
                return CreatedAtAction(nameof(Get), new { docuNumb }, dto);
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        // --------------------------------------------------------------------
        // 3) Office Work
        // --------------------------------------------------------------------
        public class OfficeWorkDto
        {
            public DateTime SubmissionDate { get; set; }
            public DateTime ReportDate     { get; set; }
            public string   WorkRelatedTo  { get; set; } = "";
            public string   HoursSpent     { get; set; } = "";
            public string   CreateId       { get; set; } = "SYSTEM";
        }

        [HttpPost("officeWork")]
        public IActionResult CreateOfficeWork([FromBody] OfficeWorkDto dto)
        {
            if (string.IsNullOrWhiteSpace(dto.WorkRelatedTo))
                return BadRequest("WorkRelatedTo is required.");
            if (string.IsNullOrWhiteSpace(dto.HoursSpent))
                return BadRequest("HoursSpent is required.");

            // 16-char docuNumb: "OFFWK" + timestamp
            var docuNumb = "OFFWK" + DateTime.UtcNow.ToString("yyMMddHHmmss").PadRight(11, '0');
            docuNumb = docuNumb.Substring(0, 16);

            const string sql = @"
INSERT INTO dptDSRActvt
  (docuNumb, docuDate, deptCode, statFlag, createId, updateId,
   dsrParam, cusRtlFl, cusRtlCd,
   dsrRem01, dsrRem02,
   createDt, updateDt)
VALUES
  (@docuNumb, @docuDate, '', '', @createId, '',
   '53','', '',
   @dsrRem01,@dsrRem02,
   @createDt, GETDATE());";

            var p = new Dictionary<string, object>
            {
                ["@docuNumb"] = docuNumb,
                ["@docuDate"] = dto.ReportDate,
                ["@createId"] = dto.CreateId,
                ["@dsrRem01"] = dto.WorkRelatedTo,
                ["@dsrRem02"] = dto.HoursSpent,
                ["@createDt"] = dto.SubmissionDate
            };

            try
            {
                _db.WebSessBean(sql, p);
                return CreatedAtAction(nameof(Get), new { docuNumb }, dto);
            }
            catch (Exception ex) { return StatusCode(500, ex.Message); }
        }

        // --------------------------------------------------------------------
        // 4) Validation helpers
        // --------------------------------------------------------------------

        private IActionResult Validate(DsrRequest req)
        {
            IActionResult bad;
            if ((bad = Check("docuNumb", req.docuNumb, LDocuNumb)) != null) return bad;
            if ((bad = Check("deptCode", req.deptCode, LDeptCode)) != null) return bad;
            if ((bad = Check("statFlag", req.statFlag, LStatFlag)) != null) return bad;
            if ((bad = Check("createId", req.createId, LCreateId)) != null) return bad;
            if ((bad = Check("updateId", req.updateId, LUpdateId)) != null) return bad;

            if ((bad = Check("dsrParam", req.dsrParam, LDsrParam)) != null) return bad;
            if ((bad = Check("cusRtlFl", req.cusRtlFl, LCusRtlFl)) != null) return bad;
            if ((bad = Check("cusRtlCd", req.cusRtlCd, LCusRtlCd)) != null) return bad;

            // dsrRem01–dsrRem08 = LRemLong; dsrRem09 = LRemLong; dsrRem10 = LRemShort
            for (int i = 1; i <= 8; i++)
            {
                var val = (string)typeof(DsrRequest)
                                .GetProperty($"dsrRem0{i}")!
                                .GetValue(req);
                if ((bad = Check($"dsrRem0{i}", val, LRemLong)) != null) return bad;
            }
            if ((bad = Check("dsrRem09", req.dsrRem09, LRemLong)) != null) return bad;
            if ((bad = Check("dsrRem10", req.dsrRem10, LRemShort)) != null) return bad;

            if ((bad = Check("atchNmId", req.atchNmId, LAtchNmId)) != null) return bad;
            if (string.IsNullOrEmpty(req.locaCapr)) return BadRequest("locaCapr is required.");
            if ((bad = Check("latitute", req.latitute, LLatLong)) != null) return bad;
            if ((bad = Check("lgtitute", req.lgtitute, LLatLong)) != null) return bad;

            if ((bad = Check("areaCode", req.areaCode, LAreaCode)) != null) return bad;
            if ((bad = Check("cuRtType", req.cuRtType, LCuRtType)) != null) return bad;

            if ((bad = Check("retlStFl", req.retlStFl, LRetlStFl)) != null) return bad;
            if ((bad = Check("pinCodeN", req.pinCodeN, LPinCodeN)) != null) return bad;
            if ((bad = Check("cityName", req.cityName, LCityName)) != null) return bad;
            if ((bad = Check("district", req.district, LDistrict)) != null) return bad;

            if ((bad = Check("cstBisTy", req.cstBisTy, LCstBisTy)) != null) return bad;
            if ((bad = Check("pendWith", req.pendWith, LPendWith)) != null) return bad;
            if ((bad = Check("ltLgDist", req.ltLgDist, LLtLgDist)) != null) return bad;
            if ((bad = Check("apprRemk", req.apprRemk, LApprRemk)) != null) return bad;

            if ((bad = Check("ordInsFl", req.ordInsFl, LIsTilRtl)) != null) return bad;
            if ((bad = Check("refOrdNo", req.refOrdNo, LRefOrdNo)) != null) return bad;
            if ((bad = Check("isTilRtl", req.isTilRtl, LIsTilRtl)) != null) return bad;

            if (req.dsrParTy <= 0) return BadRequest("dsrParTy must be > 0.");
            return null;
        }

        private IActionResult Check(string name, string value, int maxLen)
        {
            if (string.IsNullOrEmpty(value))
                return BadRequest($"{name} is required.");
            if (value.Length > maxLen)
                return BadRequest($"{name} must be ≤ {maxLen} chars (you sent {value.Length}).");
            return null;
        }
    }

    public class DsrRequest
    {
        public string   docuNumb  { get; set; }
        public DateTime docuDate  { get; set; }
        public string   deptCode  { get; set; }
        public string   statFlag  { get; set; }
        public string   createId  { get; set; }
        public string   updateId  { get; set; }
        public string   dsrParam  { get; set; }
        public string   cusRtlFl  { get; set; }
        public string   cusRtlCd  { get; set; }
        public string   dsrRem01  { get; set; }
        public string   dsrRem02  { get; set; }
        public string   dsrRem03  { get; set; }
        public string   dsrRem04  { get; set; }
        public string   dsrRem05  { get; set; }
        public string   dsrRem06  { get; set; }
        public string   dsrRem07  { get; set; }
        public string   dsrRem08  { get; set; }
        public string   dsrRem09  { get; set; }
        public string   dsrRem10  { get; set; }
        public string   atchNmId  { get; set; }
        public string   locaCapr  { get; set; }
        public string   latitute  { get; set; }
        public string   lgtitute  { get; set; }
        public string   areaCode  { get; set; }
        public string   cuRtType  { get; set; }
        public string   retlStFl  { get; set; }
        public string   pinCodeN  { get; set; }
        public string   cityName  { get; set; }
        public string   district  { get; set; }
        public string   cstBisTy  { get; set; }
        public string   pendWith  { get; set; }
        public string   ltLgDist  { get; set; }
        public string   apprRemk  { get; set; }
        public string   ordInsFl  { get; set; }
        public string   refOrdNo  { get; set; }
        public string   isTilRtl  { get; set; }
        public DateTime? ordExDat { get; set; }
        public short    dsrParTy  { get; set; }
    }
}

using System;
using System.Collections.Generic;
using System.Data.SqlClient;

namespace sparshWebService.DataAccess
{
    public class DatabaseHelper
    {
        private readonly string _bwliveConnectionString;
        private readonly string _itKhariaConnectionString;
        private readonly string _imageDataConnectionString;

        public DatabaseHelper(string bwliveConnectionString, string itKhariaConnectionString, string imageDataConnectionString)
        {
            _bwliveConnectionString = bwliveConnectionString;
            _itKhariaConnectionString = itKhariaConnectionString;
            _imageDataConnectionString = imageDataConnectionString;
        }

        // General method to execute SELECT queries for any connection string
        private List<Dictionary<string, object>> ExecuteSelectQuery(string connectionString, string query, Dictionary<string, object> parameters)
        {
            var resultList = new List<Dictionary<string, object>>();

            using (var conn = new SqlConnection(connectionString))
            using (var cmd = new SqlCommand(query, conn))
            {
                foreach (var param in parameters)
                {
                    cmd.Parameters.AddWithValue(param.Key, param.Value);
                }

                conn.Open();
                using (var reader = cmd.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        var row = new Dictionary<string, object>();
                        for (int i = 0; i < reader.FieldCount; i++)
                        {
                            row[reader.GetName(i)] = reader[i];
                        }
                        resultList.Add(row);
                    }
                }
            }

            return resultList;
        }

        // General method to execute INSERT, UPDATE, or DELETE queries for any connection string
        private int ExecuteCommand(string connectionString, string query, Dictionary<string, object> parameters)
        {
            using (var conn = new SqlConnection(connectionString))
            using (var cmd = new SqlCommand(query, conn))
            {
                foreach (var param in parameters)
                {
                    cmd.Parameters.AddWithValue(param.Key, param.Value);
                }

                conn.Open();
                return cmd.ExecuteNonQuery(); // Returns the number of rows affected
            }
        }

        // Function to handle queries for bwlive database (WebSessBean)
        public List<Dictionary<string, object>> WebSessBean(string query, Dictionary<string, object> parameters)
        {
            return ExecuteSelectQuery(_bwliveConnectionString, query, parameters);
        }

        // Function to handle queries for itKharia database (KkrSessBean)
        public List<Dictionary<string, object>> KkrSessBean(string query, Dictionary<string, object> parameters)
        {
            return ExecuteSelectQuery(_itKhariaConnectionString, query, parameters);
        }

        // Function to handle queries for imageData database (ImgSessBean)
        public List<Dictionary<string, object>> ImgSessBean(string query, Dictionary<string, object> parameters)
        {
            return ExecuteSelectQuery(_imageDataConnectionString, query, parameters);
        }

        // Retrieve SecretKey for a given PartnerID from the RegisteredUsers table (itKharia)
        public string GetSecretKey(string partnerId)
        {
            var query = "SELECT secrtKey FROM prmApiPrtnr WHERE partnrId = @PartnerID";
            var parameters = new Dictionary<string, object>
            {
                { "@PartnerID", partnerId }
            };

            var result = KkrSessBean(query, parameters);
            if (result.Count > 0)
            {
                return result[0]["secrtKey"]?.ToString();
            }

            throw new Exception("SecretKey not found for the given PartnerID.");
        }
        public List<string> GetAllowedAPIs(string partnerId)
        {
            var query = @"SELECT allwdAPI 
                  FROM prmApiPrtnr 
                  WHERE partnrId = @PartnerID";
            var parameters = new Dictionary<string, object>
    {
        { "@PartnerID", partnerId }
    };

            var result = KkrSessBean(query, parameters);
            if (result.Count > 0)
            {
                var allowedApis = result[0]["allwdAPI"]?.ToString();
                return allowedApis?.Split(',').Select(api => api.Trim().ToLower()).ToList();
            }

            throw new Exception("No APIs found for the given PartnerID.");
        }

        // Log API requests into the comApiLogs table (itKharia)
        public void InsertIntoLog(string partnerId, string endpoint, string responseStatus, int statCode, object requestBody)
        {
            var checkQuery = "SELECT COUNT(*) AS Count FROM prmApiPrtnr WHERE partnrId = @PartnerID";
            var checkParams = new Dictionary<string, object>
    {
        { "@PartnerID", partnerId }
    };

            var exists = KkrSessBean(checkQuery, checkParams);
            if (exists.Count == 0 || Convert.ToInt32(exists[0]["Count"]) == 0)
            {
                Console.WriteLine($"Warning: PartnerID '{partnerId}' does not exist. Log insertion skipped.");
                return;
            }
            // Extract up to 8 properties from the request body
            var bodyDict = requestBody?.GetType().GetProperties()
                .Where(p => p.GetValue(requestBody) != null)
                .Select(p => $"{p.Name}={p.GetValue(requestBody)}")
                .Take(8)
                .ToList() ?? new List<string>();

            // Fill missing fields with empty strings
            while (bodyDict.Count < 8)
                bodyDict.Add("");

            var insertQuery = @"
        INSERT INTO comApiLogs (PartnerID, Endpoint, ResponseStatus, statCode, ReqsBod1, ReqsBod2, ReqsBod3, ReqsBod4, ReqsBod5, ReqsBod6, ReqsBod7, ReqsBod8)
        VALUES (@PartnerID, @Endpoint, @ResponseStatus, @StatCode, @ReqsBod1, @ReqsBod2, @ReqsBod3, @ReqsBod4, @ReqsBod5, @ReqsBod6, @ReqsBod7, @ReqsBod8)";

            var insertParams = new Dictionary<string, object>
    {
        { "@PartnerID", partnerId },
        { "@Endpoint", endpoint },
        { "@ResponseStatus", responseStatus },
        { "@StatCode", statCode },
        { "@ReqsBod1", bodyDict[0] },
        { "@ReqsBod2", bodyDict[1] },
        { "@ReqsBod3", bodyDict[2] },
        { "@ReqsBod4", bodyDict[3] },
        { "@ReqsBod5", bodyDict[4] },
        { "@ReqsBod6", bodyDict[5] },
        { "@ReqsBod7", bodyDict[6] },
        { "@ReqsBod8", bodyDict[7] }
    };
            ExecuteCommand(_itKhariaConnectionString, insertQuery, insertParams);
        }
    }
}


using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using sparshWebService.DataAccess;
using System.IdentityModel.Tokens.Jwt;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// Add Controllers
builder.Services.AddControllers();
builder.Services.AddSwaggerGen();

// Retrieve Connection Strings
var connectionStrings = builder.Configuration.GetSection("ConnectionStrings").Get<Dictionary<string, string>>();

// Register DatabaseHelper as a Singleton
builder.Services.AddSingleton(provider =>
    new DatabaseHelper(
        connectionStrings["bwlive"],
        connectionStrings["itkHaria"],
        connectionStrings["imageData"]));

// Add HttpClient for DI
builder.Services.AddHttpClient();

// Add Authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = false,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = "Birla White IT", // Set your valid issuer
            IssuerSigningKeyResolver = (token, securityToken, kid, parameters) =>
            {
                // Resolve signing key dynamically based on PartnerID
                var jwtToken = new JwtSecurityTokenHandler().ReadJwtToken(token);
                var partnerId = jwtToken.Claims.FirstOrDefault(c => c.Type == "PartnerID")?.Value;
                if (partnerId != null)
                {
                    var dbHelper = builder.Services.BuildServiceProvider().GetRequiredService<DatabaseHelper>();
                    var secretKey = dbHelper.GetSecretKey(partnerId); // Retrieve SecretKey from DB
                    if (!string.IsNullOrEmpty(secretKey))
                    {
                        return new[] { new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey)) };
                    }
                }
                throw new SecurityTokenInvalidSigningKeyException("Invalid PartnerID or SecretKey.");
            }
        };

        options.Events = new JwtBearerEvents
        {
            OnMessageReceived = context =>
            {
                var authHeader = context.Request.Headers["Authorization"].ToString();
                if (!string.IsNullOrEmpty(authHeader) && authHeader.StartsWith("Bearer "))
                {
                    context.Token = authHeader.Replace("Bearer ", "");
                }
                return Task.CompletedTask;
            }
        };
    });

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

// Custom Middleware for PartnerID and API access validation
app.UseMiddleware<AuthenticationMiddleware>();

app.UseHttpsRedirection();
app.UseAuthentication();
app.UseAuthorization();

// Add a default home page for the API
app.MapGet("/", async context =>
{
    context.Response.ContentType = "text/html";
    await context.Response.WriteAsync("<h1>Welcome to My API</h1><p>This is the default home page.</p>");
});

app.MapControllers();
app.Run();

