using System;
using System.Collections.Generic;
using System.Linq;
using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;    // your DatabaseHelper namespace

namespace sparshWebService.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class DsrRetailerInOutController : ControllerBase
    {
        private readonly DatabaseHelper _dbHelper;

        public DsrRetailerInOutController(DatabaseHelper dbHelper)
        {
            _dbHelper = dbHelper;
        }

        /// <summary>
        /// GET /api/DsrRetailerInOut/areaCodes
        /// Returns all active area codes (excluding only-DP) from bwlive.dbo.bkmAreaMast.
        /// </summary>
        [HttpGet("areaCodes")]
        [ProducesResponseType(typeof(IEnumerable<AreaCodeDto>), 200)]
        [ProducesResponseType(500)]
        public IActionResult GetAreaCodes()
        {
            try
            {
                // No parameters needed here
                var rows = _dbHelper.WebSessBean(
                    @"SELECT areaCode, areaDesc
                      FROM bwlive.dbo.bkmAreaMast WITH(NOLOCK)
                      WHERE isActive = 'Y'
                        AND isOnlyDp <> 'Y'
                      ORDER BY areaDesc",
                    new Dictionary<string, object>());

                var list = rows
                    .Select(r => new AreaCodeDto {
                        Code        = r["areaCode"]?.ToString() ?? "",
                        Description = r["areaDesc"]?.ToString() ?? ""
                    })
                    .ToList();

                return Ok(list);
            }
            catch (Exception ex)
            {
                // log ex if you have logging
                return StatusCode(500, $"Error fetching area codes: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// DTO for area-code dropdown.
    /// </summary>
    public class AreaCodeDto
    {
        /// <summary>
        /// e.g. "DEL", "MUM"
        /// </summary>
        public string Code { get; set; } = "";

        /// <summary>
        /// e.g. "Delhi", "Mumbai"
        /// </summary>
        public string Description { get; set; } = "";
    }
}
