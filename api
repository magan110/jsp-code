using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;
using YourApp.Data;
using YourApp.Models;
using YourApp.ViewModels;

namespace YourApp.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class DsrController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public DsrController(ApplicationDbContext context)
        {
            _context = context;
        }

        /// <summary>
        /// Submit Office Work activity.
        /// </summary>
        /// <param name="vm">Office work details.</param>
        [HttpPost("officework")]
        public async Task<IActionResult> SubmitOfficeWork([FromBody] OfficeWorkViewModel vm)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            // Create main DSR record
            var activity = new DsrActivity
            {
                DocuNumb = await _context.GenerateDocumentNumberAsync("DSR", vm.AreaCode),
                DocuDate = vm.ReportDate,
                DsrParam = "53", // Office Work code
                CusRtlFl = null,
                AreaCode = vm.AreaCode,
                CusRtlCd = null,
                DsrRem01 = vm.WorkRelatedTo,
                DsrRem02 = vm.HoursSpent.ToString(),
                DepartmentCode = vm.DeptCode,
                CreatedBy = User.Identity.Name,
                CreatedAt = DateTime.UtcNow
            };

            _context.DsrActivities.Add(activity);
            await _context.SaveChangesAsync();

            // Insert detail record for Office Work
            var detail = new DsrActivityDetail
            {
                DocuNumb = activity.DocuNumb,
                RepoCatg = null,
                ProdQnty = 0,
                ProjQnty = vm.HoursSpent,
                ActnRemk = vm.WorkRelatedTo,
                TargetDt = null
            };
            _context.DsrActivityDetails.Add(detail);
            await _context.SaveChangesAsync();

            return Ok(new { Message = "Office work entry submitted", DocuNumb = activity.DocuNumb });
        }
    }
}
