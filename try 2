using Microsoft.AspNetCore.Mvc;
using RAKControllers.DataAccess;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace RAKControllers.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class SampleDistributionController : ControllerBase
    {
        private readonly DatabaseHelper _dbHelper;

        public SampleDistributionController(DatabaseHelper dbHelper)
        {
            _dbHelper = dbHelper;
        }

        // ----------------------------
        // 1) Emirates dropdown (Areas)
        // ----------------------------
        [HttpGet("areas")]
        public ActionResult<IEnumerable<AreaItem>> GetAreas([FromQuery] bool onlyActive = true)
        {
            try
            {
                const string sql = @"
SELECT areaCode, areaDesc
FROM dbo.bkmAreaMast WITH (NOLOCK)
WHERE (@onlyActive = 0 OR isActive = 'Y')
ORDER BY areaDesc;";

                var parameters = new Dictionary<string, object>
                {
                    { "@onlyActive", onlyActive ? 1 : 0 }
                };

                var result = _dbHelper.WebSessBean(sql, parameters);
                var list = new List<AreaItem>();

                if (result != null)
                {
                    foreach (var row in result)
                    {
                        list.Add(new AreaItem
                        {
                            code = row["areaCode"]?.ToString()?.Trim() ?? "",
                            desc = row["areaDesc"]?.ToString()?.Trim() ?? ""
                        });
                    }
                }

                return Ok(list);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { success = false, message = ex.Message });
            }
        }

        // -----------------------------------------
        // 2) Submit the Sample Distribution payload
        // -----------------------------------------
        [HttpPost("submit")]
        public ActionResult<SubmitResponse> Submit([FromBody] SampleDistributionRequest req)
        {
            try
            {
                // Basic validations
                if (req == null) return BadRequest("Empty request.");
                if (string.IsNullOrWhiteSpace(req.emirate)) return BadRequest("Emirate (areaCode) is required.");
                if (string.IsNullOrWhiteSpace(req.retailerName)) return BadRequest("Retailer Name is required.");
                if (string.IsNullOrWhiteSpace(req.distributor)) return BadRequest("Concern Distributor is required.");
                if (string.IsNullOrWhiteSpace(req.painterName)) return BadRequest("Painter/Contractor Name is required.");
                if (string.IsNullOrWhiteSpace(req.skuSize)) return BadRequest("Material SKU is required.");
                if (string.IsNullOrWhiteSpace(req.distributionDate)) return BadRequest("Date of distribution is required.");

                if (!DateTime.TryParse(req.distributionDate, out var sampDate))
                    return BadRequest("Invalid distribution date.");

                // Map SKU text -> DB packSize & product name
                var (packSize, prodName) = MapSku(req.skuSize);

                // CreateId from header or request (max 6 chars)
                var loginId = Request.Headers.ContainsKey("LoginID")
                    ? (Request.Headers["LoginID"].ToString() ?? "SYSTEM")
                    : (string.IsNullOrWhiteSpace(req.loginId) ? "SYSTEM" : req.loginId);
                loginId = (loginId ?? "SYSTEM").Trim();
                if (loginId.Length > 6) loginId = loginId.Substring(0, 6);

                var areaCode = req.emirate.Trim();

                // --- Generate the document number ---
                const string genSql = "EXEC dbo.wcpDocNoGen @DocType, @AreaCode";
                var genParams = new Dictionary<string, object>
                {
                    ["@DocType"] = "SDE",
                    ["@AreaCode"] = areaCode
                };

                var genRows = _dbHelper.WebSessBean(genSql, genParams) as List<Dictionary<string, object>>;
                string docuNumb = null;
                if (genRows != null && genRows.Count > 0)
                {
                    var row = genRows.First();
                    var candidates = new[] { "docuNumb", "DocuNumb", "DOCUNUMB", "DocNo", "DocumentNo" };
                    foreach (var key in candidates)
                    {
                        if (row.TryGetValue(key, out var val) && val != null)
                        {
                            docuNumb = val.ToString();
                            break;
                        }
                    }
                    if (string.IsNullOrWhiteSpace(docuNumb) && row.Count > 0)
                        docuNumb = row.First().Value?.ToString();
                }

                if (string.IsNullOrWhiteSpace(docuNumb))
                {
                    return StatusCode(500, new SubmitResponse
                    {
                        success = false,
                        message = $"Failed to generate document number for area '{areaCode}'.",
                        docuNumb = null
                    });
                }

                // --- Immediately advance the sequence ---
                const string updSql = "EXEC dbo.wcpDocNoUpd @DocType, @AreaCode";
                _dbHelper.WebSessBean(updSql, genParams);

                // ================= HEADER: dbo.catsamplead =================
                var insertHeaderSql = @"
INSERT INTO dbo.catsamplead
(
  docuNumb, docuDate, areaCode, custName, contName, mobileNo,
  concDist, sampDate, misdQnty, packSize, prodName, sampType,
  statFlag, createId, createDt
)
VALUES
(
  @docuNumb, GETDATE(), @areaCode, @custName, @contName, @mobileNo,
  @concDist, @sampDate, @misdQnty, @packSize, @prodName, @sampType,
  'N', @createId, GETDATE()
);";

                var headerParams = new Dictionary<string, object>
                {
                    ["@docuNumb"] = docuNumb,                         // varchar(16)
                    ["@areaCode"] = areaCode,                         // varchar(20)
                    ["@custName"] = req.retailerName?.Trim() ?? (object)DBNull.Value,  // varchar(50) null
                    ["@contName"] = req.painterName?.Trim() ?? (object)DBNull.Value,   // varchar(50) null
                    ["@mobileNo"] = req.painterMobile?.Trim() ?? (object)DBNull.Value, // varchar(13) null
                    ["@concDist"] = req.distributor?.Trim() ?? (object)DBNull.Value,   // varchar(50) null
                    ["@sampDate"] = sampDate,                         // smalldatetime null
                    ["@misdQnty"] = req.missedQty?.Trim() ?? (object)DBNull.Value,     // char(10) null
                    ["@packSize"] = (object?)packSize ?? DBNull.Value,                  // char(3) null
                    ["@prodName"] = (object?)prodName ?? DBNull.Value,                  // varchar(100) null
                    ["@sampType"] = "SampleDistribution",             // varchar(20) null
                    ["@createId"] = loginId                           // varchar(6) null
                };

                _dbHelper.WebExecute(insertHeaderSql, headerParams);

                // ================ DETAIL: dbo.catsampleadDtl ================
                // Required: serialNo (NOT NULL), docuNumb (NOT NULL), sampCnCl (NOT NULL, 1 char)
                // We'll set serialNo = next value within this docuNumb, sampCnCl = 'S' (sample).
                var nextSerialSql = @"
SELECT ISNULL(MAX(serialNo), 0) + 1 AS nextSerial
FROM dbo.catsampleadDtl WITH (NOLOCK)
WHERE docuNumb = @docuNumb;";

                var nextSerialRows = _dbHelper.WebSessBean(nextSerialSql, new Dictionary<string, object>
                {
                    ["@docuNumb"] = docuNumb
                }) as List<Dictionary<string, object>>;

                int nextSerial = 1;
                if (nextSerialRows != null && nextSerialRows.Count > 0)
                {
                    var v = nextSerialRows[0].Values?.FirstOrDefault()?.ToString();
                    if (int.TryParse(v, out var parsed)) nextSerial = parsed;
                }

                var insertDetailSql = @"
INSERT INTO dbo.catsampleadDtl
(
  docuNumb, sampDate, pouchCnt, sampCnCl,
  statFlag, createId, createDt
)
VALUES
(
  @docuNumb, @sampDate, @pouchCnt, @sampCnCl,
  'N', @createId, GETDATE()
);
";

                var detailParams = new Dictionary<string, object>
                {
                    ["@serialNo"] = nextSerial,                                     // int NOT NULL
                    ["@docuNumb"] = docuNumb,                                       // varchar(16) NOT NULL
                    ["@sampDate"] = sampDate,                                       // smalldatetime
                    ["@pouchCnt"] = (object?)(req.materialQty?.Trim()) ?? DBNull.Value, // varchar(10) null
                    ["@sampCnCl"] = "S",                                            // varchar(1) NOT NULL (set as Sample)
                    ["@createId"] = loginId
                };

                _dbHelper.WebExecute(insertDetailSql, detailParams);

                return Ok(new SubmitResponse
                {
                    success = true,
                    message = "Saved successfully.",
                    docuNumb = docuNumb
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new SubmitResponse
                {
                    success = false,
                    message = ex.Message,
                    docuNumb = null
                });
            }
        }

        // -----------------------
        // Helpers / Utilities
        // -----------------------
        private static (string packSize, string prodName) MapSku(string sku)
        {
            // SKU mapping: "1 Kg" -> packSize = "01K"; "5 Kg" -> "05K"; default: digits + 'K'
            if (string.IsNullOrWhiteSpace(sku)) return (null, null);
            var s = sku.Trim().ToLower();
            if (s.StartsWith("1")) return ("01K", "BW Putty 1 Kg");
            if (s.StartsWith("5")) return ("05K", "BW Putty 5 Kg");

            // fallback: extract first number (kg)
            var digits = new string(s.Where(char.IsDigit).ToArray());
            var pack = string.IsNullOrEmpty(digits) ? null : (digits.Length == 1 ? $"0{digits}K" : $"{digits}K");
            var name = string.IsNullOrEmpty(digits) ? null : $"BW Putty {digits} Kg";
            return (pack, name);
        }
    }

    // DTOs
    public class AreaItem
    {
        public string code { get; set; }  // areaCode (char/varchar)
        public string desc { get; set; }  // areaDesc
    }

    public class SampleDistributionRequest
    {
        public string? loginId { get; set; }          // optional; or via header: LoginID
        public string emirate { get; set; }           // areaCode
        public string retailerName { get; set; }      // custName
        public string? retailerCode { get; set; }     // not used here
        public string distributor { get; set; }       // concDist
        public string painterName { get; set; }       // contName
        public string? painterMobile { get; set; }    // mobileNo
        public string skuSize { get; set; }           // -> packSize + prodName mapping
        public string? materialQty { get; set; }      // -> pouchCnt (Dtl)
        public string? missedQty { get; set; }        // -> misdQnty (Hdr)
        public string distributionDate { get; set; }  // -> sampDate (yyyy-MM-dd)
        public string? salesLead { get; set; }        // reserved
    }

    public class SubmitResponse
    {
        public bool success { get; set; }
        public string message { get; set; }
        public string? docuNumb { get; set; }
    }
}
