using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;

namespace sparshWebService.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ImageUploadController : ControllerBase
    {
        private readonly DatabaseHelper _dbHelper;

        public ImageUploadController(DatabaseHelper dbHelper)
        {
            _dbHelper = dbHelper;
        }

        /// <summary>
        /// Upload an image/PDF into cotGenAttch with a client-supplied key.
        /// attFilKy MUST come from the client (e.g., "John_Doe_971501234567").
        /// We sanitize to allow only [A-Za-z0-9 _ . - @ +] and trim to 50 chars.
        /// If attFilKy already exists, we UPDATE the row; else we INSERT.
        /// </summary>
        [HttpPost("upload")]
        [DisableRequestSizeLimit]
        [RequestFormLimits(MultipartBodyLengthLimit = 50_000_000)]
        [Consumes("multipart/form-data")]
        public IActionResult Upload(
            [FromForm] IFormFile file,
            [FromQuery] string? attFilKy = null,          // Prefer query
            [FromQuery] string? attFilTy = "01",
            [FromQuery] string? createId = "SYSTEM")
        {
            // Fallback: allow attFilKy via form if not present in query
            if (string.IsNullOrWhiteSpace(attFilKy) && Request?.Form?.ContainsKey("attFilKy") == true)
            {
                attFilKy = Request.Form["attFilKy"].ToString();
            }

            // --- Basic checks ---
            if (file == null || file.Length == 0)
                return BadRequest("No file uploaded.");

            if (!IsValidFile(file, out var reason))
                return BadRequest(reason);

            // --- attFilKy is REQUIRED and must come from Flutter (name+mobile) ---
            attFilKy = SanitizeKey(attFilKy);
            if (string.IsNullOrWhiteSpace(attFilKy))
                return BadRequest("attFilKy is required (e.g., Name_MobileNumber) and must contain valid characters.");

            try
            {
                // Derive metadata
                var ext = Path.GetExtension(file.FileName).ToLowerInvariant(); // ".jpg" / ".pdf"
                var baseName = Path.GetFileNameWithoutExtension(file.FileName);

                // Read file bytes
                byte[] bytes;
                using (var ms = new MemoryStream())
                {
                    file.CopyTo(ms);
                    bytes = ms.ToArray();
                }

                var fileSizeDecimal = Convert.ToDecimal(file.Length);

                // Common parameters
                var parameters = new Dictionary<string, object>
                {
                    ["@attFilKy"] = attFilKy,
                    ["@attFilTy"] = string.IsNullOrWhiteSpace(attFilTy) ? "01" : attFilTy,
                    ["@fileName"] = baseName,
                    ["@attachFl"] = bytes,
                    ["@fileExtn"] = ext.TrimStart('.'),
                    ["@fileSize"] = fileSizeDecimal,
                    ["@createId"] = string.IsNullOrWhiteSpace(createId) ? "SYSTEM" : createId
                };

                // Try UPDATE first (upsert pattern without needing a scalar count)
                var sqlUpdate = @"
UPDATE cotGenAttch
   SET attFilTy = @attFilTy,
       fileName = @fileName,
       attachFl = @attachFl,
       fileExtn = @fileExtn,
       fileSize = @fileSize,
       statFlag = 'A',
       updateId = @createId,
       updateDt = GETDATE()
 WHERE attFilKy = @attFilKy";

                var rows = _dbHelper.WebExecute(sqlUpdate, parameters);

                bool updated = rows > 0;
                if (!updated)
                {
                    // Do INSERT if no existing row
                    var sqlInsert = @"
INSERT INTO cotGenAttch
(attFilKy, attFilTy, fileName, attachFl, fileExtn, fileSize, statFlag, createId, createDt)
VALUES
(@attFilKy, @attFilTy, @fileName, @attachFl, @fileExtn, @fileSize, 'A', @createId, GETDATE())";

                    rows = _dbHelper.WebExecute(sqlInsert, parameters);
                }

                if (rows > 0)
                {
                    return Ok(new
                    {
                        msg = "File uploaded successfully",
                        data = new
                        {
                            attFilKy,
                            fileName = file.FileName,
                            fileExtn = ext.TrimStart('.'),
                            fileSizeBytes = file.Length,
                            createId,
                            upsertMode = (updated ? "updated" : "inserted")
                        }
                    });
                }

                return StatusCode(500, "Failed to save file to database.");
            }
            catch (Exception ex)
            {
                try { _dbHelper.InsertIntoLog("SYSTEM", "/api/ImageUpload/upload", ex.ToString(), 500, null); } catch { }
                return StatusCode(500, $"Internal server error: {ex.Message}");
            }
        }

        // --- Validation helper ---
        private bool IsValidFile(IFormFile file, out string reason)
        {
            reason = string.Empty;
            var allowedExts = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp", ".pdf" };
            var ext = Path.GetExtension(file.FileName).ToLowerInvariant();
            var ct = (file.ContentType ?? string.Empty).ToLowerInvariant();

            if (!allowedExts.Contains(ext))
            {
                reason = "Invalid file extension. Allowed: jpg, jpeg, png, gif, bmp, webp, pdf.";
                return false;
            }

            if (!(ct.StartsWith("image/") || ct == "application/pdf" || ct == "" || ct == "application/octet-stream"))
            {
                reason = "Invalid content type. Only images or PDFs are allowed.";
                return false;
            }

            if (file.Length > 50_000_000)
            {
                reason = "File too large. Max 50 MB.";
                return false;
            }

            return true;
        }

        /// <summary>
        /// Keep only safe characters and length for attFilKy.
        /// Allowed: letters, digits, space, underscore, hyphen, dot, at, plus
        /// Trim to max length 50 as per your column constraint.
        /// </summary>
        private static string SanitizeKey(string? raw)
        {
            if (string.IsNullOrWhiteSpace(raw)) return string.Empty;

            // Normalize spaces
            raw = raw.Trim();

            // Allow only these chars: A-Z a-z 0-9 _ - . @ + and space
            var cleaned = Regex.Replace(raw, @"[^A-Za-z0-9_\-\.@+\s]", string.Empty);

            // Collapse multiple spaces to single underscore
            cleaned = Regex.Replace(cleaned, @"\s+", "_");

            // Enforce max length 50
            if (cleaned.Length > 50) cleaned = cleaned.Substring(0, 50);

            return cleaned;
        }
    }
}
