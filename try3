using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

namespace sparshWebService.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Produces("application/json")]
    public sealed class ActivityEntryController : ControllerBase
    {
        private readonly DatabaseHelper _db;

        public ActivityEntryController(DatabaseHelper db)
        {
            _db = db;
        }

        // Quick ping to test routing
        [HttpGet("ping")]
        public IActionResult Ping()
        {
            return Ok(new { success = true, controller = "ActivityEntry", message = "Ping OK" });
        }

        // =========================
        // POST: /api/ActivityEntry/save
        // =========================
        [HttpPost("save")]
        [Consumes("application/json")]
        public IActionResult Save([FromBody] ActivityEntryRequest? request = null)
        {
            try
            {
                request ??= new ActivityEntryRequest();

                // -------- basic validations --------
                if (string.IsNullOrWhiteSpace(request.ProcessType))
                    return BadRequest(new { success = false, message = "ProcessType is required (Add / Update)." });

                var mode = request.ProcessType.Trim().ToUpperInvariant();
                bool isAdd = mode == "ADD";

                if (!isAdd && string.IsNullOrWhiteSpace(request.DocuNumb))
                    return BadRequest(new { success = false, message = "DocuNumb is required in Update mode." });

                if (string.IsNullOrWhiteSpace(request.ActivityName))
                    return BadRequest(new { success = false, message = "ActivityName is required." });

                if (string.IsNullOrWhiteSpace(request.ActivityDate))
                    return BadRequest(new { success = false, message = "ActivityDate is required." });

                if (string.IsNullOrWhiteSpace(request.MeetingVenue))
                    return BadRequest(new { success = false, message = "MeetingVenue is required." });

                if (string.IsNullOrWhiteSpace(request.CityName))
                    return BadRequest(new { success = false, message = "CityName is required." });

                if (string.IsNullOrWhiteSpace(request.District))
                    return BadRequest(new { success = false, message = "District (Emirates) is required." });

                if (string.IsNullOrWhiteSpace(request.LoginIdn))
                    return BadRequest(new { success = false, message = "LoginIdn (createId) is required." });

                // -------- map Flutter â†’ header fields --------
                var actvName = Cut(request.ActivityName, 100);    // actvName
                var actvRmrk = Cut(request.Description, 500);      // actvRmrk
                var actvDate = SafeParseDate(request.ActivityDate) ?? DateTime.Now;
                var meetDate = actvDate;

                var docuMnth = actvDate.ToString("yyyyMM", CultureInfo.InvariantCulture);

                var actvCity = Cut(request.CityName, 100);
                var district = Cut(request.District, 50);   // Emirates

                // derive areaCode from Emirates (first 3 chars)
                var areaCode = (Left(district, 3) ?? "UAE").ToUpperInvariant();

                var prodCtLs = Cut(request.Product, 100);    // Product list
                var meetVenu = Cut(request.MeetingVenue, 200);

                var loginIdn = request.LoginIdn!.Trim();
                var userRole = Cut(request.UserRole, 10);

                // counts
                int emplCont = request.Employees?.Count ?? 0;
                int inflCont = request.Painters?.Count ?? 0;
                int chnlCont = request.ChannelPartners?.Count ?? 0;
                int totlCont = emplCont + inflCont + chnlCont;

                int noOfPart = request.TotalParticipants ?? totlCont;
                int noOfEnqu = 0;
                int noOfVist = 0;

                // lat/long
                var latitude = Cut(request.Latitude, 50);
                var longtude = Cut(request.Longitude, 50);

                // image attachment id list (comma separated)
                string? atchNmId = null;
                if (request.ImageIds != null && request.ImageIds.Any())
                    atchNmId = string.Join(",", request.ImageIds.Where(x => !string.IsNullOrWhiteSpace(x)).Select(x => x!.Trim()));

                // simple defaults
                string docuNumb = request.DocuNumb?.Trim() ?? "";
                string caaActTy = "M";  // Meeting (code assumption)
                string caaObjTy = "";   // Not coming from UI currently
                string pinCodeN = "";
                string caaPrjTy = "";   // Not used
                string mobileNo = "";   // contact mobile if needed
                string emailAdd = "";
                string contPers = "";
                int potnInMT = 0;
                string maturtMn = "";
                string rejcRmrk = "";
                string statFlag = "N";

                // compressed employees list for header
                string empPrsLs = "";
                if (request.Employees != null && request.Employees.Any())
                {
                    empPrsLs = string.Join(",",
                        request.Employees
                            .Where(e => !string.IsNullOrWhiteSpace(e.Name))
                            .Select(e => Cut(e.Name, 50)));
                }

                // -------- ADD MODE: generate docuNumb via wcpDocNoGen --------
                if (isAdd)
                {
                    // ðŸ”¹ CALL PROC WITH ONLY @docuType and @areaCode
                    const string docSql = @"
EXEC dbo.wcpDocNoGen 
    @docuType = @docuType, 
    @areaCode = @areaCode;";

                    var docParams = new Dictionary<string, object?>
                    {
                        ["@docuType"] = "ACTPRESL",
                        ["@areaCode"] = areaCode
                    };

                    var docResult = _db.QaEWebBean(docSql, docParams);
                    var docRow = docResult?.FirstOrDefault();

                    // Assume proc returns a column named 'docuNumb'
                    docuNumb = docRow?["docuNumb"]?.ToString()?.Trim() ?? "";

                    if (string.IsNullOrWhiteSpace(docuNumb))
                        return BadRequest(new { success = false, message = "Document number generation failed." });
                }

                // -------- INSERT / UPDATE HEADER (catActPreSl) --------
                if (isAdd)
                {
                    const string insertSql = @"
INSERT INTO dbo.catActPreSl
(
    docuNumb, docuMnth, actvDate, meetDate, actvName,
    caaActTy, caaObjTy, actvCity, district, pinCodeN,
    noOfPart, noOfEnqu, noOfVist,
    prodCtLs, empPrsLs, actvRmrk, meetVenu,
    caaPrjTy, mobileNo, emailAdd, contPers, potnInMT,
    maturtMn, rejcRmrk, statFlag, createId, createDt,
    latitude, longtude, atchNmId,
    areaCode, userRole, emplCont, chnlCont, inflCont, totlCont
)
VALUES
(
    @docuNumb, @docuMnth, @actvDate, @meetDate, @actvName,
    @caaActTy, @caaObjTy, @actvCity, @district, @pinCodeN,
    @noOfPart, @noOfEnqu, @noOfVist,
    @prodCtLs, @empPrsLs, @actvRmrk, @meetVenu,
    @caaPrjTy, @mobileNo, @emailAdd, @contPers, @potnInMT,
    @maturtMn, @rejcRmrk, @statFlag, @createId, GETDATE(),
    @latitude, @longtude, @atchNmId,
    @areaCode, @userRole, @emplCont, @chnlCont, @inflCont, @totlCont
);

SELECT @docuNumb AS docuNumb;";

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@docuMnth"] = docuMnth,
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = actvName,
                        ["@caaActTy"] = caaActTy,
                        ["@caaObjTy"] = caaObjTy,
                        ["@actvCity"] = actvCity,
                        ["@district"] = district,
                        ["@pinCodeN"] = pinCodeN,
                        ["@noOfPart"] = noOfPart,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@caaPrjTy"] = caaPrjTy,
                        ["@mobileNo"] = mobileNo,
                        ["@emailAdd"] = emailAdd,
                        ["@contPers"] = contPers,
                        ["@potnInMT"] = potnInMT,
                        ["@maturtMn"] = maturtMn,
                        ["@rejcRmrk"] = rejcRmrk,
                        ["@statFlag"] = statFlag,
                        ["@createId"] = loginIdn,
                        ["@latitude"] = (object?)latitude ?? DBNull.Value,
                        ["@longtude"] = (object?)longtude ?? DBNull.Value,
                        ["@atchNmId"] = string.IsNullOrEmpty(atchNmId) ? DBNull.Value : atchNmId,
                        ["@areaCode"] = areaCode,
                        ["@userRole"] = (object?)userRole ?? DBNull.Value,
                        ["@emplCont"] = emplCont,
                        ["@chnlCont"] = chnlCont,
                        ["@inflCont"] = inflCont,
                        ["@totlCont"] = totlCont
                    };

                    _db.QaEWebBean(insertSql, p);
                }
                else
                {
                    // UPDATE HEADER
                    const string updateSql = @"
UPDATE dbo.catActPreSl
SET
    actvDate = @actvDate,
    meetDate = @meetDate,
    actvName = @actvName,
    actvCity = @actvCity,
    district = @district,
    noOfPart = @noOfPart,
    noOfEnqu = @noOfEnqu,
    noOfVist = @noOfVist,
    prodCtLs = @prodCtLs,
    empPrsLs = @empPrsLs,
    actvRmrk = @actvRmrk,
    meetVenu = @meetVenu,
    latitude = @latitude,
    longtude = @longtude,
    atchNmId = @atchNmId,
    areaCode = @areaCode,
    userRole = @userRole,
    emplCont = @emplCont,
    chnlCont = @chnlCont,
    inflCont = @inflCont,
    totlCont = @totlCont,
    updateId = @updateId,
    updateDt = GETDATE()
WHERE docuNumb = @docuNumb;";

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = actvName,
                        ["@actvCity"] = actvCity,
                        ["@district"] = district,
                        ["@noOfPart"] = noOfPart,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@latitude"] = (object?)latitude ?? DBNull.Value,
                        ["@longtude"] = (object?)longtude ?? DBNull.Value,
                        ["@atchNmId"] = string.IsNullOrEmpty(atchNmId) ? DBNull.Value : atchNmId,
                        ["@areaCode"] = areaCode,
                        ["@userRole"] = (object?)userRole ?? DBNull.Value,
                        ["@emplCont"] = emplCont,
                        ["@chnlCont"] = chnlCont,
                        ["@inflCont"] = inflCont,
                        ["@totlCont"] = totlCont,
                        ["@updateId"] = loginIdn
                    };

                    _db.QaEWebBean(updateSql, p);

                    // Clear old detail rows
                    const string deleteDtl = @"DELETE FROM dbo.catActPreSlDtl WHERE docuNumb = @docuNumb;";
                    _db.QaEWebBean(deleteDtl, new Dictionary<string, object?> { ["@docuNumb"] = docuNumb });
                }

                // -------- INSERT DETAIL ROWS (catActPreSlDtl) --------
                InsertDetails(docuNumb, loginIdn, request);

                return Ok(new
                {
                    success = true,
                    message = isAdd ? "Activity saved successfully." : "Activity updated successfully.",
                    docuNumb,
                    timestamp = DateTime.Now
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new
                {
                    success = false,
                    message = "Error while saving activity.",
                    error = ex.Message,
                    timestamp = DateTime.Now
                });
            }
        }

        // =========================
        // Detail insert helper
        // =========================
        private void InsertDetails(string docuNumb, string loginIdn, ActivityEntryRequest request)
        {
            const string insertDtlSql = @"
INSERT INTO dbo.catActPreSlDtl
(
    docuNumb, attnType, attnCode,
    statFlag, createId, createDt
)
VALUES
(
    @docuNumb, @attnType, @attnCode,
    'N', @createId, GETDATE()
);";

            // Employees -> attnType 'E'
            if (request.Employees != null)
            {
                foreach (var emp in request.Employees)
                {
                    var code = string.IsNullOrWhiteSpace(emp.EmployeeCode)
                        ? Cut(emp.Name, 50)
                        : Cut(emp.EmployeeCode, 50);

                    if (string.IsNullOrWhiteSpace(code)) continue;

                    var parms = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@attnType"] = "E",
                        ["@attnCode"] = code,
                        ["@createId"] = loginIdn
                    };
                    _db.QaEWebBean(insertDtlSql, parms);
                }
            }

            // Painters / Contractors / Applicators -> attnType 'I'
            if (request.Painters != null)
            {
                foreach (var pnt in request.Painters)
                {
                    var code = !string.IsNullOrWhiteSpace(pnt.Mobile)
                        ? Cut(pnt.Mobile, 50)
                        : Cut(pnt.Name, 50);

                    if (string.IsNullOrWhiteSpace(code)) continue;

                    var parms = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@attnType"] = "I",
                        ["@attnCode"] = code,
                        ["@createId"] = loginIdn
                    };
                    _db.QaEWebBean(insertDtlSql, parms);
                }
            }

            // Channel Partners -> attnType 'C'
            if (request.ChannelPartners != null)
            {
                foreach (var ch in request.ChannelPartners)
                {
                    var code = !string.IsNullOrWhiteSpace(ch.PurchaserCode)
                        ? Cut(ch.PurchaserCode, 50)
                        : Cut(ch.Name, 50);

                    if (string.IsNullOrWhiteSpace(code)) continue;

                    var parms = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@attnType"] = "C",
                        ["@attnCode"] = code,
                        ["@createId"] = loginIdn
                    };
                    _db.QaEWebBean(insertDtlSql, parms);
                }
            }
        }

        // =========================
        // Helper functions
        // =========================
        private static string Cut(string? s, int max)
        {
            if (string.IsNullOrWhiteSpace(s)) return "";
            var t = s.Trim();
            return t.Length <= max ? t : t.Substring(0, max);
        }

        private static string? Left(string? s, int n)
        {
            if (string.IsNullOrWhiteSpace(s)) return null;
            var t = s.Trim();
            return t.Length <= n ? t : t.Substring(0, n);
        }

        private static DateTime? SafeParseDate(string? dateString)
        {
            if (string.IsNullOrWhiteSpace(dateString)) return null;
            var formats = new[]
            {
                "yyyy-MM-dd","MM/dd/yyyy","dd/MM/yyyy","yyyy/MM/dd",
                "MM-dd-yyyy","dd-MM-yyyy","yyyyMMdd","ddMMyyyy"
            };
            foreach (var f in formats)
            {
                if (DateTime.TryParseExact(dateString, f, CultureInfo.InvariantCulture,
                    DateTimeStyles.None, out var dt))
                    return dt;
            }
            if (DateTime.TryParse(dateString, out var any)) return any;
            return null;
        }
    }

    // =========================
    // DTOs (within same file)
    // =========================
    public sealed class ActivityEntryRequest
    {
        public string? ProcessType { get; set; }      // Add / Update
        public string? DocuNumb { get; set; }         // For Update

        public string? ActivityName { get; set; }
        public string? Description { get; set; }
        public string? ActivityDate { get; set; }
        public string? MeetingVenue { get; set; }
        public string? CityName { get; set; }
        public string? District { get; set; }         // Emirates
        public string? Product { get; set; }

        public int? NoOfEmployees { get; set; }       // optional (we also compute from list)
        public int? TotalParticipants { get; set; }

        public string? Latitude { get; set; }
        public string? Longitude { get; set; }

        public string? LoginIdn { get; set; }
        public string? UserRole { get; set; }

        public List<ActivityEmployeeDto>? Employees { get; set; }
        public List<ActivityPainterDto>? Painters { get; set; }
        public List<ActivityChannelPartnerDto>? ChannelPartners { get; set; }

        public List<string>? ImageIds { get; set; }
    }

    public sealed class ActivityEmployeeDto
    {
        public string? EmployeeCode { get; set; }
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityPainterDto
    {
        public string? Type { get; set; }     // Painter / Contractor / Applicator
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityChannelPartnerDto
    {
        public string? Type { get; set; }           // Authorised dealer, Retailer, etc.
        public string? PurchaserCode { get; set; }  // Purchaser Code
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }
}
