@page
@model ItadminPortal.Pages.Assets.ModifyModel

@await Html.PartialAsync("_Header")

<!-- Ensure jQuery loads first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-5">
    <h2 class="text-center mb-4 fw-bold">üõ†Ô∏è Asset Modification</h2>

    <div class="card shadow p-4 rounded-4">
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success">@Model.SuccessMessage</div>
        }

        <form method="post">
            <div class="mb-3">
                <label class="form-label">Select Asset to Modify</label>
                <select id="assetSelect" class="form-select" onchange="loadAsset(this.value)">
                    <option value="">-- Choose Asset --</option>
                    @foreach (var asset in Model.Assets)
                    {
                        <option value="@asset["AssetID"]" @(Model.Input.AssetId == (int)asset["AssetID"] ? "selected" : "")>@asset["AssetName"] (@asset["SerialNo"])</option>
                    }
                </select>
            </div>

            @if (Model.SelectedAsset.Count > 0)
            {
                <input type="hidden" asp-for="Input.AssetId" />

                <div class="mb-3">
                    <label asp-for="Input.AssetName" class="form-label">Asset Name</label>
                    <input asp-for="Input.AssetName" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label asp-for="Input.AssetType" class="form-label">Asset Type</label>
                    <input asp-for="Input.AssetType" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label asp-for="Input.SerialNo" class="form-label">Serial Number</label>
                    <input asp-for="Input.SerialNo" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label asp-for="Input.PurchaseDate" class="form-label">Purchase Date</label>
                    <input asp-for="Input.PurchaseDate" type="date" class="form-control" />
                </div>

                <div class="mb-3">
                    <label asp-for="Input.WarrantyExpiry" class="form-label">Warranty Expiry</label>
                    <input asp-for="Input.WarrantyExpiry" type="date" class="form-control" />
                </div>

                <div class="mb-3">
                    <label asp-for="Input.Status" class="form-label">Status</label>
                    <select asp-for="Input.Status" class="form-select" required>
                        <option value="In Use">In Use</option>
                        <option value="Spare">Spare</option>
                        <option value="Ready for Discard">Ready for Discard</option>
                        <!-- Add more statuses as needed -->
                    </select>
                </div>

                <div class="mb-3 position-relative">
                    <label asp-for="Input.AssignedTo" class="form-label">Assigned To (Optional)</label>
                    <input id="employeeSearch" type="text" class="form-control" placeholder="Type employee name or login ID..." autocomplete="off" value="@(Model.Input.AssignedTo != "" ? Model.Input.AssignedTo : "")" />
                    <input type="hidden" asp-for="Input.AssignedTo" />
                    <div id="searchResults" class="list-group mt-1"></div>
                </div>

                <button type="submit" class="btn btn-warning w-100">Update Asset</button>
            }
        </form>
    </div>
</div>

<style>
    .btn-warning {
        border-radius: 10px;
    }

    #searchResults {
        position: absolute;
        z-index: 1000;
        width: 100%;
    }
</style>

<script>
    $(document).ready(function () {
        $('#employeeSearch').keyup(function () {
            var query = $(this).val();
            if (query.length > 1) {
                $.ajax({
                    url: '/api/employee/search',
                    type: 'GET',
                    data: { q: query },
                    success: function (data) {
                        $('#searchResults').empty();
                        if (data.length > 0) {
                            data.forEach(emp => {
                                $('#searchResults').append('<button type="button" class="list-group-item list-group-item-action" onclick="selectEmployee(\'' + emp.loginIdn + '\', \'' + emp.emplName + ' (' + emp.loginIdn + ')\')">' + emp.emplName + ' (' + emp.loginIdn + ')</button>');
                            });
                        } else {
                            $('#searchResults').append('<div class="list-group-item">No employees found</div>');
                        }
                    },
                    error: function () {
                        $('#searchResults').html('<div class="list-group-item text-danger">Error fetching results</div>');
                    }
                });
            } else {
                $('#searchResults').empty();
            }
        });
    });

    function selectEmployee(loginIdn, text) {
        $('#employeeSearch').val(text);
        $('input[name="Input.NewAssignedTo"]').val(loginIdn);
        $('#searchResults').empty();
    }

    function loadAsset(id) {
        if (id) {
            window.location.href = '?id=' + id;
        }
    }
</script>

@await Html.PartialAsync("_Footer")
















using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using AdminPortal.DataAccess;
using System.Collections.Generic;
using System;
using System.ComponentModel.DataAnnotations;

namespace ItadminPortal.Pages.Assets
{
    public class ModifyModel : PageModel
    {
        private readonly DatabaseHelper _db;

        public ModifyModel(DatabaseHelper db)
        {
            _db = db;
        }

        public List<Dictionary<string, object>> Assets { get; set; } = new List<Dictionary<string, object>>();

        [BindProperty]
        public ModifyInput Input { get; set; } = new ModifyInput();

        public string SuccessMessage { get; set; } = string.Empty;

        public void OnGet(int? id)
        {
            LoadAssets();
            if (id.HasValue)
            {
                SelectedAsset = LoadAssetById(id.Value);
                if (SelectedAsset.Count > 0)
                {
                    Input.AssetId = (int)SelectedAsset["AssetID"];
                    Input.AssetName = (string)SelectedAsset["AssetName"];
                    Input.AssetType = (string)SelectedAsset["AssetType"];
                    Input.SerialNo = (string)SelectedAsset["SerialNo"];
                    Input.PurchaseDate = SelectedAsset["PurchaseDate"] as DateTime?;
                    Input.WarrantyExpiry = SelectedAsset["WarrantyExpiry"] as DateTime?;
                    Input.Status = (string)SelectedAsset["Status"];
                    Input.AssignedTo = SelectedAsset["AssignedTo"] as string ?? "";
                }
            }
        }

        public IActionResult OnPost()
        {
            if (!ModelState.IsValid)
            {
                LoadAssets();
                return Page();
            }

            try
            {
                var query = "UPDATE Assets SET AssetName = @AssetName, AssetType = @AssetType, SerialNo = @SerialNo, PurchaseDate = @PurchaseDate, WarrantyExpiry = @WarrantyExpiry, Status = @Status";
                var parameters = new Dictionary<string, object>
                {
                    { "@AssetName", Input.AssetName },
                    { "@AssetType", Input.AssetType },
                    { "@SerialNo", Input.SerialNo },
                    { "@PurchaseDate", Input.PurchaseDate ?? (object)DBNull.Value },
                    { "@WarrantyExpiry", Input.WarrantyExpiry ?? (object)DBNull.Value },
                    { "@Status", Input.Status },
                    { "@AssetId", Input.AssetId }
                };

                if (!string.IsNullOrEmpty(Input.AssignedTo))
                {
                    query += ", AssignedTo = @AssignedTo";
                    parameters.Add("@AssignedTo", Input.AssignedTo);
                }
                else if (Input.Status != "In Use")
                {
                    query += ", AssignedTo = NULL";
                }

                query += " WHERE AssetID = @AssetId";

                var rowsAffected = _db.SessBeanExecute(query, parameters);

                if (rowsAffected > 0)
                {
                    SuccessMessage = "‚úÖ Asset updated successfully!";
                    Input = new ModifyInput();
                }
                else
                {
                    ModelState.AddModelError("", "Failed to update asset. It may have been deleted or modified.");
                }
            }
            catch (Exception ex)
            {
                ModelState.AddModelError("", $"An error occurred: {ex.Message}");
            }

            LoadAssets();
            return Page();
        }

        private void LoadAssets()
        {
            string query = "SELECT AssetID, AssetName, AssetType, SerialNo, PurchaseDate, WarrantyExpiry, Status, AssignedTo FROM Assets";
            Assets = _db.SessBean(query, new Dictionary<string, object>());
        }

        public Dictionary<string, object> SelectedAsset { get; set; } = new Dictionary<string, object>();

        private Dictionary<string, object> LoadAssetById(int id)
        {
            string query = "SELECT AssetID, AssetName, AssetType, SerialNo, PurchaseDate, WarrantyExpiry, Status, AssignedTo FROM Assets WHERE AssetID = @id";
            var parameters = new Dictionary<string, object> { { "@id", id } };
            var results = _db.SessBean(query, parameters);
            return results.FirstOrDefault() ?? new Dictionary<string, object>();
        }
    }

    public class ModifyInput
    {
        public int AssetId { get; set; }

        [Required(ErrorMessage = "Asset Name is required")]
        [StringLength(100, ErrorMessage = "Asset Name cannot exceed 100 characters")]
        public string AssetName { get; set; } = "";

        [Required(ErrorMessage = "Asset Type is required")]
        [StringLength(50, ErrorMessage = "Asset Type cannot exceed 50 characters")]
        public string AssetType { get; set; } = "";

        [Required(ErrorMessage = "Serial Number is required")]
        [StringLength(50, ErrorMessage = "Serial Number cannot exceed 50 characters")]
        public string SerialNo { get; set; } = "";

        [DataType(DataType.Date)]
        public DateTime? PurchaseDate { get; set; }

        [DataType(DataType.Date)]
        public DateTime? WarrantyExpiry { get; set; }

        [Required(ErrorMessage = "Status is required")]
        public string Status { get; set; } = "";

        [StringLength(50, ErrorMessage = "Assigned To cannot exceed 50 characters")]
        public string AssignedTo { get; set; } = "";
    }
}
