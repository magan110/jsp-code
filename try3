using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

namespace sparshWebService.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Produces("application/json")]
    public sealed class ActivityEntryController : ControllerBase
    {
        private readonly DatabaseHelper _db;

        public ActivityEntryController(DatabaseHelper db)
        {
            _db = db;
        }

        // Simple ping to verify routing
        [HttpGet("ping")]
        public IActionResult Ping()
        {
            return Ok(new { success = true, controller = "ActivityEntry", message = "Ping OK" });
        }

        // ======================================
        // POST: /api/ActivityEntry/save
        // ======================================
        [HttpPost("save")]
        [Consumes("application/json")]
        public IActionResult Save([FromBody] ActivityEntryRequest? request = null)
        {
            try
            {
                request ??= new ActivityEntryRequest();

                // ---------- BASIC VALIDATIONS ----------
                if (string.IsNullOrWhiteSpace(request.ProcessType))
                    return BadRequest(new { success = false, message = "ProcessType is required (Add / Update)." });

                var mode = request.ProcessType.Trim().ToUpperInvariant();
                bool isAdd = mode == "ADD";

                if (!isAdd && string.IsNullOrWhiteSpace(request.DocuNumb))
                    return BadRequest(new { success = false, message = "DocuNumb is required in Update mode." });

                if (string.IsNullOrWhiteSpace(request.ActivityName))
                    return BadRequest(new { success = false, message = "ActivityName is required." });

                if (string.IsNullOrWhiteSpace(request.ActivityDate))
                    return BadRequest(new { success = false, message = "ActivityDate is required." });

                if (string.IsNullOrWhiteSpace(request.MeetingVenue))
                    return BadRequest(new { success = false, message = "MeetingVenue is required." });

                if (string.IsNullOrWhiteSpace(request.CityName))
                    return BadRequest(new { success = false, message = "CityName is required." });

                if (string.IsNullOrWhiteSpace(request.District))
                    return BadRequest(new { success = false, message = "District (Emirates) is required." });

                if (string.IsNullOrWhiteSpace(request.LoginIdn))
                    return BadRequest(new { success = false, message = "LoginIdn (createId) is required." });

                // ---------- MAP FLUTTER → HEADER FIELDS ----------
                var actvName = Cut(request.ActivityName, 100);      // actvName varchar(100)
                var actvRmrk = Cut(request.Description, 200);       // actvRmrk varchar(200)
                var actvDate = SafeParseDate(request.ActivityDate) ?? DateTime.Now;
                var meetDate = actvDate;

                var docuMnth = actvDate.ToString("yyyyMM", CultureInfo.InvariantCulture); // char(6)

                var actvCity = Cut(request.CityName, 40);           // actvCity varchar(40)
                var district = Cut(request.District, 30);           // district varchar(30)

                // areaCode varchar(3) from Emirates
                var areaCode = (Left(district, 3) ?? "UAE").ToUpperInvariant();
                areaCode = Cut(areaCode, 3);

                var prodCtLs = Cut(request.Product, 50);            // prodCtLs varchar(50)
                var meetVenu = Cut(request.MeetingVenue, 50);       // meetVenu varchar(50)

                var loginIdn = Cut(request.LoginIdn!.Trim(), 10);   // createId varchar(10)
                var userRole = Cut(request.UserRole, 1);            // userRole char(1)

                // counts
                int emplContInt = request.Employees?.Count ?? 0;
                int inflContInt = request.Painters?.Count ?? 0;
                int chnlContInt = request.ChannelPartners?.Count ?? 0;
                int totlContInt = emplContInt + inflContInt + chnlContInt;

                // stored in DB as char(4)
                string emplCont = Cut(emplContInt.ToString(CultureInfo.InvariantCulture), 4);
                string inflCont = Cut(inflContInt.ToString(CultureInfo.InvariantCulture), 4);
                string chnlCont = Cut(chnlContInt.ToString(CultureInfo.InvariantCulture), 4);
                string totlCont = Cut(totlContInt.ToString(CultureInfo.InvariantCulture), 4);

                int noOfPart = request.TotalParticipants ?? totlContInt;  // smallint
                int noOfEnqu = 0;
                int noOfVist = 0;

                // lat/long: both 50 chars
                var latitude = Cut(request.Latitude, 50);
                var longtude = Cut(request.Longitude, 50);

                // images -> atchNmId varchar(500)
                string? atchNmId = null;
                if (request.ImageIds != null && request.ImageIds.Any())
                {
                    var joined = string.Join(",",
                        request.ImageIds.Where(x => !string.IsNullOrWhiteSpace(x)).Select(x => x!.Trim()));
                    atchNmId = Cut(joined, 500);
                }

                // simple defaults for required NOT NULL cols
                string docuNumb = Cut(request.DocuNumb?.Trim() ?? "", 16); // char(16)
                string caaActTy = "M";     // Meeting, char(2)
                string caaObjTy = "";      // char(2)
                caaActTy = Cut(caaActTy, 2);
                caaObjTy = Cut(caaObjTy, 2);

                string pinCodeN = "";      // varchar(6)
                pinCodeN = Cut(pinCodeN, 6);

                string caaPrjTy = "";      // char(2)
                caaPrjTy = Cut(caaPrjTy, 2);

                string mobileNo = "";      // varchar(11)
                mobileNo = Cut(mobileNo, 11);

                string emailAdd = "";      // varchar(40)
                emailAdd = Cut(emailAdd, 40);

                string contPers = "";      // varchar(40)
                contPers = Cut(contPers, 40);

                int potnInMT = 0;          // smallint
                string maturtMn = "";      // char(6)
                maturtMn = Cut(maturtMn, 6);

                string rejcRmrk = "";      // varchar(100)
                rejcRmrk = Cut(rejcRmrk, 100);

                string statFlag = "N";     // char(1)
                statFlag = Cut(statFlag, 1);

                // compressed employees list for header (empPrsLs varchar(100))
                string empPrsLs = "";
                if (request.Employees != null && request.Employees.Any())
                {
                    var raw = string.Join(",",
                        request.Employees
                            .Where(e => !string.IsNullOrWhiteSpace(e.Name))
                            .Select(e => Cut(e.Name, 30)));  // each name ≤ 30
                    empPrsLs = Cut(raw, 100);
                }

                // ---------- ADD MODE: GET DOCUNUMB FROM wcpDocNoGen ----------
                if (isAdd)
                {
                    const string docSql = @"
EXEC dbo.wcpDocNoGen 
    @docuType = @docuType, 
    @areaCode = @areaCode;";

                    var docParams = new Dictionary<string, object?>
                    {
                        ["@docuType"] = "ACTPRESL",
                        ["@areaCode"] = areaCode
                    };

                    var docResult = _db.QaEWebBean(docSql, docParams);
                    var docRow = docResult?.FirstOrDefault();

                    // Adjust column name if your proc returns something else (docNo, docNumber, etc.)
                    docuNumb = Cut(docRow?["docuNumb"]?.ToString()?.Trim() ?? "", 16);

                    if (string.IsNullOrWhiteSpace(docuNumb))
                        return BadRequest(new { success = false, message = "Document number generation failed." });
                }

                // ---------- INSERT / UPDATE HEADER (catActPreSl) ----------
                if (isAdd)
                {
                    const string insertSql = @"
INSERT INTO dbo.catActPreSl
(
    docuNumb, docuMnth, actvDate, meetDate, actvName,
    caaActTy, caaObjTy, actvCity, district, pinCodeN,
    noOfPart, noOfEnqu, noOfVist,
    prodCtLs, empPrsLs, actvRmrk, meetVenu,
    caaPrjTy, mobileNo, emailAdd, contPers, potnInMT,
    maturtMn, rejcRmrk, statFlag, createId, createDt,
    latitute, lgtitute, atchNmId,
    areaCode, userRole, emplCont, chnlCont, inflCont, totlCont
)
VALUES
(
    @docuNumb, @docuMnth, @actvDate, @meetDate, @actvName,
    @caaActTy, @caaObjTy, @actvCity, @district, @pinCodeN,
    @noOfPart, @noOfEnqu, @noOfVist,
    @prodCtLs, @empPrsLs, @actvRmrk, @meetVenu,
    @caaPrjTy, @mobileNo, @emailAdd, @contPers, @potnInMT,
    @maturtMn, @rejcRmrk, @statFlag, @createId, GETDATE(),
    @latitute, @lgtitute, @atchNmId,
    @areaCode, @userRole, @emplCont, @chnlCont, @inflCont, @totlCont
);

SELECT @docuNumb AS docuNumb;";

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@docuMnth"] = docuMnth,
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = actvName,
                        ["@caaActTy"] = caaActTy,
                        ["@caaObjTy"] = caaObjTy,
                        ["@actvCity"] = actvCity,
                        ["@district"] = district,
                        ["@pinCodeN"] = pinCodeN,
                        ["@noOfPart"] = noOfPart,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@caaPrjTy"] = caaPrjTy,
                        ["@mobileNo"] = mobileNo,
                        ["@emailAdd"] = emailAdd,
                        ["@contPers"] = contPers,
                        ["@potnInMT"] = potnInMT,
                        ["@maturtMn"] = maturtMn,
                        ["@rejcRmrk"] = rejcRmrk,
                        ["@statFlag"] = statFlag,
                        ["@createId"] = loginIdn,
                        ["@latitute"] = (object?)latitude ?? DBNull.Value,
                        ["@lgtitute"] = (object?)longtude ?? DBNull.Value,
                        ["@atchNmId"] = string.IsNullOrEmpty(atchNmId) ? DBNull.Value : atchNmId,
                        ["@areaCode"] = areaCode,
                        ["@userRole"] = (object?)userRole ?? DBNull.Value,
                        ["@emplCont"] = emplCont,
                        ["@chnlCont"] = chnlCont,
                        ["@inflCont"] = inflCont,
                        ["@totlCont"] = totlCont
                    };

                    _db.QaEWebBean(insertSql, p);
                }
                else
                {
                    // UPDATE HEADER
                    const string updateSql = @"
UPDATE dbo.catActPreSl
SET
    actvDate = @actvDate,
    meetDate = @meetDate,
    actvName = @actvName,
    actvCity = @actvCity,
    district = @district,
    noOfPart = @noOfPart,
    noOfEnqu = @noOfEnqu,
    noOfVist = @noOfVist,
    prodCtLs = @prodCtLs,
    empPrsLs = @empPrsLs,
    actvRmrk = @actvRmrk,
    meetVenu = @meetVenu,
    latitute = @latitute,
    lgtitute = @lgtitute,
    atchNmId = @atchNmId,
    areaCode = @areaCode,
    userRole = @userRole,
    emplCont = @emplCont,
    chnlCont = @chnlCont,
    inflCont = @inflCont,
    totlCont = @totlCont,
    updateId = @updateId,
    updateDt = GETDATE()
WHERE docuNumb = @docuNumb;";

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = actvName,
                        ["@actvCity"] = actvCity,
                        ["@district"] = district,
                        ["@noOfPart"] = noOfPart,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@latitute"] = (object?)latitude ?? DBNull.Value,
                        ["@lgtitute"] = (object?)longtude ?? DBNull.Value,
                        ["@atchNmId"] = string.IsNullOrEmpty(atchNmId) ? DBNull.Value : atchNmId,
                        ["@areaCode"] = areaCode,
                        ["@userRole"] = (object?)userRole ?? DBNull.Value,
                        ["@emplCont"] = emplCont,
                        ["@chnlCont"] = chnlCont,
                        ["@inflCont"] = inflCont,
                        ["@totlCont"] = totlCont,
                        ["@updateId"] = loginIdn
                    };

                    _db.QaEWebBean(updateSql, p);

                    // Clear old detail rows
                    const string deleteDtl = @"DELETE FROM dbo.catActPreSlDtl WHERE docuNumb = @docuNumb;";
                    _db.QaEWebBean(deleteDtl, new Dictionary<string, object?> { ["@docuNumb"] = docuNumb });
                }

                // ---------- INSERT DETAIL ROWS (catActPreSlDtl) ----------
                InsertDetails(docuNumb, loginIdn, request);

                return Ok(new
                {
                    success = true,
                    message = isAdd ? "Activity saved successfully." : "Activity updated successfully.",
                    docuNumb,
                    timestamp = DateTime.Now
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new
                {
                    success = false,
                    message = "Error while saving activity.",
                    error = ex.Message,
                    timestamp = DateTime.Now
                });
            }
        }

        // ======================================
        // DETAIL INSERT HELPER (catActPreSlDtl)
        // ======================================
        private void InsertDetails(string docuNumb, string loginIdn, ActivityEntryRequest request)
        {
            const string insertDtlSql = @"
INSERT INTO dbo.catActPreSlDtl
(
    docuNumb, attnType, attnCode,
    statFlag, createId, createDt
)
VALUES
(
    @docuNumb, @attnType, @attnCode,
    'N', @createId, GETDATE()
);";

            string doc = Cut(docuNumb, 16);
            string createId = Cut(loginIdn, 10);

            // Employees -> attnType 'E', attnCode varchar(10)
            if (request.Employees != null)
            {
                foreach (var emp in request.Employees)
                {
                    var code = !string.IsNullOrWhiteSpace(emp.EmployeeCode)
                        ? emp.EmployeeCode
                        : emp.Name;

                    code = Cut(code, 10); // attnCode size

                    if (string.IsNullOrWhiteSpace(code)) continue;

                    var parms = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = doc,
                        ["@attnType"] = "E",
                        ["@attnCode"] = code,
                        ["@createId"] = createId
                    };
                    _db.QaEWebBean(insertDtlSql, parms);
                }
            }

            // Painters / Contractors / Applicators -> attnType 'I'
            if (request.Painters != null)
            {
                foreach (var pnt in request.Painters)
                {
                    var code = !string.IsNullOrWhiteSpace(pnt.Mobile)
                        ? pnt.Mobile
                        : pnt.Name;

                    code = Cut(code, 10);

                    if (string.IsNullOrWhiteSpace(code)) continue;

                    var parms = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = doc,
                        ["@attnType"] = "I",
                        ["@attnCode"] = code,
                        ["@createId"] = createId
                    };
                    _db.QaEWebBean(insertDtlSql, parms);
                }
            }

            // Channel Partners -> attnType 'C'
            if (request.ChannelPartners != null)
            {
                foreach (var ch in request.ChannelPartners)
                {
                    var code = !string.IsNullOrWhiteSpace(ch.PurchaserCode)
                        ? ch.PurchaserCode
                        : ch.Name;

                    code = Cut(code, 10);

                    if (string.IsNullOrWhiteSpace(code)) continue;

                    var parms = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = doc,
                        ["@attnType"] = "C",
                        ["@attnCode"] = code,
                        ["@createId"] = createId
                    };
                    _db.QaEWebBean(insertDtlSql, parms);
                }
            }
        }

        // ======================================
        // HELPER FUNCTIONS
        // ======================================
        private static string Cut(string? s, int max)
        {
            if (string.IsNullOrWhiteSpace(s)) return "";
            var t = s.Trim();
            return t.Length <= max ? t : t.Substring(0, max);
        }

        private static string? Left(string? s, int n)
        {
            if (string.IsNullOrWhiteSpace(s)) return null;
            var t = s.Trim();
            return t.Length <= n ? t : t.Substring(0, n);
        }

        private static DateTime? SafeParseDate(string? dateString)
        {
            if (string.IsNullOrWhiteSpace(dateString)) return null;
            var formats = new[]
            {
                "yyyy-MM-dd","MM/dd/yyyy","dd/MM/yyyy","yyyy/MM/dd",
                "MM-dd-yyyy","dd-MM-yyyy","yyyyMMdd","ddMMyyyy"
            };
            foreach (var f in formats)
            {
                if (DateTime.TryParseExact(dateString, f, CultureInfo.InvariantCulture,
                    DateTimeStyles.None, out var dt))
                    return dt;
            }
            if (DateTime.TryParse(dateString, out var any)) return any;
            return null;
        }
    }

    // ======================================
    // DTOs (inside same file)
    // ======================================
    public sealed class ActivityEntryRequest
    {
        public string? ProcessType { get; set; }      // Add / Update
        public string? DocuNumb { get; set; }         // For Update

        public string? ActivityName { get; set; }
        public string? Description { get; set; }
        public string? ActivityDate { get; set; }
        public string? MeetingVenue { get; set; }
        public string? CityName { get; set; }
        public string? District { get; set; }         // Emirates
        public string? Product { get; set; }

        public int? NoOfEmployees { get; set; }
        public int? TotalParticipants { get; set; }

        public string? Latitude { get; set; }
        public string? Longitude { get; set; }

        public string? LoginIdn { get; set; }
        public string? UserRole { get; set; }

        public List<ActivityEmployeeDto>? Employees { get; set; }
        public List<ActivityPainterDto>? Painters { get; set; }
        public List<ActivityChannelPartnerDto>? ChannelPartners { get; set; }

        public List<string>? ImageIds { get; set; }
    }

    public sealed class ActivityEmployeeDto
    {
        public string? EmployeeCode { get; set; }
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityPainterDto
    {
        public string? Type { get; set; }     // Painter / Contractor / Applicator
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityChannelPartnerDto
    {
        public string? Type { get; set; }           // Authorised dealer, Retailer, etc.
        public string? PurchaserCode { get; set; }  // Purchaser Code
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }
}
