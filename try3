using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

namespace sparshWebService.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Produces("application/json")]
    public sealed class ActivityEntryController : ControllerBase
    {
        private readonly DatabaseHelper _db;

        public ActivityEntryController(DatabaseHelper db)
        {
            _db = db;
        }

        // ============================================
        // POST: /api/ActivityEntry/save
        // ============================================
        [HttpPost("save")]
        [Consumes("application/json")]
        public IActionResult Save([FromBody] ActivityEntryRequest? request = null)
        {
            try
            {
                request ??= new ActivityEntryRequest();

                // ------- Basic validations -------
                if (string.IsNullOrWhiteSpace(request.ActivityName))
                    return BadRequest(new { success = false, message = "ActivityName is required." });

                if (string.IsNullOrWhiteSpace(request.ActivityDate))
                    return BadRequest(new { success = false, message = "ActivityDate is required." });

                if (!DateTime.TryParseExact(request.ActivityDate.Trim(),
                        "yyyy-MM-dd",
                        CultureInfo.InvariantCulture,
                        DateTimeStyles.None,
                        out var actvDate))
                {
                    if (!DateTime.TryParse(request.ActivityDate, out actvDate))
                        return BadRequest(new { success = false, message = "Invalid ActivityDate format." });
                }

                var loginIdn = !string.IsNullOrWhiteSpace(request.LoginIdn)
                    ? request.LoginIdn.Trim()
                    : (User?.Identity?.Name ?? "SYSTEM");

                // derive month (yyyymm) and meetDate
                var docuMnth = actvDate.ToString("yyyyMM");
                var meetDate = actvDate;

                int empCount = request.Employees?.Count ?? 0;
                int painterCount = request.Painters?.Count ?? 0;
                int chPartnerCount = request.ChannelPartners?.Count ?? 0;

                int totalParticipants = request.TotalParticipants > 0
                    ? request.TotalParticipants
                    : empCount + painterCount + chPartnerCount;

                // header strings with Cut
                string actvName = Cut(request.ActivityName, 100);
                string cityName = Cut(request.CityName, 100);
                string district = Cut(request.District, 100);   // Emirates
                string meetVenu = Cut(request.MeetingVenue, 255);
                string prodCtLs = Cut(request.Product, 255);
                string actvRmrk = Cut(request.Description, 500);
                string latitude = Cut(request.Latitude, 50);
                string longtude = Cut(request.Longitude, 50);

                // empPrsLs: concat employeeCode-name
                string empPrsLs = request.Employees != null && request.Employees.Count > 0
                    ? string.Join(" | ", request.Employees.Select(e =>
                        $"{(e.EmployeeCode ?? "").Trim()}-{(e.Name ?? "").Trim()}"))
                    : "";

                // Default / mandatory fields
                string caaActTy = "01";        // Activity Type (tune as per business)
                string caaObjTy = "01";        // Objective Type
                string pinCodeN = "";          // Not captured in UI
                int noOfEnqu = 0;
                int noOfVist = 0;
                string caaPrjTy = "01";        // Project Type
                string mobileNo = "";          // header-level contact
                string emailAdd = "";
                string contPers = "";
                int potnInMT = 0;
                string maturtMn = docuMnth;
                string rejcRmrk = "";
                string statFlag = "N";

                int emplCont = empCount;
                int inflCont = painterCount;
                int chnlCont = chPartnerCount;
                int totlCont = totalParticipants;

                // Build atchNmId from image IDs (if needed)
                string atchNmId = (request.ImageIds != null && request.ImageIds.Count > 0)
                    ? string.Join(",", request.ImageIds
                        .Select(x => x?.Trim())
                        .Where(x => !string.IsNullOrEmpty(x)))
                    : "";

                bool isAdd = string.Equals(request.ProcessType, "Add", StringComparison.OrdinalIgnoreCase)
                             || string.IsNullOrWhiteSpace(request.DocuNumb);

                string docuNumb = request.DocuNumb?.Trim() ?? "";

                // ===================================
                // 1) Generate docuNumb if Add
                // ===================================
                if (isAdd)
                {
                    const string docSql = @"
DECLARE @docuNumb CHAR(20);
EXEC dbo.wcpDocNoGen @docuType = @docuType, @docuNumb = @docuNumb OUTPUT;
SELECT @docuNumb AS docuNumb;";

                    var docParams = new Dictionary<string, object?>
                    {
                        ["@docuType"] = "ACTPRESL"   // change if your docuType is different
                    };

                    var docResult = _db.QaEWebBean(docSql, docParams);
                    var docRow = docResult?.FirstOrDefault();
                    docuNumb = docRow?["docuNumb"]?.ToString()?.Trim() ?? "";

                    if (string.IsNullOrWhiteSpace(docuNumb))
                        return BadRequest(new { success = false, message = "Document number generation failed." });
                }
                else
                {
                    if (string.IsNullOrWhiteSpace(docuNumb))
                        return BadRequest(new { success = false, message = "DocuNumb is required for Update." });
                }

                // ===================================
                // 2) Insert / Update header
                // ===================================
                if (isAdd)
                {
                    const string insertHeaderSql = @"
INSERT INTO catActPreSl
(
    docuNumb, docuMnth, actvDate, meetDate, actvName,
    caaActTy, caaObjTy, actvCity, district, pinCodeN,
    noOfPart, noOfEnqu, noOfVist,
    prodCtLs, empPrsLs, actvRmrk, meetVenu,
    caaPrjTy, mobileNo, emailAdd, contPers, potnInMT,
    maturtMn, rejcRmrk, statFlag, createId, createDt,
    latitude, longtude, atchNmId,
    userRole, emplCont, chnlCont, inflCont, totlCont
)
VALUES
(
    @docuNumb, @docuMnth, @actvDate, @meetDate, @actvName,
    @caaActTy, @caaObjTy, @actvCity, @district, @pinCodeN,
    @noOfPart, @noOfEnqu, @noOfVist,
    @prodCtLs, @empPrsLs, @actvRmrk, @meetVenu,
    @caaPrjTy, @mobileNo, @emailAdd, @contPers, @potnInMT,
    @maturtMn, @rejcRmrk, @statFlag, @createId, GETDATE(),
    @latitude, @longtude, @atchNmId,
    @userRole, @emplCont, @chnlCont, @inflCont, @totlCont
);

SELECT @docuNumb AS docuNumb;";

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@docuMnth"] = docuMnth,
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = actvName,
                        ["@caaActTy"] = caaActTy,
                        ["@caaObjTy"] = caaObjTy,
                        ["@actvCity"] = cityName,
                        ["@district"] = district,
                        ["@pinCodeN"] = pinCodeN,
                        ["@noOfPart"] = totlCont,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@caaPrjTy"] = caaPrjTy,
                        ["@mobileNo"] = mobileNo,
                        ["@emailAdd"] = emailAdd,
                        ["@contPers"] = contPers,
                        ["@potnInMT"] = potnInMT,
                        ["@maturtMn"] = maturtMn,
                        ["@rejcRmrk"] = rejcRmrk,
                        ["@statFlag"] = statFlag,
                        ["@createId"] = loginIdn,
                        ["@latitude"] = latitude,
                        ["@longtude"] = longtude,
                        ["@atchNmId"] = string.IsNullOrEmpty(atchNmId) ? DBNull.Value : atchNmId,
                        ["@userRole"] = (object?)request.UserRole ?? DBNull.Value,
                        ["@emplCont"] = emplCont,
                        ["@chnlCont"] = chnlCont,
                        ["@inflCont"] = inflCont,
                        ["@totlCont"] = totlCont
                    };

                    _db.QaEWebBean(insertHeaderSql, p);
                }
                else
                {
                    const string updateHeaderSql = @"
UPDATE catActPreSl
SET
    actvDate   = @actvDate,
    meetDate   = @meetDate,
    actvName   = @actvName,
    actvCity   = @actvCity,
    district   = @district,
    pinCodeN   = @pinCodeN,
    noOfPart   = @noOfPart,
    noOfEnqu   = @noOfEnqu,
    noOfVist   = @noOfVist,
    prodCtLs   = @prodCtLs,
    empPrsLs   = @empPrsLs,
    actvRmrk   = @actvRmrk,
    meetVenu   = @meetVenu,
    mobileNo   = @mobileNo,
    emailAdd   = @emailAdd,
    contPers   = @contPers,
    potnInMT   = @potnInMT,
    maturtMn   = @maturtMn,
    rejcRmrk   = @rejcRmrk,
    latitude   = @latitude,
    longtude   = @longtude,
    atchNmId   = @atchNmId,
    userRole   = @userRole,
    emplCont   = @emplCont,
    chnlCont   = @chnlCont,
    inflCont   = @inflCont,
    totlCont   = @totlCont,
    updateId   = @updateId,
    updateDt   = GETDATE()
WHERE docuNumb = @docuNumb;";

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = docuNumb,
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = actvName,
                        ["@actvCity"] = cityName,
                        ["@district"] = district,
                        ["@pinCodeN"] = pinCodeN,
                        ["@noOfPart"] = totlCont,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@mobileNo"] = mobileNo,
                        ["@emailAdd"] = emailAdd,
                        ["@contPers"] = contPers,
                        ["@potnInMT"] = potnInMT,
                        ["@maturtMn"] = maturtMn,
                        ["@rejcRmrk"] = rejcRmrk,
                        ["@latitude"] = latitude,
                        ["@longtude"] = longtude,
                        ["@atchNmId"] = string.IsNullOrEmpty(atchNmId) ? DBNull.Value : atchNmId,
                        ["@userRole"] = (object?)request.UserRole ?? DBNull.Value,
                        ["@emplCont"] = emplCont,
                        ["@chnlCont"] = chnlCont,
                        ["@inflCont"] = inflCont,
                        ["@totlCont"] = totlCont,
                        ["@updateId"] = loginIdn
                    };

                    _db.QaEWebBean(updateHeaderSql, p);

                    // Delete old details for this docuNumb
                    const string deleteDtlSql = @"DELETE FROM catActPreSlDtl WHERE docuNumb = @docuNumb;";
                    _db.QaEWebBean(deleteDtlSql,
                        new Dictionary<string, object?> { ["@docuNumb"] = docuNumb });
                }

                // ===================================
                // 3) Insert detail rows (QaEWebBean)
                // ===================================
                const string insertDtlSql = @"
INSERT INTO catActPreSlDtl
(
    docuNumb, attnType, attnCode,
    statFlag, createId, createDt,
    retlCode, dsrRem06, dsrRem07, dsrRem08, dsrRem09
)
VALUES
(
    @docuNumb, @attnType, @attnCode,
    @statFlag, @createId, GETDATE(),
    @retlCode, @dsrRem06, @dsrRem07, @dsrRem08, @dsrRem09
);";

                // Employees
                if (request.Employees != null)
                {
                    foreach (var emp in request.Employees)
                    {
                        var pEmp = new Dictionary<string, object?>
                        {
                            ["@docuNumb"] = docuNumb,
                            ["@attnType"] = "E", // Employee
                            ["@attnCode"] = emp.EmployeeCode ?? "",
                            ["@statFlag"] = "N",
                            ["@createId"] = loginIdn,
                            ["@retlCode"] = DBNull.Value,
                            ["@dsrRem06"] = emp.Name ?? "",
                            ["@dsrRem07"] = emp.Mobile ?? "",
                            ["@dsrRem08"] = DBNull.Value,
                            ["@dsrRem09"] = DBNull.Value
                        };
                        _db.QaEWebBean(insertDtlSql, pEmp);
                    }
                }

                // Painters / Contractors / Applicators
                if (request.Painters != null)
                {
                    foreach (var p in request.Painters)
                    {
                        string attnType = "P"; // Painter default
                        var t = (p.Type ?? "").Trim().ToUpperInvariant();
                        if (t.Contains("CONTRACTOR")) attnType = "C";
                        else if (t.Contains("APPLICATOR")) attnType = "A";

                        var pPain = new Dictionary<string, object?>
                        {
                            ["@docuNumb"] = docuNumb,
                            ["@attnType"] = attnType,
                            ["@attnCode"] = p.Mobile ?? "",
                            ["@statFlag"] = "N",
                            ["@createId"] = loginIdn,
                            ["@retlCode"] = DBNull.Value,
                            ["@dsrRem06"] = p.Name ?? "",
                            ["@dsrRem07"] = p.Type ?? "",
                            ["@dsrRem08"] = DBNull.Value,
                            ["@dsrRem09"] = DBNull.Value
                        };
                        _db.QaEWebBean(insertDtlSql, pPain);
                    }
                }

                // Channel Partners
                if (request.ChannelPartners != null)
                {
                    foreach (var cp in request.ChannelPartners)
                    {
                        var pCp = new Dictionary<string, object?>
                        {
                            ["@docuNumb"] = docuNumb,
                            ["@attnType"] = "H", // Code for Channel Partner / Dealer (adjust as per your logic)
                            ["@attnCode"] = cp.PurchaserCode ?? "",
                            ["@statFlag"] = "N",
                            ["@createId"] = loginIdn,
                            ["@retlCode"] = cp.PurchaserCode ?? "",
                            ["@dsrRem06"] = cp.Name ?? "",
                            ["@dsrRem07"] = cp.Mobile ?? "",
                            ["@dsrRem08"] = cp.Type ?? "",
                            ["@dsrRem09"] = DBNull.Value
                        };
                        _db.QaEWebBean(insertDtlSql, pCp);
                    }
                }

                return Ok(new
                {
                    success = true,
                    message = isAdd ? "Activity created successfully." : "Activity updated successfully.",
                    docuNumb,
                    processType = isAdd ? "Add" : "Update",
                    totalParticipants = totlCont,
                    employeesCount = empCount,
                    paintersCount = painterCount,
                    channelPartnersCount = chPartnerCount,
                    timestamp = DateTime.Now
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new
                {
                    success = false,
                    message = "Error while saving activity.",
                    error = ex.Message,
                    timestamp = DateTime.Now
                });
            }
        }

        // ----------------- helpers -----------------
        private static string Cut(string? s, int max)
        {
            if (string.IsNullOrWhiteSpace(s)) return "";
            var t = s.Trim();
            return t.Length <= max ? t : t[..max];
        }
    }

    // =======================
    //   DTOs (View Models)
    // =======================

    public sealed class ActivityEmployeeDto
    {
        public string? EmployeeCode { get; set; }
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityPainterDto
    {
        // "Painter", "Contractor", "Applicator"
        public string? Type { get; set; }
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityChannelPartnerDto
    {
        // e.g. "Authorsied dealer", "Direct Dealer", "Retailer", etc.
        public string? Type { get; set; }
        public string? PurchaserCode { get; set; }
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class ActivityEntryRequest
    {
        // "Add" / "Update"
        public string? ProcessType { get; set; }

        // For Update
        public string? DocuNumb { get; set; }

        // Header fields from Flutter
        public string? ActivityName { get; set; }        // Painter Meet / Contractor Meet / Applicator Meet
        public string? Description { get; set; }         // actvRmrk
        public string? ActivityDate { get; set; }        // yyyy-MM-dd
        public string? MeetingVenue { get; set; }        // Address
        public string? CityName { get; set; }
        public string? District { get; set; }            // Emirates
        public string? Product { get; set; }             // Wall Care Putty

        public int NoOfEmployees { get; set; }           // optional
        public int TotalParticipants { get; set; }       // optional, else computed

        public string? Latitude { get; set; }
        public string? Longitude { get; set; }

        // Audit
        public string? LoginIdn { get; set; }            // createId/updateId
        public string? UserRole { get; set; }            // maps to userRole

        // Collections
        public List<ActivityEmployeeDto> Employees { get; set; } = new();
        public List<ActivityPainterDto> Painters { get; set; } = new();
        public List<ActivityChannelPartnerDto> ChannelPartners { get; set; } = new();

        // Optional: Upload IDs / file names for atchNmId
        public List<string> ImageIds { get; set; } = new();
    }
}
