using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;
using System.Linq;

#nullable enable

namespace sparshWebService.Controllers
{
    [ApiController]
    [Produces("application/json")]
    [Route("api/[controller]")]
    public sealed class UseUpdateController : ControllerBase
    {
        private readonly DatabaseHelper _db;
        public UseUpdateController(DatabaseHelper dbHelper) => _db = dbHelper;

        // ----------------- GET: /api/UseUpdate/by-inflcode/{inflCode} -----------------
        [HttpGet("by-inflcode/{inflCode}")]
        public IActionResult GetByInflCode([FromRoute] string inflCode)
        {
            if (string.IsNullOrWhiteSpace(inflCode))
                return BadRequest(new { success = false, message = "inflCode is required." });

            const string sql = @"
SELECT TOP 1
    inflCode, areaCode, inflType, inflName, contName,
    -- name cluster
    frstname, middname, lastname,
    -- address / contact
    inflAdd1, inflAdd2, inflAdd3, inflCity, district, inflPinC,
    emirates, mobileNo, emailAdd,
    -- bank
    bankApNm, ibannumb, bankBnNm, bankBnDs, bankaddr, bankAcNo, bankIFSC,
    -- VAT / license / extras
    vatfrmnm, vatraddr, vattxreg, vatefdt,
    comlcnno, comissau, comlctyp, comestdt, comexpdt, comtrdnm, comrespn, comraddr, comeffdt,
    -- ID/KYC
    emiridno, idholder, nationty, employer, issudate, expirydt, occupatn,
    kycVerFl, kycVerDt, idCardTy, idCardNo, kycVrTyp, inDocCnt, rjcRemrk,
    -- misc
    birthDat, busSttYr, inflQual, expertis, wrkrDetl, anniDate, landLnNo,
    isActive, createId, createDt, updateId, updateDt
FROM dbo.ctmInfluncr WITH (NOLOCK)
WHERE inflCode = @inflCode;";

            var rows = _db.QaEWebBean(sql, new Dictionary<string, object?> { ["@inflCode"] = inflCode });
            var row = rows?.FirstOrDefault();
            if (row == null)
                return NotFound(new { success = false, message = "No record found for inflCode." });

            return Ok(new { success = true, data = row });
        }

        // ------------- POST: /api/UseUpdate/update-by-inflcode/{inflCode} -------------
        // Patch-like: update only provided fields; ignores nulls.
        [HttpPost("update-by-inflcode/{inflCode}")]
        [Consumes("application/json")]
        public IActionResult UpdateByInflCode([FromRoute] string inflCode, [FromBody] UseUpdatePatch body)
        {
            if (string.IsNullOrWhiteSpace(inflCode))
                return BadRequest(new { success = false, message = "inflCode is required." });

            // Ensure record exists
            const string chk = "SELECT COUNT(1) AS Cnt FROM dbo.ctmInfluncr WHERE inflCode = @inflCode;";
            var exists = Convert.ToInt32(_db.QaEWebBean(chk, new() { ["@inflCode"] = inflCode })?.FirstOrDefault()?["Cnt"] ?? 0) > 0;
            if (!exists)
                return NotFound(new { success = false, message = "No record found for inflCode." });

            // Build SET using only non-null properties from body
            var set = new List<string>();
            var p = new Dictionary<string, object?> { ["@inflCode"] = inflCode };

            void Add(string col, object? val)
            {
                if (val == null) return;
                var param = "@p_" + col;
                set.Add($"{col} = {param}");
                p[param] = val;
            }

            // Names
            Add("frstname", body.FirstName);
            Add("middname", body.MiddleName);
            Add("lastname", body.LastName);
            Add("inflName", body.FullName);   // optional if you also populate a combined name
            Add("contName", body.ContactName);

            // Address / contact
            Add("inflAdd1", body.Address1);
            Add("inflAdd2", body.Address2);
            Add("inflAdd3", body.Address3);
            Add("inflCity", body.City);
            Add("district", body.District);
            Add("inflPinC", body.Pincode);
            Add("emirates", body.Emirates);
            Add("emailAdd", body.Email);
            // NOTE: mobileNo is usually locked. If you must allow, uncomment:
            // Add("mobileNo", body.MobileNumber);

            // Bank
            Add("bankApNm", body.AccountHolderName);
            Add("ibannumb", NormalizeIban(body.IbanNumber));
            Add("bankBnNm", body.BankName);
            Add("bankBnDs", body.BranchName);
            Add("bankaddr", body.BankAddress);
            Add("bankAcNo", body.BankAccountNo);
            Add("bankIFSC", body.BankIFSC);

            // VAT / license
            Add("vatfrmnm", body.FirmName);
            Add("vatraddr", body.VatAddress);
            Add("vattxreg", body.TaxRegistrationNumber);
            Add("vatefdt", body.VatEffectiveDate);

            Add("comlcnno", body.LicenseNumber);
            Add("comissau", body.IssuingAuthority);
            Add("comlctyp", body.LicenseType);
            Add("comestdt", body.EstablishmentDate);
            Add("comexpdt", body.LicenseExpiryDate);
            Add("comtrdnm", body.TradeName);
            Add("comrespn", body.ResponsiblePerson);
            Add("comraddr", body.LicenseAddress);
            Add("comeffdt", body.EffectiveDate);

            // ID/KYC
            Add("emiridno", body.EmiratesIdNumber);
            Add("idholder", body.IdName);
            Add("nationty", body.Nationality);
            Add("employer", body.Employer);
            Add("issudate", body.IssueDate);
            Add("expirydt", body.ExpiryDate);
            Add("occupatn", body.Occupation);

            Add("kycVerFl", body.KycVerifiedFlag);
            Add("kycVerDt", body.KycVerifiedDate);
            Add("idCardTy", body.IdCardType);
            Add("idCardNo", body.IdCardNo);
            Add("kycVrTyp", body.KycVerifyType);
            Add("inDocCnt", body.InDocCount);
            Add("rjcRemrk", body.RejectRemark);

            // Misc
            Add("birthDat", body.DateOfBirth);
            Add("busSttYr", body.BusinessStartYear);
            Add("inflQual", body.Qualification);
            Add("expertis", body.Expertise);
            Add("wrkrDetl", body.WorkerDetail);
            Add("anniDate", body.AnniversaryDate);
            Add("landLnNo", body.Landline);
            Add("isActive", body.IsActive);
            Add("areaCode", body.AreaCode);
            Add("inflType", body.InfluencerType);

            if (set.Count == 0)
                return BadRequest(new { success = false, message = "No updatable fields provided." });

            set.Add("updateId = 'API'");
            set.Add("updateDt = GETDATE()");

            var sql = $@"
UPDATE dbo.ctmInfluncr
SET {string.Join(", ", set)}
WHERE inflCode = @inflCode;

SELECT TOP 1 *
FROM dbo.ctmInfluncr WITH (NOLOCK)
WHERE inflCode = @inflCode;";

            var rows = _db.QaEWebBean(sql, p);
            var row = rows?.FirstOrDefault();

            return Ok(new { success = true, message = "Updated.", data = row });
        }

        // ----------------- helpers -----------------
        private static string? NormalizeIban(string? s) =>
            string.IsNullOrWhiteSpace(s) ? s : s.Replace(" ", "").ToUpperInvariant();
    }

    // ----------------- DTO (patch) -----------------
    // Only send fields you want to change. Nulls are ignored.
    public sealed class UseUpdatePatch
    {
        // Names
        public string? FirstName { get; set; }
        public string? MiddleName { get; set; }
        public string? LastName { get; set; }
        public string? FullName { get; set; }     // if you also maintain inflName
        public string? ContactName { get; set; }  // contName

        // Address / contact
        public string? Address1 { get; set; }     // inflAdd1
        public string? Address2 { get; set; }     // inflAdd2
        public string? Address3 { get; set; }     // inflAdd3
        public string? City { get; set; }         // inflCity
        public string? District { get; set; }
        public string? Pincode { get; set; }      // inflPinC
        public string? Emirates { get; set; }
        public string? Email { get; set; }
        public string? MobileNumber { get; set; } // usually locked; keep null unless you want to allow

        // Bank
        public string? AccountHolderName { get; set; } // bankApNm
        public string? IbanNumber { get; set; }        // ibannumb
        public string? BankName { get; set; }          // bankBnNm
        public string? BranchName { get; set; }        // bankBnDs
        public string? BankAddress { get; set; }       // bankaddr
        public string? BankAccountNo { get; set; }     // bankAcNo
        public string? BankIFSC { get; set; }          // bankIFSC

        // VAT / license
        public string? FirmName { get; set; }              // vatfrmnm
        public string? VatAddress { get; set; }            // vatraddr
        public string? TaxRegistrationNumber { get; set; } // vattxreg
        public string? VatEffectiveDate { get; set; }      // vatefdt

        public string? LicenseNumber { get; set; }     // comlcnno
        public string? IssuingAuthority { get; set; }  // comissau
        public string? LicenseType { get; set; }       // comlctyp
        public string? EstablishmentDate { get; set; } // comestdt
        public string? LicenseExpiryDate { get; set; } // comexpdt
        public string? TradeName { get; set; }         // comtrdnm
        public string? ResponsiblePerson { get; set; } // comrespn
        public string? LicenseAddress { get; set; }    // comraddr
        public string? EffectiveDate { get; set; }     // comeffdt

        // ID/KYC
        public string? EmiratesIdNumber { get; set; }  // emiridno
        public string? IdName { get; set; }            // idholder
        public string? Nationality { get; set; }       // nationty
        public string? Employer { get; set; }          // employer
        public string? IssueDate { get; set; }         // issudate
        public string? ExpiryDate { get; set; }        // expirydt
        public string? Occupation { get; set; }        // occupatn

        public string? KycVerifiedFlag { get; set; }   // kycVerFl
        public string? KycVerifiedDate { get; set; }   // kycVerDt
        public string? IdCardType { get; set; }        // idCardTy
        public string? IdCardNo { get; set; }          // idCardNo
        public string? KycVerifyType { get; set; }     // kycVrTyp
        public string? InDocCount { get; set; }        // inDocCnt
        public string? RejectRemark { get; set; }      // rjcRemrk

        // Misc
        public string? DateOfBirth { get; set; }       // birthDat
        public string? BusinessStartYear { get; set; } // busSttYr
        public string? Qualification { get; set; }     // inflQual
        public string? Expertise { get; set; }         // expertis
        public string? WorkerDetail { get; set; }      // wrkrDetl
        public string? AnniversaryDate { get; set; }   // anniDate
        public string? Landline { get; set; }          // landLnNo
        public string? IsActive { get; set; }          // isActive (Y/N/T etc.)
        public string? AreaCode { get; set; }          // areaCode
        public string? InfluencerType { get; set; }    // inflType (PN / 2IK / etc.)
    }
}
