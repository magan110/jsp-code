<%@ include file="/Envr/JSP/SecurityCom.jsp"%>

<%
ResultSet rset = null;
String	procType = "A",
		docuNumb = "",
		formName = "CrLimReq",
		// /BirlaWhite/Master/creditUpd/CrLimReq.jsp
		docuDate = "",
		strtDate = "",
		endgDate = "",
		adRemark = "",
		custCode = "",
		securDep = "0",
		splPerFl = "N",
		alertMsg = "Please note New Adhoc Limit will override Existing Adhoc Cr Limit (If any), for Example if Original Cr Lim 1 Lac, existing Adhoc limit is 1 Lac, total is 2 Lac, and new request for Adhoc Limit 0.5 Lac, then resulted overall Effective Cr Limit will be Original + new = 1.5 Lacs",
		areaCode = "",
		sql = "";

int adhCrLim = 0;

boolean recFound = false;

/*
queryCod	sqlStmnt
MK_00070	select top 1 'SD : ' + cast(a.securDep as varchar) + ', Chq Rt : ' + cast(a.cheqRetn as varchar) + ', OS 30 : ' + cast(a.am000030 as varchar) + ', OS 60 : ' + cast(a.am031060 as varchar) + ', OS 90 : ' + cast(a.am061090 as varchar) + ', OS > 90 : ' + cast(a.amAbv090 as varchar) + ', C Form Pending : ' + cast(a.cFrmPend as varchar) + ', Cur Cr Lim : ' + cast(a.curCrLim as varchar) + ', Max Cr Lim : ' + cast(a.secur4Tm as varchar) + ', <BR>Penalty : ' + cast(a.penalAmt as varchar) + ', Proposed Cr Lim : ' + cast(a.proCrLim as varchar) + ', Adhoc Cr Lim : ' + cast(a.adhCrLim as varchar) + ', Tot Cr Lim : ' + cast(a.totCrLim as varchar), a.proCrLim, a.securDep from dptCrLimAut a with (nolock) where custCode='@__01' order by mnthYear desc

To be displayed from Function Module 

*/

if(log.isValidRole("comCn", true)) //|| loginIdM.equals("1659")
{
	splPerFl = "Y";
}

if (XssFilter.parSmGet("procType") != null)
	procType = XssFilter.parSmGet("procType");
if (XssFilter.parSmGet("docuNumb") != null)
	docuNumb = XssFilter.parSmGet("docuNumb");
%>

<script type="text/javascript" language="javascript">
function openLupLoc()
{ 
	var wherList = "SW_01" + splitChr + "<%=loginIdM%>" + splitMlt + "SW_02";
	docuNumbMkt('<%=formName%>', 'docuNumb', 'CCL', wherList);
}

function refreshed()
{
	if (document.<%=formName%>.procType.value == "A")
	{
		enableDisable("docuNumb", "D", true, true);
	}
	else
	{
		enableDisable("docuNumb", "E", true, true);
	}

	if((!isEmpty(document.<%=formName%>.docuNumb.value) && document.<%=formName%>.procType.value != "A") || document.<%=formName%>.procType.value == "A")
	{
		document.<%=formName%>.method = "POST";
		document.<%=formName%>.action = "<%=formName%>.jsp";
		document.<%=formName%>.submit();
	}
}

function areaCodeChange()
{
	document.<%=formName%>.custCode.value = "";
}

function custCodeChange(rqstType)
{
	if (document.<%=formName%>.areaCode.value == "")
	{
		alert("Please choose Area Code");
		document.<%=formName%>.custCode.value = "";
		document.<%=formName%>.areaCode.focus();
		return false;
	}

//alert("1"); 
	var wherList = "";
	var tradeNtr = "T";
	if(document.<%=formName%>.splPerFl.value == "N")
	{
		alert("chk");
		wherList = whereAdd(wherList, "SW_28", "ST','RD','AD");  
	}
	else // Special Permission to COmmercial for Non Trade too
	{
		tradeNtr = "A"; // All Customers allowed including Non Trade 
	}

	var rtnValue = custCodeHlp('<%=formName%>', 'areaCode', 'custCode', rqstType, 'O', tradeNtr, wherList);
	
	//alert("rqstType:- ");

	if (rtnValue && rqstType == "G")
	{
		//alert("sapCusCd" + document.<%=formName%>.sapCusCd.value);
		document.<%=formName%>.crLimFrq.value = "";
		var wherList = "", srcFldNm = "penalDtl";
		var tgtFldNm = srcFldNm + "Div";
		//wherList = whereAdd(wherList, "@__01", document.<%=formName%>.custCode.value);
		wherList = whereAdd(wherList, "SW01", document.<%=formName%>.sapCusCd.value);
		//var dataRecd = setPrmNew('<%=formName%>', srcFldNm, "MK_00070", "G", "DN", wherList, tgtFldNm);
		var dataRecd = setPrmNew('<%=formName%>', srcFldNm, "SP_00001", "G", "DN", wherList, tgtFldNm);
		//alert("dataRecd:- " + dataRecd);
		if(dataRecd)
		{
			var breakUp = document.getElementById(tgtFldNm).innerText.split(splitChr);
			//	alert("Data- " + document.getElementById(tgtFldNm).innerText);
			document.getElementById(tgtFldNm).innerHTML = '<b>SD<b> : ' + breakUp[15] + ', <b>Chq Rt :<b> ' + breakUp[14] + ', Open Billing : '+ breakUp[7] +' C Form Pending : ' + breakUp[12] + ', Cur Cr Lim : ' + breakUp[9] + ', Max Cr Lim : ' + breakUp[0] + ', <BR>Penalty : ' + breakUp[8] + ', Proposed Cr Lim : ' + breakUp[9] + ', Adhoc Cr Lim : ' + breakUp[1] + ', Tot Cr Lim : ' + breakUp[0];
			document.<%=formName%>.proCrLim.value = breakUp[9];
			document.<%=formName%>.securDep.value = breakUp[15]/100000;
			document.<%=formName%>.openBill.value = breakUp[7];
		}

		wherList = "";
		wherList = whereAdd(wherList, "@__01", "<%=WebSessBean.getFincYear()%>");  
		wherList = whereAdd(wherList, "@__02", document.<%=formName%>.custCode.value);
		dataRecd = setPrmNew("<%=formName%>", 'custCode', "MK_00076", "G", "TN", wherList, "crLimFrq");		
	}
	return rtnValue;
}

/*
Sample Flow 14/GRG/CCL/00001
Delegation Sr No 6.05 c) 
1.If Cheque gets bounced due to insufficient fund, the stockist are reverted to Pay order/DD/RTGS/ Electronic Mode of payment for next 6 months. On the first instance credit limit is reduced by 25%.
2. If C-forms are pending for 2 quarters back from the current quarter, rating would reduce 25% of Credit Limit per quarter.
3. If outstanding exceeds 30 days beyond credit period, rating is downgraded by 25%.
4. If outstanding exceeds 60 days beyond credit period, rating is downgraded by 75%.
5. If outstanding exceeds 90 days beyond credit period, rating is downgraded by 100% or say NIL credit limit at this juncture.
6. If relationship among partners becomes unharmonious, rating is immediately downgraded depending upon extent of rift among partners.
7. In case the Purchaser has diverted large fund for house/ property and in any other business, the ranking to be downgraded. Close watch on overtrading is maintained & delinquent Customers are immediately downgraded as recommended by marketing Team case to case basis.


Temporary (Adhoc) Credit Limit


if(Upto SD * 8 and Max. two time in a Financial Year)
	Flow will be AH->SH->Zonal A/c->ZH
else upto SD * 10  
	Flow will be AH->SH->Zonal A/c->ZH->FH (S).

Max Frequency can be Max. Six times in a financial year.
Above Credit limit period shall be applicable for max. 15 days from the effective date

New Requirement - FY-21

Scenario 1	Upto 6 times of Security Deposit at ZH Level	Upto 6 times of Security Deposit at ZH Level
Scenario 2	Upto 10 times of Security Deposit at FH-Sales Level	Upto 10 times of Security Deposit at FH-Sales Level
Scenario 3	Max. two time in a Financial Year at ZH Level	Max. two time in a Financial Year at ZH Level
Scenario 4	Max. four time in a financial year at FH Level 	Max. Two time in a financial year at FH Level 
Scenario 5	Above Temporary/adhoc Credit limit period shall be applicable for max. 15 days from the effective date 	Above Temporary/adhoc Credit limit period shall be applicable for max. 15 days from the effective date 

*/

function adhCrLimChk()
{
	document.<%=formName%>.mktgHdEs.value = "N";
	document.<%=formName%>.escaMsge.value = "";
	var	adhCrLim = document.<%=formName%>.adhCrLim.value;
	var	securDep = document.<%=formName%>.securDep.value;
	var	proCrLim = document.<%=formName%>.proCrLim.value;
	var	crLimFrq = document.<%=formName%>.crLimFrq.value;
	// alert("crLimFrq:- " + crLimFrq);
	var	secAlwLm = securDep * 10; // Effective from 01-Feb-14 earlier 12 
	var	secAlwZh = securDep * 8;
	
	alert("secAlwLm : " + secAlwLm + ", secAlwZh :- " + secAlwZh + ", securDep :- " + securDep );
	var	adhAlwLm = parseFloat(adhCrLim) + parseFloat(proCrLim);
	alert("adhAlwLm" + adhAlwLm);

	if (!textValidApp(document.<%=formName%>.areaCode, 'Area Code', false))
		return false;

	if (!textValidApp(document.<%=formName%>.custCode, 'Purchaser Code', false))
		return false;

	if (!isDate(document.<%=formName%>.strtDate, true, '>=today'))
		return false;

	if (!isDate(document.<%=formName%>.endgDate, true, '>=today'))
		return false;

	if (!compareDateEqual(document.<%=formName%>.endgDate.value, document.<%=formName%>.strtDate.value))
	{
		alert("Start Date cannot be greater than End Date");
		document.<%=formName%>.strtDate.focus();
		return false;
	}

	if(crLimFrq == "")
	{
		alert("please refresh page, connectivity might be broken");
		return false;
	}
	
	if(!isIntApp(document.<%=formName%>.adhCrLim, 'PN'))
		return false;

	var daysDiff = compareDateNew(document.<%=formName%>.endgDate.value, document.<%=formName%>.strtDate.value);

	if (daysDiff > 15 && document.<%=formName%>.splPerFl.value == "N") // Effective from 14-Jan-14, Commercial Exception Given as per change request 21/KKR/ACR/00315
	{
		alert("Adhoc Additional Limit can be given for Max 15 Days");
		document.<%=formName%>.strtDate.focus();
		return false;
	}

/*
	if (daysDiff > 30)
	{
		alert("Adhoc Additional Limit can be given for Max 30 Days");
		document.<%=formName%>.strtDate.focus();
		return false;
	}
	else if (daysDiff > 15)
	{
		if(adhCrLim > 5000000)
		{
			alert("Adhoc Additional Limit can be given for Max 15 Days for amount > 50 Lacs");
			document.<%=formName%>.strtDate.focus();
			return false;
		}
		else
		{
			document.<%=formName%>.mktgHdEs.value = "Y";
			document.<%=formName%>.escaMsge.value += "Days > 15";
		}
	}
*/
	if(document.<%=formName%>.splPerFl.value == "N")
	{
		if(adhAlwLm > secAlwLm)
		{
			alert("Adhoc Cr Limit + Current Cr Limit can not be greater than Allowable Limit ie " + secAlwLm);
			return false;
		}
		else if (adhAlwLm > secAlwZh)
		{
			document.<%=formName%>.mktgHdEs.value = "Y";
			document.<%=formName%>.escaMsge.value += ", Req Cr Lm > SD * 8";
		}
	}

	if(crLimFrq >= 4 && document.<%=formName%>.splPerFl.value == "N")
	{
		alert("Adhoc Cr Limit limit frequency can not be more than 4 times in a Year, curr freq is " + document.<%=formName%>.crLimFrq.value);
		return false;
	}
	else if (crLimFrq > 2)
	{
		document.<%=formName%>.mktgHdEs.value = "Y";
		document.<%=formName%>.escaMsge.value += ", Freq. in Year " + crLimFrq;
	}
	return true;
}

function submitValid()
{

	//alert("This Facility is under Testing..Will be live soon!");
	if (!adhCrLimChk())
		return false;

	if (!textValidApp(document.<%=formName%>.adRemark, 'Reason', false))
		return false;

	if (!subValidCom("<%=formName%>"))
		return false;	

	/*alert(document.<%=formName%>.crLimFrq.value);
	alert(document.<%=formName%>.mktgHdEs.value);
	alert(document.<%=formName%>.escaMsge.value);
	alert(document.<%=formName%>.escaMsge.value.length);*/

	var alertMsg = "<%=alertMsg%>";
	
	if(document.<%=formName%>.mktgHdEs.value == "Y")
		alertMsg += ", Document will flow to FH (M) " + document.<%=formName%>.escaMsge.value;

	if (confirm(alertMsg + ", You have choosen to " + document.<%=formName%>.procType.options[document.<%=formName%>.procType.selectedIndex].text + ". Press OK to continue"))
	{
		document.<%=formName%>.method = "POST";
		document.<%=formName%>.action = "<%=formName%>S.jsp";
		document.<%=formName%>.submit();
	}
}
</script>

<!-- Header Starts -->
<jsp:include page="/Envr/JSP/HeaderCom.jsp" flush="true">
	<jsp:param name="mobFrend" value="B"/>
</jsp:include>
<!-- Header Ends -->

<form name="<%=formName%>">
<input type="hidden" name="mktgHdEs" value="">
<input type="hidden" name="escaMsge" value="">
<input type="hidden" name="crLimFrq" value="">
<input type="hidden" name="sapCusCd" value="">
<input type="hidden" name="openBill" value="">
<input type="hidden" name="splPerFl" value="<%=splPerFl%>">
<div class="container justify-content-center">

<div class="card-body pt-2">
	<div class="row">
		<div class="col-xl-6">
			<div class="d-flex flex-column mb-8 fv-row">
				<!--begin::Input group-->
				<label class="d-flex align-items-center fs-5 fw-bold mb-2">Process Type</label>
				<select name="procType" id="procType" class="form-control" onchange="refreshed()">
					<%=WebSessBean.getProcessType(procType)%>
				</select>
			</div>
		</div>
		
	<div class="col-xl-6">
		<div class="d-flex flex-column mb-8 fv-row">
				<!--begin::Input group-->
					<label class="d-flex align-items-center fs-5 fw-bold mb-2">
						<span class="required">Document No</span>
					</label>
					<div class="input-group input-group-solid mb-5">
						<input type="text" name="docuNumb" id="docuNumb"  class="form-control" value="<%=docuNumb%>" maxlength="16" onchange="refreshed()" autocomplete=off <%=procType.equals("A")?" disabled ":""%>  onfocus='setAccessKey(this, "srchdocuNumb")'>
						<span class="input-group-text cursor-pointer" id="basic-addon2">
							<i class="fas fa-search-plus fs-4" name="srchdocuNumb"  onClick="openLupLoc('')" title="Click here to Look-up Voucher Number, disabled in Add Mode" <%=procType.equals("A")?" disabled ":""%> ></i>
						</span>
					</div>
				<!--end::Input group-->
			</div>
	</div>
<%
try
{
	if (procType.equals("U") || procType.equals("D"))
	{
		sql = "select convert(char(10), a.docuDate, 103), a.custCode,  convert(char(10), strtDate, 103),  convert(char(10), endgDate, 103), adhCrLim, adRemark, b.areaCode, isnull(a.securDep,0) from dptCrLimAdh a with (nolock), dpmCustomer b with (nolock) where a.custCode = b.custCode and a.docuNumb = '" + docuNumb + "' and a.statFlag = 'N' and a.createId = '" + loginIdM + "'";
		rset = WebSessBean.selectRecord(sql);
		if(rset.next())
		{
			docuDate = rset.getString(1);
			custCode = rset.getString(2);
			strtDate = rset.getString(3);
			endgDate = rset.getString(4);
			adhCrLim = rset.getInt(5);
			adRemark = rset.getString(6);
			areaCode = rset.getString(7);
			securDep = rset.getString(8);
			recFound = true;
		}
		else
		{
%>
			<script language="Javascript">
				alert("No Record found of this Document Number"); 
			</script>
<% 
		}
	}
%>
	<div class="col-xl-6">
		<div class="d-flex flex-column mb-8 fv-row">
			<!--begin::Input group-->
			<label class="d-flex align-items-center fs-5 fw-bold mb-2">Area Code</label>
				<select name="areaCode" id="areaCode" class="form-control selectpicker"  data-live-search="true" >
					<%=WebSessBean.getArDesc(areaCode, true)%>
				</select>
			</select>
		</div>
	</div>
	<div class="col-xl-6">
		<div class="d-flex flex-column mb-8 fv-row">
				<!--begin::Input group-->
					<label class="d-flex align-items-center fs-5 fw-bold mb-2">
						<span class="required">Purchaser</span>
					</label>
					<div class="input-group input-group-solid mb-5">
						<input type="text" name="custCode" id="custCode" class="form-control"  maxlength="8" value="<%=custCode%>" onchange="return custCodeChange('G')" autocomplete="off" onfocus='setAccessKey(this, "srchcustCode")'>
						<span class="input-group-text cursor-pointer" id="basic-addon2">
							<i class="fas fa-search-plus fs-4" name='srchcustCode'  onClick="custCodeChange('L')" title="Click here to Look-up Purchaser Code, disabled in Add Mode"></i>
						</span>
					</div>
				<!--end::Input group-->
			</div>
	</div>


<!-- <div class="col-xl-6">
	<div class="d-flex flex-column mb-8 fv-row">
		<div id="custCodeDiv"></div>
		<div id="penalDtlDiv"></div>
		<input type="text" name="penalDtl" value="">
		<input type="hidden" name="securDep" value="<%=securDep%>">
		<input type="hidden" name="proCrLim" value="0">
	</div>
</div> -->

	<div class="col-xl-6">
		<div class="d-flex flex-column mb-8 fv-row">
			<!--begin::Input group-->
			<label class="d-flex align-items-center fs-5 fw-bold mb-2">Start Date</label>
		<input type="text" name="strtDate" id="strtDate" class="form-control" maxlength="10"  onClick='showCal("<%=formName%>", "strtDate")' value="<%=strtDate%>" onChange="return isDate(this, true, '>=today')" onfocus='setAccessKey(this, "calSD")'>
		</div>
	</div>

	<div class="col-xl-6">
		<div class="d-flex flex-column mb-8 fv-row">
			<!--begin::Input group-->
			<label class="d-flex align-items-center fs-5 fw-bold mb-2">Ending Date</label>
			<input type="text" name="endgDate"  id="endgDate" class="form-control" maxlength="10"  onClick='showCal("<%=formName%>", "endgDate")' value="<%=endgDate%>" onChange="return isDate(this, true, '>=today')" onfocus='setAccessKey(this, "calED")'>
		</div>
	</div>

	<div class="col-xl-6">
		<div class="d-flex flex-column mb-8 fv-row">
			<!--begin::Input group-->
			<span><font size="2"><%=alertMsg%></font></span>
		</div>
	</div>

	<div class="col-xl-6">
			<div class="d-flex flex-column mb-8 fv-row">
				<!--begin::Input group-->
				<label class="d-flex align-items-center fs-5 fw-bold mb-2">Adhoc Additional Credit Limit</label>
			<input type="text" name="adhCrLim" class="form-control" value="<%=adhCrLim%>" size="5" maxlength="10" ><!-- onChange="return adhCrLimChk()" -->
		</div>
	</div>

	<div class="col-xl-6">
			<div class="d-flex flex-column mb-8 fv-row">
				<!--begin::Input group-->
				<label class="d-flex align-items-center fs-5 fw-bold mb-2">Reason</label>
			<input type="text" name="adRemark" class="form-control" id="adRemark" value="<%=adRemark%>" size="50" maxlength="100" onChange="return textValidApp(this, 'Reason', true)"> 
		</div>
	</div>
	<div class="col-xl-6">
	<div class="d-flex flex-column mb-8 fv-row">
		<label class="d-flex align-items-center fs-5 fw-bold mb-2">&nbsp</label>
		<div id="custCodeDiv"></div>
		<div id="penalDtlDiv"></div>
		<input type="text" name="penalDtl" value="">
		<input type="hidden" name="securDep" value="<%=securDep%>">
		<input type="hidden" name="proCrLim" value="0">
	</div>
</div>

	<div class="col-xl-12">
		<div class="d-flex flex-column mb-8 fv-row">
			<div align="center">
				<input type="button" name="SUBMIT" value="Submit" class='btn btn-primary' onClick="return submitValid()">
			</div>
		</div>
	</div>
<%
}
catch(Exception e)
{
	throw new Exception("Error in selecting details in " + pageAddress + e.toString());
}
rset = WebSessBean.closeRset(rset);
/*
create table dptCrLimAdh
(
	docuNumb char(16) not null,
	docuDate smalldatetime not null,
	custCode char(8) not null,
	strtDate smalldatetime not null,
	endgDate smalldatetime not null,
	adhCrLim numeric not null,
	adRemark varchar(100) not null,
	statFlag char(1) not null,
	pendWith varchar(10) not null,
	appAuths varchar(50) not null,
	createId varchar(10) not null,
	createDt smalldatetime not null,
	updateId varchar(10),
	updateDt smalldatetime
constraint pk_dptCrLimAdh primary key (docuNumb)
)
*/
%>

</div>
</div>
</div>

</div>
</div>

<!-- Form footer Starts --->
<jsp:include page="/Envr/JSP/FooterCom.jsp" flush="true"/>
<!-- Form footer Ends --->
</form>

