using Microsoft.AspNetCore.Mvc;
using sparshWebService.DataAccess;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

namespace sparshWebService.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    [Produces("application/json")]
    public class ActivityEntryController : ControllerBase
    {
        private readonly DatabaseHelper _db;
        private const string DocuTypeActivity = "AEF";

        public ActivityEntryController(DatabaseHelper db)
        {
            _db = db;
        }

        // ======================================
        // POST: /api/ActivityEntry/save
        // ======================================
        [HttpPost("save")]
        [Consumes("application/json")]
        public IActionResult Save([FromBody] ActivityEntryRequest? request)
        {
            if (request == null)
                return BadRequest(new { success = false, message = "Request body is required." });

            try
            {
                if (string.IsNullOrWhiteSpace(request.ProcessType))
                    return BadRequest(new { success = false, message = "processType is required." });

                if (string.IsNullOrWhiteSpace(request.ActivityName))
                    return BadRequest(new { success = false, message = "activityName is required." });

                if (string.IsNullOrWhiteSpace(request.ActivityDate))
                    return BadRequest(new { success = false, message = "activityDate is required." });

                if (string.IsNullOrWhiteSpace(request.MeetingVenue))
                    return BadRequest(new { success = false, message = "meetingVenue is required." });

                if (string.IsNullOrWhiteSpace(request.CityName))
                    return BadRequest(new { success = false, message = "cityName is required." });

                if (string.IsNullOrWhiteSpace(request.LoginId))
                    return BadRequest(new { success = false, message = "loginId is required." });

                var processType = request.ProcessType.Trim();
                var loginId = Cut(request.LoginId, 10);
                var userRole = Cut(request.UserRole, 1);

                if (processType.Equals("Add", StringComparison.OrdinalIgnoreCase) &&
                    string.IsNullOrWhiteSpace(request.AreaCode))
                {
                    return BadRequest(new { success = false, message = "areaCode is required for Add." });
                }

                string docuNumb;

                if (processType.Equals("Add", StringComparison.OrdinalIgnoreCase))
                {
                    // Generate new docuNumb from wcpDocNoGen (NO fincYear in C#)
                    string? genDoc = GenerateDocuNumb(DocuTypeActivity, request.AreaCode ?? "");

                    if (string.IsNullOrWhiteSpace(genDoc))
                        return StatusCode(500, new { success = false, message = "Could not generate document number." });

                    docuNumb = genDoc.Trim();
                }
                else
                {
                    if (string.IsNullOrWhiteSpace(request.DocuNumb))
                        return BadRequest(new { success = false, message = "docuNumb is required for Update." });

                    docuNumb = request.DocuNumb.Trim();
                }

                // ---------- Common mapping ----------
                DateTime actvDate = ParseDateOrToday(request.ActivityDate);
                DateTime meetDate = actvDate;

                string docuMnth = actvDate.ToString("yyyyMM"); // char(6)
                string maturtMn = docuMnth;

                int empCnt = SafeToInt(request.EmployeesCount);
                int chnCnt = SafeToInt(request.ChannelPartnerCount);
                int infCnt = SafeToInt(request.InfluencerCount);
                int totalCnt = SafeToInt(request.TotalParticipants);

                if (totalCnt <= 0)
                    totalCnt = empCnt + chnCnt + infCnt;

                int noOfPart = totalCnt;
                int noOfEnqu = 0;
                int noOfVist = 0;
                int potnInMT = 0;

                string empPrsLs = "";
                if (request.Employees != null && request.Employees.Any())
                {
                    empPrsLs = string.Join(",",
                        request.Employees
                            .Select(e => e?.EmployeeCode ?? e?.Name)
                            .Where(s => !string.IsNullOrWhiteSpace(s))
                            .Select(s => s!.Trim()));
                }

                string prodCtLs = request.Product ?? "";
                string actvRmrk = request.Description ?? "";

                string actvCity = request.CityName ?? "";
                string district = request.District ?? "";
                string pinCodeN = request.PinCode ?? "";

                string meetVenu = request.MeetingVenue ?? "";
                string mobileNo = "";   // not present in Flutter now
                string emailAdd = "";   // not present in Flutter now
                string contPers = "";   // not present in Flutter now
                string rejcRmrk = "";
                string statFlag = "N";

                string locaCapr = meetVenu; // can store venue as caption
                string latitute = request.Latitude ?? "";
                string lgtitute = request.Longitude ?? "";
                string areaCode = request.AreaCode ?? "";

                // Emp present as one string (limit to DB length)
                empPrsLs = Cut(empPrsLs, 100);
                prodCtLs = Cut(prodCtLs, 50);
                actvRmrk = Cut(actvRmrk, 200);
                actvCity = Cut(actvCity, 40);
                district = Cut(district, 30);
                pinCodeN = Cut(pinCodeN, 6);
                meetVenu = Cut(meetVenu, 50);
                locaCapr = Cut(locaCapr, 250);
                latitute = Cut(latitute, 50);
                lgtitute = Cut(lgtitute, 50);
                areaCode = Cut(areaCode, 3);

                // ---------- Insert / Update header ----------
                if (processType.Equals("Add", StringComparison.OrdinalIgnoreCase))
                {
                    const string insertHeaderSql = @"
INSERT INTO dbo.catActPreSl
(
    docuNumb, docuMnth, actvDate, meetDate,
    actvName, caaActTy, caaObjTy,
    actvCity, district, pinCodeN,
    noOfPart, noOfEnqu, noOfVist,
    prodCtLs, empPrsLs, actvRmrk,
    meetVenu, caaPrjTy,
    mobileNo, emailAdd, contPers,
    potnInMT, maturtMn, rejcRmrk,
    statFlag, createId, createDt,
    locaCapr, latitute, lgtitute,
    areaCode, userRole
)
VALUES
(
    @docuNumb, @docuMnth, @actvDate, @meetDate,
    @actvName, @caaActTy, @caaObjTy,
    @actvCity, @district, @pinCodeN,
    @noOfPart, @noOfEnqu, @noOfVist,
    @prodCtLs, @empPrsLs, @actvRmrk,
    @meetVenu, @caaPrjTy,
    @mobileNo, @emailAdd, @contPers,
    @potnInMT, @maturtMn, @rejcRmrk,
    @statFlag, @createId, GETDATE(),
    @locaCapr, @latitute, @lgtitute,
    @areaCode, @userRole
);";

                    var headerParams = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = Cut(docuNumb, 16),
                        ["@docuMnth"] = Cut(docuMnth, 6),
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = Cut(request.ActivityName ?? "", 100),

                        ["@caaActTy"] = "",   // no mapping from Flutter now
                        ["@caaObjTy"] = "",   // no mapping from Flutter now

                        ["@actvCity"] = actvCity,
                        ["@district"] = district,
                        ["@pinCodeN"] = pinCodeN,

                        ["@noOfPart"] = noOfPart,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,

                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,

                        ["@meetVenu"] = meetVenu,
                        ["@caaPrjTy"] = "",   // no mapping

                        ["@mobileNo"] = mobileNo,
                        ["@emailAdd"] = emailAdd,
                        ["@contPers"] = contPers,

                        ["@potnInMT"] = potnInMT,
                        ["@maturtMn"] = Cut(maturtMn, 6),
                        ["@rejcRmrk"] = rejcRmrk,

                        ["@statFlag"] = statFlag,
                        ["@createId"] = loginId,

                        ["@locaCapr"] = locaCapr,
                        ["@latitute"] = latitute,
                        ["@lgtitute"] = lgtitute,
                        ["@areaCode"] = areaCode,
                        ["@userRole"] = userRole
                    };

                    _db.QaEWebBean(insertHeaderSql, headerParams);
                }
                else
                {
                    // UPDATE
                    const string updateHeaderSql = @"
UPDATE dbo.catActPreSl
SET
    actvDate = @actvDate,
    meetDate = @meetDate,
    actvName = @actvName,
    actvCity = @actvCity,
    district = @district,
    pinCodeN = @pinCodeN,
    noOfPart = @noOfPart,
    noOfEnqu = @noOfEnqu,
    noOfVist = @noOfVist,
    prodCtLs = @prodCtLs,
    empPrsLs = @empPrsLs,
    actvRmrk = @actvRmrk,
    meetVenu = @meetVenu,
    latitute = @latitute,
    lgtitute = @lgtitute,
    areaCode = @areaCode,
    userRole = @userRole,
    updateId = @updateId,
    updateDt = GETDATE()
WHERE docuNumb = @docuNumb;";

                    var updParams = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = Cut(docuNumb,16),
                        ["@actvDate"] = actvDate,
                        ["@meetDate"] = meetDate,
                        ["@actvName"] = Cut(request.ActivityName ?? "", 100),
                        ["@actvCity"] = actvCity,
                        ["@district"] = district,
                        ["@pinCodeN"] = pinCodeN,
                        ["@noOfPart"] = noOfPart,
                        ["@noOfEnqu"] = noOfEnqu,
                        ["@noOfVist"] = noOfVist,
                        ["@prodCtLs"] = prodCtLs,
                        ["@empPrsLs"] = empPrsLs,
                        ["@actvRmrk"] = actvRmrk,
                        ["@meetVenu"] = meetVenu,
                        ["@latitute"] = latitute,
                        ["@lgtitute"] = lgtitute,
                        ["@areaCode"] = areaCode,
                        ["@userRole"] = userRole,
                        ["@updateId"] = loginId
                    };

                    _db.QaEWebBean(updateHeaderSql, updParams);

                    // delete old detail and reinsert
                    const string deleteDtlSql = @"DELETE FROM dbo.catActPreSlDtl WHERE docuNumb = @docuNumb;";
                    _db.QaEWebBean(deleteDtlSql, new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = Cut(docuNumb,16)
                    });
                }

                // ---------- Insert detail (employees, painters, channel partners) ----------
                InsertDetails(docuNumb, loginId, request);

                return Ok(new
                {
                    success = true,
                    message = "Activity saved successfully.",
                    docuNumb,
                    timestamp = DateTime.Now
                });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new
                {
                    success = false,
                    message = "Error while saving activity.",
                    error = ex.Message,
                    timestamp = DateTime.Now
                });
            }
        }

        // ======================================
        // Helper: Insert detail rows (no transaction)
        // ======================================
        private void InsertDetails(string docuNumb, string createId, ActivityEntryRequest request)
        {
            const string insertDtlSql = @"
INSERT INTO dbo.catActPreSlDtl
(
    docuNumb, attnType, attnCode,
    statFlag, createId, createDt
)
VALUES
(
    @docuNumb, @attnType, @attnCode,
    @statFlag, @createId, GETDATE()
);";

            string doc = Cut(docuNumb, 16);

            // Employees -> attnType = 'E'
            if (request.Employees != null)
            {
                foreach (var e in request.Employees)
                {
                    if (e == null) continue;
                    if (string.IsNullOrWhiteSpace(e.EmployeeCode) &&
                        string.IsNullOrWhiteSpace(e.Name))
                        continue;

                    string code = !string.IsNullOrWhiteSpace(e.EmployeeCode)
                        ? e.EmployeeCode!
                        : (e.Name ?? "");

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = doc,
                        ["@attnType"] = "E",
                        ["@attnCode"] = Cut(code, 10),
                        ["@statFlag"] = "N",
                        ["@createId"] = Cut(createId, 10)
                    };

                    _db.QaEWebBean(insertDtlSql, p);
                }
            }

            // Channel Partners -> attnType = 'C'
            if (request.ChannelPartners != null)
            {
                foreach (var c in request.ChannelPartners)
                {
                    if (c == null) continue;
                    if (string.IsNullOrWhiteSpace(c.PurchaserCode) &&
                        string.IsNullOrWhiteSpace(c.Mobile) &&
                        string.IsNullOrWhiteSpace(c.Name))
                        continue;

                    string code = !string.IsNullOrWhiteSpace(c.PurchaserCode)
                        ? c.PurchaserCode!
                        : (!string.IsNullOrWhiteSpace(c.Mobile) ? c.Mobile! : (c.Name ?? ""));

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = doc,
                        ["@attnType"] = "C",
                        ["@attnCode"] = Cut(code, 10),
                        ["@statFlag"] = "N",
                        ["@createId"] = Cut(createId, 10)
                    };

                    _db.QaEWebBean(insertDtlSql, p);
                }
            }

            // Painters / Contractors / Applicators -> attnType = 'I'
            if (request.Painters != null)
            {
                foreach (var pnt in request.Painters)
                {
                    if (pnt == null) continue;
                    if (string.IsNullOrWhiteSpace(pnt.Mobile) &&
                        string.IsNullOrWhiteSpace(pnt.Name))
                        continue;

                    string code = !string.IsNullOrWhiteSpace(pnt.Mobile)
                        ? pnt.Mobile!
                        : (pnt.Name ?? "");

                    var p = new Dictionary<string, object?>
                    {
                        ["@docuNumb"] = doc,
                        ["@attnType"] = "I",
                        ["@attnCode"] = Cut(code, 10),
                        ["@statFlag"] = "N",
                        ["@createId"] = Cut(createId, 10)
                    };

                    _db.QaEWebBean(insertDtlSql, p);
                }
            }
        }

        // ======================================
        // Helper: Generate doc number via wcpDocNoGen (NO fincYear in C#)
        // ======================================
        private string? GenerateDocuNumb(string docuType, string areaCode)
        {
            const string sql = @"EXEC dbo.wcpDocNoGen @docuType, @areaCode;";

            var p = new Dictionary<string, object?>
            {
                ["@docuType"] = docuType,
                ["@areaCode"] = (areaCode ?? "").Trim()
            };

            var rows = _db.QaEWebBean(sql, p);
            var row = rows?.FirstOrDefault();

            if (row == null)
                return null;

            string? docuNumb = null;

            if (row.ContainsKey("docuNumb"))
            {
                docuNumb = row["docuNumb"]?.ToString();
            }
            else
            {
                // Fallback: first non-null value
                docuNumb = row.Values.FirstOrDefault(v => v != null)?.ToString();
            }

            return string.IsNullOrWhiteSpace(docuNumb) ? null : docuNumb.Trim();
        }

        // ======================================
        // Small helpers
        // ======================================
        private static string Cut(string? s, int max)
        {
            if (string.IsNullOrWhiteSpace(s)) return "";
            var t = s.Trim();
            return t.Length <= max ? t : t.Substring(0, max);
        }

        private static DateTime ParseDateOrToday(string? s)
        {
            if (string.IsNullOrWhiteSpace(s))
                return DateTime.Today;

            var formats = new[]
            {
                "yyyy-MM-dd","dd/MM/yyyy","MM/dd/yyyy",
                "yyyy/MM/dd","dd-MM-yyyy","MM-dd-yyyy",
                "yyyyMMdd","ddMMyyyy"
            };

            foreach (var f in formats)
            {
                if (DateTime.TryParseExact(s, f, CultureInfo.InvariantCulture,
                    DateTimeStyles.None, out var dt))
                    return dt;
            }

            if (DateTime.TryParse(s, out var any))
                return any;

            return DateTime.Today;
        }

        private static int SafeToInt(int? v) => v ?? 0;
    }

    // =========================
    // DTOs (inside same file)
    // =========================
    public sealed class ActivityEntryRequest
    {
        public string? ProcessType { get; set; }   // "Add" / "Update"
        public string? DocuNumb { get; set; }      // For update

        public string? ActivityName { get; set; }  // Painter Meet / Contractor Meet / Applicator Meet
        public string? Description { get; set; }
        public string? ActivityDate { get; set; }  // yyyy-MM-dd from Flutter
        public string? MeetingVenue { get; set; }  // Address
        public string? CityName { get; set; }
        public string? District { get; set; }
        public string? PinCode { get; set; }

        public string? AreaCode { get; set; }      // e.g. DUB, RAK (code from dropdown)
        public string? Product { get; set; }       // Wall Care Putty
        public string? Latitude { get; set; }
        public string? Longitude { get; set; }

        public string? LoginId { get; set; }       // createId from Flutter
        public string? UserRole { get; set; }      // 'S', 'P', etc.

        public int? EmployeesCount { get; set; }
        public int? ChannelPartnerCount { get; set; }
        public int? InfluencerCount { get; set; }
        public int? TotalParticipants { get; set; }

        public List<EmployeeDto>? Employees { get; set; }
        public List<PainterDto>? Painters { get; set; }
        public List<ChannelPartnerDto>? ChannelPartners { get; set; }
    }

    public sealed class EmployeeDto
    {
        public string? EmployeeCode { get; set; }
        public string? Name { get; set; }
        public string? Mobile { get; set; }
    }

    public sealed class PainterDto
    {
        public string? Type { get; set; }   // Painter / Contractor / Applicator
        public string? Mobile { get; set; }
        public string? Name { get; set; }
    }

    public sealed class ChannelPartnerDto
    {
        public string? Type { get; set; }         // Authorised dealer / Stockist / etc.
        public string? PurchaserCode { get; set; }
        public string? Mobile { get; set; }
        public string? Name { get; set; }
    }
}
