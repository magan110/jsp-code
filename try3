<%@ include file="/Envr/JSP/SecurityCom.jsp"%>
<%@ include file="/Envr/Login/LYPEnvrSet.jsp"%>

<%
CallableStatement cstmt = null;
ResultSet rset = null;

boolean dbSubmit = false,
		sysOutFl = true;

if (sysOutFl)
{
	LypSessBean.setSqlToDsp(true);
//	WebSessBean.setSqlToDsp(true);
}

if (sysOutFl) // System.out.println("In Token Scanning 1");

String  sql = "",
		custCode = XssFilter.parSmGet("custCode"),
		tokenNum = "",
		areaCode = log.getArCode(),
		inflCode = "INF00000",
		inflName = "Anuhit",
		mobileNo = "9798000000",
		naration = "",
		cheqNumb = "",
		dbTknNum = "",
		tokenNuH = "",
		randNumb = "",
		cheqDate = "",
		cnDnTyCd = "",
		refDocNo = "",
		exprFlag = "",
		locMsgDs = "",
		tokenNumStr = "",
		inflCodeStr = "",
		srNumber[] = XssFilter.parArGet("srNumber"),
		dpTKNIns = (String) session.getAttribute("dpTKNIns");

int 	trnIndex = 0;
		String trnTrail = "";

		String  msg = "",
				procType = "",
				docuType = "TKN",
				cdnDocTy = "CRN",
				tokenVld = "",
				tokenIdn = "",
				wrongStr = "",
				rightStr = "",
				custAcCd = "01",
				deducStr = "",
				docuNumb = "",
				bcTknTyp = "",
				dbActSts = "",
				invDocNo = "",
				invnSrNo = "",
				bcTknSav = "",
				mdOfDisb = "",
				scnMlStt = "",
				updIdAct = "",
				updIdMlt = "",
				updateId = "",
				tralhist = "",
				toknHsty = "",
				statFlag = "A",
				prodCodeArr[] = {"","","","","","","",""}, 
				docuDate = WebSessBean.mnthEnDtGet(docuType);
		int 	wrongEnt = 0,
				rightEnt = 0,
				rightCnt = 0,
				scnMlCnt = 0,
				scnMlAlw = 0,
				sysOutId = 0,
				alrdyScn = 0,
				prodCode = 0,
				prdCount = 0,
				prodCodeHd = 0,
				wrongCnt = 0;

		double  payblAmt = 0,
				basTknAm = 0,
				handAmnt = 0,
				tokenVal = 0,
				scnDedAm = 0,
				scnrDdLf = 0,
				handRate = 0,
				scnrDdRt = 0,
				scDdAmCl = 0,
				discQnty = 0,
				discRate = 0,
				tdsTotAm = 0,
				tokEndVl = 0;

		boolean prdFound = false,
				webLogin = false;


if(XssFilter.parSmGet("areaCode") != null)
	areaCode = XssFilter.parSmGet("areaCode");

if(XssFilter.parSmGet("randNumb") != null)
	randNumb = XssFilter.parSmGet("randNumb");

 //// System.out.println("In Token Scanning 1 " + custCode);
if (sysOutFl) 
	// System.out.println("In Token Scanning 2 " + custCode);
try
{
	if (sysOutFl) // System.out.println("In Token Scanning 3 " + loginIdM + " dpTKNIns : " + dpTKNIns);

	if(dpTKNIns == null || (dpTKNIns != null && dpTKNIns.equals("Y")))
	{
		dbSubmit = true;
		throw new Exception("Duplicate Entry, please open fresh page from menu and try again " + loginIdM);
	}

	if (sysOutFl) // System.out.println("In Token Scanning 4 " + loginIdM + " " + dbSubmit);

	session.setAttribute("dpTKNIns", "Y");
	sql = "set dateformat YMD";
	LypSessBean.updateRecord(sql);
	
	areaCode = log.getArCode();
	userType = log.getUserType();


	LypSessBean.setAutoCommit(false);
//	WebSessBean.setAutoCommit(false);

	if (sysOutFl) // System.out.println("In Token Scanning 5 " + loginIdM + " " + dbSubmit);
	docuNumb = WebSessBean.getDocumentNo(docuType, areaCode);
//	WebSessBean.setAutoCommit(false);
	
	if(!randNumb.equals(""))
	{
		sql = "update dptTknTestg set docuNumb = '" + docuNumb + "' where uniqueId = '" + randNumb + "' and createDt > getdate()-1 ";
		LypSessBean.updateRecord(sql);
	}
	if (sysOutFl) // System.out.println("In Token Scanning 6 " + loginIdM + " " + dbSubmit);
	for(int i=0; i<srNumber.length; i++)
	{
		if(XssFilter.parSmGet("tokenNum" + srNumber[i]) != null)
		{
			tokenNum = XssFilter.parSmGet("tokenNum" + srNumber[i]).trim();
			
			if(!tokenNuH.equals("") && tokenNuH.equals(tokenNum))	// Added By Rajendra For Cross Duplicate Validation
			{
				tokenNum = ""; 
			}
			tokenNuH = tokenNum;
		}
		else 
			tokenNum = "";
		
		if (sysOutFl)// System.out.println( "inflCode" + inflCode );

		if(!tokenNum.equals(""))
		{
			tralhist += " <br> Token No : " + tokenNum;
			toknHsty += "," + tokenNum;
			sql = " insert into dpmTknTestg (docuNumb, tokenNum,mobileNo,inflName,inflCode,createId,createDt) values("  
				+ " '" + docuNumb + "',"
				+ " '" + tokenNum + "',"
				+ " '" + mobileNo + "',"
				+ " '" + inflName + "',"
				+ " '" + inflCode + "',"
				+ " '" + loginIdM + "',"
				+ " getdate())";
	//		// System.out.println(sql);
			LypSessBean.updateRecord(sql);

			bcTknTyp = "";
			bcTknSav = "";
			updateId = "";
			prodCode = 0;
			tokenVal = 0;
			handRate = 0;
			scnrDdRt = 0;
			tokEndVl = 0;
		//	// System.out.println("3");
			
			sql = "exec bwlive.dbo.dppToknProc 'jav01', '" + tokenNum + "', 0";
			rset = LypSessBean.selectRecord(sql);
			if(rset.next())
			{
				bcTknTyp = rset.getString(1);
				tokenVal = rset.getDouble(2);
				handRate = rset.getDouble(3);
				scnrDdRt = rset.getDouble(4);
				tokEndVl = rset.getDouble(5);
				prodCode = rset.getInt(6);
				updateId = rset.getString(7);
				dbActSts = rset.getString(8);
				exprFlag = rset.getString(9);

				bcTknSav = bcTknTyp;
				if (sysOutFl)// System.out.println((++sysOutId) + " In Rset . bcTknTyp : " + bcTknTyp + ". tokenVal : " + tokenVal + ". prodCode : " + prodCode + ". updateId : " + updateId);
			}
			trnTrail += "\n" + (++trnIndex) + ". Token Valid Flag Java " + tokenVld;
			 /** Changes Done by RajendrA 19 Dec 2022 **/
			
			
			tralhist += " <br> bcTknTyp No : " + bcTknTyp;

			scnMlStt = "";
			scnMlCnt = 0;

		   if(!exprFlag.equals("Y"))
		   {
				sql = "select b.isActive, b.scnMlCnt, b.scnMlAlw, isNull(b.updateId, '') from dpmToknMlSc b with (nolock) where b.tokenNum = '" + tokenNum + "' and b.isActive='Y' and b.scnMlCnt < b.scnMlAlw";
				rset = LypSessBean.selectRecord(sql);
			//	// System.out.println(sql);
				if(rset.next())
				{
					scnMlStt = rset.getString(1);
					scnMlCnt = rset.getInt(2);
					scnMlAlw = rset.getInt(3);
					updIdMlt = rset.getString(4).trim();

					if(updateId.equals(loginIdM) && scnMlStt.equals("Y"))
					{
						scnMlStt = "";
						scnMlCnt = 0;
					}
				}

				sql = "update dpmTokenNos set isActive = 'Z', updateId = '" + loginIdM + "', updateDt=getdate() where tokenNum = '" + tokenNum + "' and case when getdate() > dbo.dpfTknValDt('" + bcTknSav + "','" + areaCode + "') then cast(getdate() - printgDt as smallint) else 1 end <= validDay + dbo.dpfTknValDy('" + bcTknSav + "','" + areaCode + "') "; 

				if(scnMlCnt == 0)
					sql += "and isActive = 'Y'";
				else
					sql += "and isActive = 'Z'";

				int updatCnt = LypSessBean.updateRecord(sql);
				trnTrail += "\n" + (++trnIndex) + ". Token Master updated " + updatCnt + " " + sql;
			//	// System.out.println(sql);
				if(updatCnt > 0 || !scnMlStt.equals(""))
				{
					/** Changes Done by RajendrA 19 Dec 2022 **/
					if(!scnMlStt.equals(""))
					{
						scnMlCnt++;
						if(scnMlCnt == scnMlAlw)
							scnMlStt = "Z";
						else
							scnMlStt = "Y";

						sql = "update dpmToknMlSc set isActive = '" + scnMlStt + "', scnMlCnt = '" + scnMlCnt + "', updateId = '" + loginIdM + "', updateDt = getdate() where tokenNum = '" + tokenNum + "' and isActive='Y'"; 
						updatCnt = LypSessBean.updateRecord(sql);
					//	// System.out.println("11");
						if(updatCnt <= 0)
						{
							trnTrail += "\n" + (++trnIndex) + ". dpmToknMlSc not updated " + updatCnt + " " + sql;
							throw new Exception("Please Contact to IT Birlawhite, Token Status not updated for Token No " + tokenNum);
						}
					}
					
					if(prodCode > 0)
					{
						trnTrail += "\n" + (++trnIndex) + ". Token Master selected " + sql;

						basTknAm += tokenVal;
						payblAmt += tokEndVl;
						handAmnt += handRate;
						scDdAmCl += scnrDdRt;
						tokenVld = "Y";
						rightEnt++;
					}
					else
					{
						throw new Exception("Please Contact to IT Birlawhite, Token Rate not updated for Token No " + tokenNum);
					}
				}
				else
				{
					// Added By Rajendra / Navin for Remove block of already scan token

					sql = " select tokenNum from dpmTokenNos with (nolock) where tokenNum = '" + tokenNum + "' and isActive in ('Z','X','Y') union all select tokenNum from dpaTokenNos with (nolock) where tokenNum = '" + tokenNum + "' and isActive in ('Z','X','Y') ";
					rset = LypSessBean.selectRecord(sql);
				//	// System.out.println("12");
					if(rset.next())
					{
						dbTknNum = rset.getString(1);
					}
					
					if(dbTknNum.equals(""))
					{
						wrongEnt++;		
						dbTknNum = "";
					}
					else
					{
						alrdyScn++;
					}
					wrongStr += ", " + tokenNum;
					tokenVld = "N";
				}
		   }
		   else
		   {
			   tokenVld = "N";
			 //  tokenVal = 0;
			 //  handRate = 0;
			 //  tokEndVl = 0;
		   }
			tralhist += " <br> insert into dptTokenRecDtl before ";
			
			sql = "insert into dptTokenRecDtl (docuNumb, tokenNum, tokenVld, exprFlag, toknStat, bcTknTyp, tokenVal, handRate, tokEndVl, prodCode, inflCode, statFlag, createId, createDt) values ("
				+ "'" +	docuNumb + "', "
				+ "'" + tokenNum + "', "
				+ "'" + tokenVld + "', "
				+ "'" + exprFlag + "', "
				+ "'" + dbActSts + "', "
				+ "'" + bcTknTyp + "', "
				+ "'" + tokenVal + "', "
				+ "'" + handRate + "', "
				+ "'" + tokEndVl + "', "
				+ "'" + prodCode + "', "
				+ "'" + inflCode + "', "
				+ "'" + statFlag + "', "
				+ "'" + loginIdM + "', "
				+ "getdate())";

			LypSessBean.updateRecord(sql);
			tralhist += " <br> inserted into dptTokenRecDtl ";
		//	// System.out.println(sql);
			trnTrail += "\n" + (++trnIndex) + ". Detail Inserted " + sql;
		}
		payblAmt -= scnDedAm;
		prodCodeHd = prodCode;
	}

	sql = "insert into cdtTokenRec (docuNumb, docuDate, tokenTyp, cdnDocTy, custCode, prodCode, recptQty, basTknAm, handAmnt, scnDedAm, payblAmt, statFlag, createId, createDt) values("
		+ "'" +	docuNumb + "', "
		+ "'" +	LypSessBean.dmyTOymd(docuDate) + "', "
		+ "'BC', "
		+ "'" + cdnDocTy + "', "
		+ "'" + custCode + "', "
		+ "0, 0, 0, 0, "
		+ "0, 0, "
		+ "'" + statFlag + "', "
		+ "'" + loginIdM + "', "
		+ "getdate())";
	LypSessBean.updateRecord(sql);
//	// System.out.println(sql);

	sql = "update cdtTokenRec set recptQty = " + rightEnt + ", basTknAm = " + basTknAm + ", handAmnt = " + handAmnt + ", payblAmt = " + payblAmt + ", scnDedAm = " + scnDedAm + ", prodCode = " + prodCodeHd + ", updateId = '" + loginIdM + "', updateDt = getdate()   where docuNumb = '" + docuNumb + "'";
	int j = LypSessBean.updateRecord(sql);

	if (j < 1)
	{
		throw new Exception("No Record found in Header, Contact IT Dept, Birla White");
			//trnTrail += "\n" + (++trnIndex) + ". Header Updated after Detail Insertion " + loginIdM + " " + sql;
	}

	if(userType.equals("R"))
		mdOfDisb = "01";
	else
		mdOfDisb = "04";
			
	if(payblAmt > 0)
	{
		discQnty = rightEnt;
		discRate = tokEndVl;
		cnDnTyCd = "11";
		naration = "Paper Token Receipt Entry for " + rightEnt + " Qty";
		mdOfDisb = mdOfDisb;
		
		if(bcTknTyp.equals("E1"))
		{
			refDocNo = "NA";
		}
		
		sql = "insert into cdtCusToPay (docuNumb, custCode, custAcCd, cdnDocTy, invDocNo, invnSrNo, prodCode, strtDate, endgDate, discQnty, discRate, dtlSbTot, deducAmt, tdsTotAm, cnDnTyCd, naration, mdOfDisb, statFlag, createId, createDt, cheqNumb, cheqDate, refDocNo) values ("
			+ "'" + docuNumb + "', "
			+ "'" + custCode + "', "
			+ "'" + custAcCd + "', "
			+ "'" + cdnDocTy + "', "
			+ "'" + invDocNo + "', "
			+ "'" + invnSrNo + "', "
			+ "'" + prodCode + "', "
			+ "'" + LypSessBean.dmyTOymd(docuDate) + "', "
			+ "'" + LypSessBean.dmyTOymd(docuDate) + "', "
			+ "'" + discQnty + "', "
			+ "'" + discRate + "', "
			+ "'" + (payblAmt + scnDedAm) + "', "
			+ "'" + scnDedAm + "', "
			+ "'" + tdsTotAm + "', "
			+ "'" + cnDnTyCd + "', "
			+ "'" + naration + "', "
			+ "'" + mdOfDisb + "', "
			+ "'" + statFlag + "', "
			+ "'" + loginIdM + "', ";

		sql += "getdate(), ";

		if (cheqNumb.equals(""))
			sql += "null, ";
		else
			sql += "'" + cheqNumb + "', ";

		if (cheqDate.equals(""))
			sql += "null, ";
		else
			sql += "'" + cheqDate + "', ";

		if (refDocNo.equals(""))
			sql += "null, ";
		else
			sql += "'" + refDocNo + "', ";

	//	sql = sql.substring(0, sql.length() - 2) + ")";
	//	WebSessBean.updateRecord(sql);
	//	// System.out.println(sql);
	}
	
	/*
	sql = "select isNull(sum(case when b.tokenVld = 'Y' then 1 else 0 end), 0) as rightCnt, isNull(sum(case when b.tokenVld <> 'Y' then 1 else 0 end), 0) as wrongCnt from cdtTokenRec a with (nolock), dptTokenRecDtl b with (nolock) where a.docuNumb = b.docuNumb and a.docuNumb = '" + docuNumb + "' and b.statFlag not in ('C', 'R')";
	rset = WebSessBean.selectRecord(sql);
	if(rset.next())
	{
		rightCnt = rset.getInt(1);
		wrongCnt = rset.getInt(2);
	}
			
	trnTrail += "\n" + (++trnIndex) + ". rightEnt " + rightEnt + ". rightCnt " + rightCnt + ". wrongEnt " + wrongEnt + ". wrongCnt " + wrongCnt;
	*/		
	WebSessBean.setDocumentNo(docuType, areaCode);

	if(scnDedAm > 0) // for Retailer and customer both
	{
		sql = "insert into dptToknScnrDtl (docuNumb, docuDate, userCode, docuNarr, vouDrAmt, vouCrAmt, statFlag, createId, createDt) values ("
		+ "'" +	docuNumb + "', " 
		//+ "'" + dmyTOymd(docuDate) + "', "
		+ "'" + custCode + "', "
		+ "'Dedc. against Scanner Issued, amount left " + scnrDdLf + "', "
		+ " 0, "
		+ " " + scnDedAm + ", "
		+ " 'N', "
		+ "'" + loginIdM + "', "
		+ "getdate())";
		LypSessBean.updateRecord(sql);
	//	// System.out.println(sql);
		deducStr = ",Amount deducted for scanner " + scnDedAm + ", remaining amount " + scnrDdLf;
	}

	trnTrail += "\n" + (++trnIndex) + ". Header Updated after Detail Insertion " + sql;

	if(wrongEnt > 10)
	{
		sql = "update wcmUserCred set blckedDt = getdate(), updateId = '" + loginIdM + "', updateDt = getdate() where loginIdM ='" + loginIdM + "'";
		LypSessBean.updateRecord(sql);
	}
		
	if(wrongStr.trim().equals(""))
		wrongStr = "None";


	msg += "@br@ Your Batch No is : " + docuNumb + " @br@ Token Value is " + basTknAm + " @br@ Right Entries  : " + rightEnt + " @br@ Wrong Entries : " + alrdyScn + deducStr + " @br@ Payble Amt " + payblAmt; 

	if (sysOutFl) // System.out.println("msg" + msg);
	msg = "@br@Your Request has been Processed! @br@" + msg;
	

	if(!userType.equals("R")) 	
	{
		msg += ", @br@Credit Note will be generated at the end of the day.";
	}
	// // System.out.println(trnTrail);
	
	tralhist += " <br> End ";

//	if(rightCnt != rightEnt)
//	{
//		 sql = "insert into cotMailSend (sentFlag, emailTos, emailCcs, emailBcc, emailSub, emailBdy, bodyFrmt, createDt)"
//			 + " select 'N', 'rajendra.sikhwal@adityabirla.com', '', '', 'Token Scanning of : " + loginIdM + ". Document No //: " + docuNumb + "', '" + tralhist + " <br> " + toknHsty + "', 'HTML', getdate() ";
//		
//	 //// System.out.println(sql);
//		WebSessBean.updateRecord(sql);
//	}

//	if(rightCnt != rightEnt)
//	{
//		WebSessBean.rollbackConn();
//		LypSessBean.rollbackConn();
//		throw new Exception("Due to some technical issue, Data not Saved. Please re-scan and check. Birla White");
//	//	trnTrail += "\n" + (++trnIndex) + ". Header Updated after Detail Insertion " + loginIdM + " " + sql;
//	}
//	// System.out.println("Transaction End " + docuNumb);
//	WebSessBean.setDocumentNo(docuType, areaCode);

	// WebSessBean.rollbackConn();
	// LypSessBean.rollbackConn();


//	WebSessBean.commitConn();
	LypSessBean.commitConn();
//	WebSessBean.commitConn();
	
	locMsgDs += "\n" + (++trnIndex) + ". commited with message " + msg;
	trnIndex = 0;
	response.sendRedirect("TknScanDtl.jsp?savPagFl=Y&erMsgRtn=" + msg + "");
	//response.sendRedirect(errorPage + "?message=" + msg);
}
catch (Exception e)
{
	//if (!dbSubmit) // Commented 03-Feb-20 To review for Header Fields not updated in cdtTokenRec 
	WebSessBean.rollbackConn();
	LypSessBean.rollbackConn();
	session.setAttribute("dpTKNIns", "N");
	locMsgDs += "\n" + (++trnIndex) + ". Rollback with Error " + e.toString();
	throw new Exception("Error in updating details in " + pageAddress + e.toString());
}
finally
{
//	WebSessBean.rollbackConn();
//	LypSessBean.rollbackConn();

//	if(trnIndex > 0)
//		JSPMail.setAll("sqladmn@adityabirla.com", "vaibhav.jain@adityabirla.com", "", "Bar Code Token Scanning of : " + loginIdM, LypSessBean.trnTrailGet() +  locMsgDs, "", "");
	UtilBean.sessMgmtRst();
}
%>
