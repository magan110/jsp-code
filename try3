<%@ include file="/Envr/JSP/SecurityCom.jsp"%>
<%//@ include file="/Envr/Login/LYPEnvrSet.jsp"%>

<!-- /BirlaWhite/Trans/Token/TokenRecd.jsp -->
<%
ResultSet rset = null;

String  sql	= "",
		procType = "A",
		formName = "TokenRecd", 
		custCode = "",
		areaCode = log.getArCode(),
		retlArHd = log.getAreaHead(),
		areaHdMb = log.getAreaHdMb(),
		readBtTx = "",
		readBtDs = " disabled ",
		tokenNum = "",
		appRtlTy = "", 
		plcHoldr = "",
		msgToFls = "",
		randNumb = "",
		msgToFls1 = "",
		disabledFlg = "",
		numCvvNo = "",
		tknScanVw = "TknScanDtl.jsp";
	//	tknScanVw = WebSessBean.getPageAddr("TknScanDtl");

double tokTdsRt = 0.0;

boolean custLgdn = false,
		adminRol = false;

if(log.isValidRole("admin", false))
{
	adminRol = true;
	readBtTx = "TxtFileUpld";
	readBtDs = "";
}

//	 if(1 == 1 && !loginIdM.equals("3517"))
//		throw new Exception("msgDispl-Application under maintenance. We will back soon.");

sql = "select right(newid(), 16)";
rset = WebSessBean.selectRecord(sql);
if(rset.next())
{
	randNumb = rset.getString(1);
}

if(log.getUserType().equals("C") || log.getUserType().equals("R")  || log.getUserType().equals("I"))
{
	custLgdn = true;

	sql = "select dbo.dpfTokTdsRt(itxPanNo, kycVerFl), appRtlty from wcvAllCustm with (nolock) where appRtlcd = '" + loginIdM + "'"; // 
	rset = WebSessBean.selectRecord(sql);

	if(rset.next())
	{
		tokTdsRt = rset.getDouble(1);
		appRtlTy = rset.getString(2);

	}

//	 // System.out.println("appRtlTy " + appRtlTy);
//select top 10 * from dpmTokenNos with (nolock) where isactive = 'Y'
// Test Customer 4401S719
}

session.setAttribute("dpTKNIns", "N");
/*
	http://www.birlawhite.com:8080/Stat/tmpForDwnLd/BarCodeApp.apk
	http://www.birlawhite.com:8080/Stat/tmpForDwnLd/SVD.zip
	Bar Code Scanning By Installing App, This feature exclusively for Purchasers and Retailers
	http://www.birlawhite.com:8080/BirlaWhite/Trans/Token/BarCodeMobileAppScan.pdf
	By SPARSH login on Android Phone, Please read document as
	http://www.birlawhite.com:8080/BirlaWhite/Trans/Token/BarCodeKeyBoardScanning.pdf

	Token Data Send to Vendor for Token Printing 395 are validity days, 12500 Qty to be printed and 22000000 is ceiling Qty
	select '' as tokenVal, '1800 111 717' as tollFree,  
	tokenNum, 
	upper(convert(char(11), dateadd(dd, 395, getdate()), 100)) as validDat,  
	dbo.cofConvCstr(tokenIdn, 9) as tokenIdn  --Text Format in Excel
	from dpmTokenNos with (nolock) 
	where isActive = 'N' 
	and tokenIdn >= 22000000 
	and   tokenIdn < 
	( 
	   select min(tokenIdn) + 12500
	   from   dpmTokenNos b with (nolock)    
	   where isActive = 'N' 
	   and tokenIdn >= 22000000 
	) 
	order by tokenIdn
*/
if(mobilApp)
	plcHoldr = "Click here to scan Code";
else
	plcHoldr = "Click here Token Code";

%>
<!-- Header Starts -->
<jsp:include page="/Envr/JSP/HeaderCom.jsp" flush="true">
	<jsp:param name="mobFrend" value="B"/>
</jsp:include>
<!-- Header Ends -->
<script>
function openWind()
{
	var pageLink = "<%=tknScanVw%>?loginIdM="+ loginIdM;
	openClickWind(pageLink);
}



function getBuildNumb(str) 
{
	var myVar = null;
	myVar = Android.getBuildNumb();
	
	if(myVar < "1.48")
	{
		//window.location  = "https://play.google.com/store/apps/details?id=com.bw.sparsh";
		alert("Dear User Please Update Your Mobile App For Scan fast");
		return false;
	}
	addrow1();
}

//	getBuildNumb('');
</script>
<script type="text/javascript" language="javascript1.2">
var headingRowCnt = 1;
var invalidA = 0;
var numRows1 = 0;

var msgeToJs1 = '';
var validArr = [];
var invalidArr = [];

function sendSMS(msgeText) 
{
	var dataRecv = sendSMSAjax('<%=formName%>', 'SMSDumm', '<%=retlArHd%>', '<%=areaHdMb%>', msgeText, '22', '<%=loginIdM%>'); 
	invalidA = 0;
	return dataRecv;
}

function custCodeHlpLoc(rqstType) 
{
	var retValue, wherList = "";
	
	if(<%=!adminRol%>) 
	{
		wherList = whereAdd(wherList, "SW_11", ""); 
	}
	
	retValue = custCodeHlp('<%=formName%>', 'areaCode', 'custCode', rqstType, 'O', 'T', wherList);

	return retValue;
}

function areaCheckLoc(bcTknTyp, varNumRw) // Hard code to be change at save also.
{
	var areaCode = document.<%=formName%>.areaCode.value;
	var areaVald = true;
/*Manish Navin*/
	if((bcTknTyp == "B1" && areaCode != "EXE" && areaCode != "EXN" && areaCode != "EXR") || (bcTknTyp != "B1" && (areaCode == "EXE" || areaCode == "EXN" || areaCode == "EXR"))) 
		areaVald = false;

/*Export Token added Nov 20 Not to be credited to Purchaser Account, and scanned to Export Area Only */
	if((bcTknTyp == "E1" && areaCode != "EXB" && areaCode != "EXC" && areaCode != "EXG") || (bcTknTyp != "E1" && (areaCode == "EXB" || areaCode == "EXC" || areaCode == "EXG"))) 
		areaVald = false;
	

	if(bcTknTyp == "")
		areaVald = true;

	if(!areaVald)
	{
		//alert("This token type is invalid for this area");
		eval("tokenNum" + varNumRw + "Div").innerHTML = "This token type is invalid for this area";
		eval("document.<%=formName%>.tokenNum" + varNumRw).value = ""; 
		eval("document.<%=formName%>.tokenNum" + varNumRw).focus();
		return false;
	}

	return true;
}

function notDupl(objValue, varNumRw)
{
	var rowLen = document.<%=formName%>.abc1.length;
	var abcLen = document.<%=formName%>.abc1.length;
	if(rowLen==null)
	{
		rowLen=1;
	}
	var fldIndex = "";
	var fieldValue = objValue;
	
	if(rowLen==1)
		return true;

	for(var ck = 0; ck < rowLen-1; ck++)
	{
		if(abcLen==null)
			fldIndex = document.<%=formName%>.abc1.value;
		else
			fldIndex = document.<%=formName%>.abc1[ck].value;

		fldObj = "document.<%=formName%>.tokenNum" + fldIndex; 
		if(eval(fldObj).value == fieldValue)
		{
			//alert("Please remove Duplicate Entry");
			eval("tokenNum" + varNumRw + "Div").innerHTML = "Duplicate Entry, Already scanned above";
			eval(fldObj).focus();
			return false;
		}			
	}
	return true;
}

function custCodeGet(rqstType) 
{
		var srcFldNm = "custCode",
		tgtFldNm = "custCodeDiv";
	var queryCod = "",
		wherList = "",
		rtnValue = false,
		rqstType = "G";
		queryCod = "MK_01083";
	var cusRtlFl = "C";

	wherList = whMasAdd(wherList, "Y");


	if(document.<%=formName%>.areaCode.value == "")
	{
		displErr("Please select Area");
			document.<%=formName%>.areaCode.focus();
		return false;
	}
	wherList = whereAdd(wherList, "SW_04", document.<%=formName%>.areaCode.value);
	if(<%=!adminRol%>) 
	{
	//	wherList = whereAdd(wherList, "SW_11", ""); 
	}

	rtnValue = setPrmNew("<%=formName%>", srcFldNm, queryCod, rqstType, "DN", wherList, tgtFldNm);
	//alert(rtnValue);
	if (!rtnValue)
		return false;
	var custCodeArr = document.getElementById(tgtFldNm).innerText.split("~~");
	
	document.getElementById(tgtFldNm).innerText = "";

	$("#custCode").autocomplete(
	{
		source: custCodeArr
	});
	
	return true;

/*	var retValue, wherList = "";

	if(<%=!adminRol%>) 
	{
		wherList = whereAdd(wherList, "SW_11", ""); 
	}
	
	retValue = custCodeHlp('<%=formName%>', 'areaCode', 'custCode', rqstType, 'O', 'T', wherList);
//	alert(retValue);
	return retValue;
*/
}

function custCodeChng(currObjc)
{
	var rqstLnth = currObjc.value.split("~");

		if(rqstLnth.length == "1")
				custCodeHlpLoc('G');
	else
	{
		document.getElementById("custCodeDiv").innerText = currObjc.value.split("~")[1];
		document.getElementById("custCode").value = currObjc.value.split("~")[0];
	}
}

var valCheck = null;
function barCodeScan(str)
{
//	alert(str);
	if(str == "Exit")
	{
		return false;
	}
	
	/*
	if(valCheck == str)
	{
		//alert("Activity Close");
		valCheck = null;
		return false;
	}
	else
	{
	*/
		if("<%=mobilApp%>" == "true")
		{
		//	setTimeout(function()
		//	{
				Android.turnGPSOn(str);
//				Android.sendPlayStore();
		//	}, 1000);
		
		//	var myVar = null;
		}
//	}
}
function getFromAndroid(str) 
{
	var myVar = null;
	myVar = Android.getFromAndroid();
	
//	alert(myVar);

//	if(myVar == "")
//		return false;
//	else 
		eval("document.<%=formName%>.tokenNum" + str).value = myVar;
}

function getTokenDesc(varNumRw)
{
	/*
	if (window.performance && window.performance.navigation.type == window.performance.navigation.TYPE_BACK_FORWARD) 
	{
		alert('hello world');
	}
	*/

	if("<%=mobilApp%>" == "true")
	{
		getFromAndroid(varNumRw);
	}

	var objcName = "document.<%=formName%>.tokenNum" + varNumRw;
	var	tgtFldNm = "tokenNum" + varNumRw + "Div";
	
	if(eval(objcName).value.length == 8)
	{
		alert("You can not Scan Loyalty Token on SPARSH.");
		eval(objcName).value = "";
		return false;
	}
	if (eval(objcName).readOnly == true)
		return true;
	else
		readonly(eval(objcName).name, "D", false, false);
	
	var	isActive = "", 
		tokenIdn = "", 
		msgLocal = "", 
		validDat = "", 
		tokenVal = "", 
		handRate = "", 
		scnrDdRt = "", 
		tokEndVl = "", 
		scanndBy = "",
		updIdAct = "",
		updIdMlt = "",
		scnMlStt = "",
		scnMlCnt = "",
		tokDspVl = "",
		bcTknTyp = "",
		numCvvNo = "",
		scnMlAlw = "";

	var tokAmPay = 0;

	if(!textValidCap(eval(objcName), "Token value"))
		return false;
	
	eval(objcName).value =  cstr(eval(objcName).value, 12); // Added 31-dec-20 to handle Zero Truncated in Token Printing 

	var	objValue = eval(objcName).value;

	if(notDupl(objValue, varNumRw))
	{
		if(!isEmpty(objValue))
		{
			toUpperCase(eval(objcName));
			document.getElementById(tgtFldNm).innerHTML =  "";
			var wherList = "";
			wherList = whereAdd(wherList, "@__01", objValue);
			wherList = whereAdd(wherList, "@__02", document.<%=formName%>.areaCode.value); // 19-Nov-21 areaCode added to Token Validity check Area Wise 
			wherList = whereAdd(wherList, "@__03", document.<%=formName%>.custCode.value); // 19-Nov-21 areaCode added to Token Validity check Area Wise 
			wherList = whereAdd(wherList, "@__04", "<%=randNumb%>"); // 19-Nov-21 areaCode added to Token Validity check Area Wise 
			//var dataRecvd = setPrmNew("<%=formName%>", "tokenNum" + varNumRw, "MK_00023", "G", "DN", wherList, tgtFldNm);
			var dataRecvd = setPrmNew("<%=formName%>", "tokenNum" + varNumRw, "MK_02004", "G", "DN", wherList, tgtFldNm); // added 05-Jan-17 
			// alert(dataRecvd);
			if(dataRecvd)
			{
				invalidA = 0;
				var brkUpArr = document.getElementById(tgtFldNm).innerText.split(splitChr);
				eval("document.<%=formName%>.brkUpArr" + varNumRw).value = document.getElementById(tgtFldNm).innerText;
				document.getElementById(tgtFldNm).innerText = "";
				tokenIdn = brkUpArr[0];
				isActive = brkUpArr[1];
				validDat = brkUpArr[2];
				scanndBy = brkUpArr[3];
				tokenVal = brkUpArr[4];
				handRate = brkUpArr[5];
				scnrDdRt = brkUpArr[6];
				tokEndVl = brkUpArr[7];
				scnMlStt = brkUpArr[8];
				scnMlCnt = brkUpArr[9];
				scnMlAlw = brkUpArr[10];
				updIdAct = brkUpArr[11];
				updIdMlt = brkUpArr[12];
				tokDspVl = brkUpArr[13];
				bcTknTyp = brkUpArr[14];
				exprFlag = brkUpArr[15]; 
				numCvvNo = brkUpArr[16]; 

				if(numCvvNo != "")
					eval("document.<%=formName%>.numCvvFl" + varNumRw).value = "Y";
				// alert("numCvvNo" + numCvvNo);
				// alert("Hello there1");
				// if(!numCvvNo == "" )
				// {
				// 	alert("Hello there 2");
				// }

				if(numCvvNo != "")
				{
					$("#numCvvNo" + varNumRw + "Div").show();
				}
				else
				{
					otpFlagChk(varNumRw, "N");
				}
			}
			else
			{
				invalidA++;
				msgLocal = document.getElementById(tgtFldNm).innerText;
				
				if(msgLocal.indexOf("No Record Found") != -1)
					document.getElementById(tgtFldNm).innerHTML = " <font color='red'>NOT OK</font>";
				else
					document.getElementById(tgtFldNm).innerHTML = " <font color='red'>" + msgLocal + " or Please check with IT or Company Officer</font>";

				// alert("Check Value : " + eval("document.<%=formName%>.tokenNum" + varNumRw).length);


				eval(objcName).value = objValue;
				eval("document.<%=formName%>.tokenVld" + varNumRw).value = 'N';
				//alert(invalidA);
				if(invalidA > 10)
				{ 
					sendSMS('Invalid Attempts of Token Entry has been created, Login Id <%=loginIdM%>, area <%=log.getArCode()%>, IP <%=log.ipAddrClGet()%>');
				}
				//eval(objcName).focus();
				
				//alert("Check Value : " + eval("document.<%=formName%>.tokenNum" + varNumRw).value);
				if(eval("document.<%=formName%>.tokenNum" + varNumRw).value != "")
					addrow1();
				return false; 
			}
		}
		else
			document.getElementById(tgtFldNm).innerHTML = "";
		return true;
	}
	else
	{
		eval(objcName).value = "";
		readonly(eval(objcName).name, "E", true, false, "");
//		eval(objcName).focus();
		return false;
	}
}
var pinInvdlC = 0;
function otpFlagChk(varNumRw, numCvvFl)
{
	var objcName = "document.<%=formName%>.tokenNum" + varNumRw;
	var	tgtFldNm = "tokenNum" + varNumRw + "Div";
	var	isActive = "", 
		tokenIdn = "", 
		msgLocal = "", 
		validDat = "", 
		tokenVal = "", 
		handRate = "", 
		scnrDdRt = "", 
		tokEndVl = "", 
		scanndBy = "",
		updIdAct = "",
		updIdMlt = "",
		scnMlStt = "",
		scnMlCnt = "",
		tokDspVl = "",
		bcTknTyp = "",
		numCvvNo = "",
		scnMlAlw = "";

		invalidA = 0;
	var brkUpArr = eval("document.<%=formName%>.brkUpArr" + varNumRw).value.split(splitChr);

		tokenIdn = brkUpArr[0];
		isActive = brkUpArr[1];
		validDat = brkUpArr[2];
		scanndBy = brkUpArr[3];
		tokenVal = brkUpArr[4];
		handRate = brkUpArr[5];
		scnrDdRt = brkUpArr[6];
		tokEndVl = brkUpArr[7];
		scnMlStt = brkUpArr[8];
		scnMlCnt = brkUpArr[9];
		scnMlAlw = brkUpArr[10];
		updIdAct = brkUpArr[11];
		updIdMlt = brkUpArr[12];
		tokDspVl = brkUpArr[13];
		bcTknTyp = brkUpArr[14];
		exprFlag = brkUpArr[15]; 
		numCvvNo = brkUpArr[16]; 
		
		eval("document.<%=formName%>.numCvvFl" + varNumRw).value = numCvvFl;
		if(numCvvFl == "Y" && numCvvNo !="")
		{
			if(numCvvNo != eval("document.<%=formName%>.numCvvNo" + varNumRw).value && pinInvdlC >= 2)
			{
				alert("invalid Pin No.");
				eval("document.<%=formName%>.numCvvNo" + varNumRw).value = "";
				eval("document.<%=formName%>.tokenNum" + varNumRw).value = "";
				eval("document.<%=formName%>.brkUpArr" + varNumRw).value = "";
				readonly(eval(objcName).name, "E", true, false, "");
				document.getElementById(tgtFldNm).innerText = "Invalid Pin No.";
				$("#numCvvNo" + varNumRw + "Div").hide();
				return false;
			}
			else if(numCvvNo != eval("document.<%=formName%>.numCvvNo" + varNumRw).value)
			{
				pinInvdlC = pinInvdlC+1; 
				alert("invalid Pin No.");
				eval("document.<%=formName%>.numCvvNo" + varNumRw).value = "";
				return false;
			}
		}
		pinInvdlC = 0;
		if(updIdAct == "<%=loginIdM%>") 
		{
			isActive = 'Z';
		}
//	alert(isActive);
	if(isActive == 'Y')
	{
		// alert("exprFlag" + exprFlag)
		// alert("bcTknTyp" + bcTknTyp)
		// alert("tokenIdn" + tokenIdn)
		// alert("tokDspVl" + tokDspVl)
		// alert("handRate" + handRate)
		if(exprFlag == "N")
		{
			msgLocal = tokenIdn + " valid upto " + validDat + ", Value To Pay " + tokDspVl + ", Handling " + handRate + " OK";
			tokAmPay = parseFloat(tokDspVl) + parseFloat(handRate);
			// alert(tokAmPay); // Vaibhav 
		}
		/*else if(isActive == 'Y')
		{
			msgLocal = tokenIdn + " valid upto " + validDat + ", Value To Pay " + tokDspVl + ", Handling " + handRate + " OK";
			tokAmPay = parseFloat(tokDspVl) + parseFloat(handRate);
		}*/
		else 
		{
			isActive = 'E';			
			eval("document.<%=formName%>.tokenVld" + varNumRw).value = 'N';
			msgLocal = "<font color='red'> " + tokenIdn + " Validity Expired " + validDat + ", <font color='red'>NOT Ok</font>";
		//	isActive = 'E';
		}
	}
	else if(isActive == 'Z')
	{
		msgLocal = tokenIdn + " <br> <font color='red'>Already scanned earlier  " + scanndBy + " <br> " + tokenVal + "</font>";
		//eval(objcName).value = "";
		//eval(objcName).focus();
	}
	else if(exprFlag == "Y")
	{
		msgLocal = "<font color='red'> " + tokenIdn + " Validity Expired " + validDat + ", NOT Ok</font>";
		isActive = 'E';
	}
	else if(isActive == 'T')
	{
		msgLocal = tokenIdn + " <font color='red'> NOT OK and it is in theft category please report to Company Officer</font>";
	}
	else
	{
		isActive = "";
		msgLocal = tokenIdn + " <font color='red'> NOT Checked, Incorrect Status, can be validated after submit</font>";
	}

//	alert("Check Value : " + eval("document.<%=formName%>.tokenNum" + varNumRw).value);
	if(eval("document.<%=formName%>.tokenNum" + varNumRw).value != "")
		addrow1();

	eval("document.<%=formName%>.tokenIdn" + varNumRw).value = tokenIdn;
	document.getElementById(tgtFldNm).innerHTML = msgLocal;
	eval("document.<%=formName%>.tokenVld" + varNumRw).value = isActive;
	eval("document.<%=formName%>.scnMlStt" + varNumRw).value = scnMlStt;
	eval("document.<%=formName%>.scnMlCnt" + varNumRw).value = scnMlCnt;
	eval("document.<%=formName%>.scnMlAlw" + varNumRw).value = scnMlAlw;
	eval("document.<%=formName%>.bcTknTyp" + varNumRw).value = bcTknTyp;
	eval("document.<%=formName%>.tokAmPay" + varNumRw).value = tokAmPay;
	eval("document.<%=formName%>.numCvvNo" + varNumRw).value = numCvvNo;

	if(!areaCheckLoc(bcTknTyp, varNumRw))
		return false;
}

function checkScan(varNumRw)
{
	 //alert(varNumRw);
	 //alert("Check Value : " + eval("document.<%=formName%>.tokenNum" + varNumRw).value.length);

	var noObj = eval("document.<%=formName%>.tokenNum" + varNumRw);
	
	//(window.event.keyCode == 13 && noObj.value.length >= 12) || 
	if(noObj.value.length >= 12)
	{
		getTokenDesc(varNumRw);
	}

}

function mobileNoChngLoc(varNumRw)
{
	var objcName = eval("document.<%=formName%>.mobileNo" + varNumRw);
	var	tgtFldNm = "mobileNo" + varNumRw + "Div";

	var	inflCode = "", 
		inflName = "";

	var	objValue = eval(objcName).value;

	if(!mobileVlNo(objValue))
	{
		alert("Please Enter valid Mobile No");
		eval(objcName).focus();
		return false;
	}

	if(!isEmpty(objValue))
	{
		toUpperCase(eval(objcName));
		document.getElementById(tgtFldNm).innerHTML =  "";

		var wherList = "";
		wherList = whereAdd(wherList, "@__01", objValue);
		var dataRecvd = setPrmNew("<%=formName%>", "mobileNo" + varNumRw, "MK_00051", "G", "DN", wherList, tgtFldNm);
		if (dataRecvd)
		{
			var brkUpArr = document.getElementById(tgtFldNm).innerText.split(splitChr);
			inflCode = brkUpArr[0];
			inflName = brkUpArr[1];
			document.getElementById(tgtFldNm).innerText = inflName;
			eval("document.<%=formName%>.inflName" + varNumRw).value = inflName;
			eval("document.<%=formName%>.inflName" + varNumRw).readOnly = true;
			eval("document.<%=formName%>.inflCode" + varNumRw).value = inflCode;
		}
		else
		{
			eval("document.<%=formName%>.mobileNo" + varNumRw).value = objValue;
			eval("document.<%=formName%>.inflName" + varNumRw).value = "";
			eval("document.<%=formName%>.inflName" + varNumRw).readOnly = false;
			eval("document.<%=formName%>.inflCode" + varNumRw).value = "";
			document.getElementById(tgtFldNm).innerHTML =  "";
			eval("document.<%=formName%>.inflName" + varNumRw).focus();
		}
	}
}

function addrow1()
{
	var mobileNo = "", inflName = "", srNumber, inflCode = "", lnthChkB;
	if(document.<%=formName%>.abc1 != null)
	{
		lnthChkB = document.<%=formName%>.abc1.length;
		if(lnthChkB == null)
		{
			srNumber = document.<%=formName%>.abc1.value;
		}
		else
		{
			srNumber = document.<%=formName%>.abc1[lnthChkB - 1].value
		}
//		mobileNo = eval("document.<%=formName%>.mobileNo" + srNumber).value;
//		inflName = eval("document.<%=formName%>.inflName" + srNumber).value;
//		inflCode = eval("document.<%=formName%>.inflCode" + srNumber).value;
	}
	addrow('N', '',  '', '');
}

function openExcelWindLoc()
{
	openExcelWind(4, "TokenNo,Mobile,InflName,InflCode", "");
}

function addrowExcel(toRefresh, tokenNum, mobileNo, inflName, inflCode)
{
	addrow(toRefresh, tokenNum, inflCode, inflName, mobileNo);
}

function addrow(toRefresh, tokenNum,  inflCode, numCvvNo)
{
	var numrows = getNumRows();
//	var newRow = insertRowBw(document.all.prjTable);

/*	name = "abc1";
	m = insertCellBw(newRow);
	m.innerHTML =  numrows + "<input type='checkbox' name='abc1' value='" + numrows + "' tabindex=-1>";

	name = "mobileNo" + numrows;
//	m = insertCellBw(newRow);
	m.innerHTML = "<input type='hidden'   name='" + name + "' value='9999999999'>";	// onchange='return mobileNoChngLoc(" + numrows + ")' size='15' maxlength = '10' placeholder='Painter Mobile No' 
	m.innerHTML += "<div style='display:none' id='" + name + "Div' ></div>";

	name = "inflName" + numrows;
//	m = insertCellBw(newRow);
	m.innerHTML = "<input type='hidden' name='" + name + "' size='15' placeholder='Painter Name' maxlength = '40' value='Anhuit' >";


";	//<input type='hidden' value='Get from android' onClick='getBuildNumb(" + numrows + ")' />
	m.innerHTML += " 
*/	
	var addRowData = "<div class='p-5 child_div card-xl-stretch mb-xl-8' ><div class=\"d-flex align-items-center mb-8\"><span class=\"bullet bullet-vertical h-40px bg-primary\"></span>";
	 // onChange='prodCodeChang(this, " + numrows + ")'

	addRowData += "<div class=\"form-check  form-check-custom form-check-solid mx-8\"><input class=\"form-check-input deleteButton\" type=\"checkbox\" name='abc1' value='" + numrows + "' tabindex=-1/></div>";
	
	name = "tokenNum" + numrows;

//	m.innerHTML = "<div class='input-group'><div class='input-group-prepend'><input type='checkbox' name='abc1' value='" + numrows + "' tabindex=-1 > </div><div class='input-group-text'><input type='text' name='" + name + "' id='" + name + "'  placeholder='<%=plcHoldr%>' maxlength = '12' value='" + tokenNum + "' onClick='return barCodeScan(" + numrows + ")' onkeyup='return checkScan(" + numrows + ")' onchange='return getTokenDesc(" + numrows + ")'></div></div>";	//<input type='hidden' value='Get from android' onClick='getBuildNumb(" + numrows + ")' /> onfocus='return barCodeScan(" + numrows + ")' 
	addRowData += "<div class=\"col-9 col-md-9 col-lg-9\"><input type='text' name='" + name + "' id='" + name + "' class='form-control form-control-solid' placeholder='<%=plcHoldr%>' maxlength = '12' value='" + tokenNum + "'  onClick='return barCodeScan(" + numrows + ")'  onkeyup='return checkScan(" + numrows + ")' onchange='return getTokenDesc(" + numrows + ")'></div></div></div>";
//readOnly to be add in 606

	name = "numCvvNo" + numrows;
	addRowData += "<div class=\"col-3 col-md-3\" id='" + name + "Div'><input type='tel' name='" + name + "' id='" + name + "' class='form-control form-control-solid' placeholder='<%=plcHoldr%>' maxlength = '3' value='" + numCvvNo + "' onchange=\"return otpFlagChk(" + numrows + ", 'Y')\"></div><div class=\"flex-grow-1 d-flex flex-colum row\"><div class=\"d-flex col-9 col-md-9 col-lg-9\"><span class=\"d-flex align-items-center mr-10 text-gray-800 fw-bolder fs-6\" id='tokenNum" + numrows + "Div'>Token Details</span></div><div class=\"separator separator-dashed my-5\"></div>";
	//m = insertCellBw(newRow);
	//m.innerHTML = "<div style='white-space: pre-wrap;' id='tokenNum" + numrows + "Div' //placeholder='Description'>Token Details</div>";

	name = "tokenVld" + numrows;
	addRowData +=  "<input type='hidden' name='" + name + "' value=''>";

	name = "tokenIdn" + numrows;
	addRowData += "<input type='hidden' name='" + name + "' value=''>";

	name = "inflCode" + numrows; 
	addRowData +=  "<input type='hidden' name='" + name + "' value='" + inflCode + "'>";

	addRowData += "<input type='hidden' name='srNumber' value=" + numrows + ">";
	addRowData += "<input type='hidden' name='scnMlCnt" + numrows + "' value='0'>";
	addRowData += "<input type='hidden' name='numCvvFl" + numrows + "' value='N'>";
	addRowData += "<input type='hidden' name='scnMlAlw" + numrows + "' value='0'>";
	addRowData += "<input type='hidden' name='scnMlStt" + numrows + "' value=''>";
	addRowData += "<input type='hidden' name='bcTknTyp" + numrows + "' value=''>";
	addRowData += "<input type='hidden' name='brkUpArr" + numrows + "' value=''>";
	addRowData += "<input type='hidden' name='mobileNo" + numrows + "' value='9999999999'>";
	addRowData += "<input type='hidden' name='inflName" + numrows + "' value='Anhuit'>";
	addRowData += "<input type='hidden' name='tokAmPay" + numrows + "' value='0'>";
	addRowData += "</div></div>";
	$("#addblock").before(addRowData);
//	alert(eval("rowLenDiv").innerText);
	
	if(numCvvNo == "")
	{
		$("#numCvvNo" + numrows + "Div").hide()
	}
	else
	{
		$("#numCvvNo" + numrows + "Div").hide()
	}
	eval("document.<%=formName%>.tokenNum" + numrows).focus();
	eval("rowLenDiv").innerText = getCheckLenOrVal(document.<%=formName%>.abc1, null);
}

function deleter1()
{
	if(deleterCv("<%=formName%>", "abc1", "prjTable", headingRowCnt))
	{
		eval("document.<%=formName%>.tokenNum" + document.<%=formName%>.abc1[document.<%=formName%>.abc1.length -1].value).focus();
		$("#numCvvNo" + numrows + "Div").hide();
	}
	eval("rowLenDiv").innerText = getCheckLenOrVal(document.<%=formName%>.abc1, null);
}

function submitFilter()
{
	document.<%=formName%>.btnSaveExit.disabled = true;
	
	if(!submitValid())
	{
		document.<%=formName%>.btnSaveExit.disabled = false;
		return false;
	}
}


function submitValid()
{
	var validScan = 0;
	var invalidScan = 0, alrdyScn = 0, expirdScn = 0, pndFrAct = 0;
	toSubmit = true;
	if (!textValidCap(document.<%=formName%>.custCode, "Stockist", true))
		return false;
	
	var rowLen = document.<%=formName%>.abc1.length;
	if(rowLen>1)
	{
		document.getElementById("totalTknScan").innerHTML = rowLen;
	}
	else
	{
		document.getElementById("totalTknScan").innerHTML = 1;
	}
	var abcLen = document.<%=formName%>.abc1.length;
	var emptyLen = 0, prodCd10 = 0, prodCd36 = 0;
	var totAmPay = 0, tdsAmDed = 0, netAmPay = 0, tokAmPay = 0;
	var msgeToJs = "",  custCode = "" ;
	if(rowLen==null)
	{
		rowLen=1;
	}
	var fldIndex = "";
	var tokenNum = "";
	for(var ck = 0; ck < rowLen; ck++)
	{
		salesTot = 0;
		if(abcLen==null)
			fldIndex = document.<%=formName%>.abc1.value;
		else
			fldIndex = document.<%=formName%>.abc1[ck].value;

		if(eval("document.<%=formName%>.numCvvFl" + fldIndex).value == "Y")
		{
			if(eval("document.<%=formName%>.numCvvNo" + fldIndex).value == "")
			{
				alert("Please select Pin No");
				return false;
			}
		}

		if(!areaCheckLoc(eval("document.<%=formName%>.bcTknTyp" + fldIndex).value, fldIndex))
		{
			return false;
		}

		fldObj = "document.<%=formName%>.tokenNum" + fldIndex; 
		if(isEmpty(eval(fldObj).value))
		{
			emptyLen++;
			/*alert("Please remove empty rows by selecting and pressing delete button");
			eval(fldObj).focus();
			return false;*/
		}			

		if(!isEmpty(eval(fldObj).value) && isEmpty(eval("document.<%=formName%>.bcTknTyp" + fldIndex).value) && eval("document.<%=formName%>.tokenVld" + fldIndex).value == "Y")
		{
			alert("Please delete selected Entry, NO Token Type detected");
			eval(fldObj).focus();
			return false;
		}			
		
		if(eval("document.<%=formName%>.bcTknTyp" + fldIndex).value == "B1")
			prodCd36++;
		else
			prodCd10++;
/*Compulsory from 01-May-12*/

		if(!mobileValid(eval("document.<%=formName%>.mobileNo" + fldIndex), false))
		{
			alert("Please Enter valid Mobile No");
			return false;
		}
		  
		fldObj = "document.<%=formName%>.inflName" + fldIndex; 
		toSentenceCaseApp(eval(fldObj));
		if(isEmpty(eval(fldObj).value) && !isEmpty(eval("document.<%=formName%>.mobileNo" + fldIndex).value))
		{
			alert("Please Enter Painter Name");
			eval(fldObj).focus();
			return false;
		}			
		
		if(eval("document.<%=formName%>.tokenNum" + fldIndex).value != "")
		{
			tokenNum += eval("document.<%=formName%>.tokenNum" + fldIndex).value + ",";
			if(eval("document.<%=formName%>.tokenVld" + fldIndex).value == "Y")
			{
				tokAmPay = eval("document.<%=formName%>.tokAmPay" + fldIndex).value;
				totAmPay = totAmPay + parseFloat(tokAmPay);
				validScan++;
				//	validArr[validScan] =  eval("document.<%=formName%>.tokenNum" + fldIndex).value;
				//	alert(eval("document.<%=formName%>.tokenNum" + fldIndex).value);
			}	
			else if(eval("document.<%=formName%>.tokenVld" + fldIndex).value == "E")
			{
				expirdScn++;
			}
			else if(eval("document.<%=formName%>.tokenVld" + fldIndex).value == "Z")
			{
				alrdyScn++;
			}
			else //if(eval("document.<%=formName%>.tokenVld" + fldIndex).value == "X" || eval("document.<%=formName%>.tokenVld" + fldIndex).value == "N")
			{
				invalidScan++;
			}
		//	else if(eval("document.<%=formName%>.tokenVld" + fldIndex).value != "Y")
		//	{
		//		invalidScan++;
		//	}
		}
	}
//	alert(emptyLen);
	if (emptyLen == rowLen)
	{
		alert("can not submit Empty Data");
		return false;	
	}
	if(emptyLen >= 1)
	{
		document.getElementById("totalTknScan").innerHTML = rowLen - emptyLen;
	}

	if (prodCd10 > 0 && prodCd36 > 0)
	{
		//alert("Different Pack Size Token can not be scanned simaultaneously");
		//return false;	
	}

	tdsAmDed = totAmPay * <%=tokTdsRt%> / 100; // Changes Aug 22
	netAmPay = totAmPay - tdsAmDed;
	document.<%=formName%>.tokenNmL.value = tokenNum;
	document.<%=formName%>.totAmPay.value = totAmPay;
	document.<%=formName%>.tdsAmDed.value = tdsAmDed;
	document.<%=formName%>.netAmPay.value = roundApp(netAmPay, 2);
	document.getElementById("netPay").innerHTML = totAmPay;
	document.getElementById("validScanDiv").innerHTML = validScan;
	document.getElementById("invalidScanDiv").innerHTML = invalidScan;
	document.getElementById("expirdScn").innerHTML = expirdScn;
	document.getElementById("alrdyScn").innerHTML = alrdyScn;
	
	if(validScan == "0" && expirdScn == "0")
	{
		alert("There is no any valid Token, Please select valid token and try again.");
	//	return false;
	}

	//	ST, RD, AD, DD, UR - PopUp msg blocked for these CustType as suggested By Shreyansh
	if("<%=appRtlTy%>" == "ST" || "<%=appRtlTy%>" == "RD" || "<%=appRtlTy%>" != "AD" || "<%=appRtlTy%>" != "DD" || "<%=appRtlTy%>" != "UR")
	{
		msgeToJs1 = "";
	}
	else
	{
		msgeToJs1 = "Total = " + document.<%=formName%>.totAmPay.value + ", TDS = " + document.<%=formName%>.tdsAmDed.value + ", Net (Total - TDS) = " + document.<%=formName%>.netAmPay.value;
	}
	
	eval("totAmDiv").innerHTML = msgeToJs1;
	
	if (!subValidCom("<%=formName%>"))
		return false;

	subMit1();
	function subMit1()
	{
		$("#kt_modal_PrcShow").modal('show');
	}
}

async function finlSubmitAjx()	
{
	if(document.<%=formName%>.tokenNmL.value == "")
	{
		alert("Please select token no");
		return false;
	}

	if(document.<%=formName%>.docuNumb.value == "")
	{
		alert("Please open Home page and re-open token scaning page.");
		return false;
	}
	 var tgtFldNm = "tokenNmLDiv";
	document.getElementById(tgtFldNm).innerHTML =  "";
	var wherList = "";
	wherList = whereAdd(wherList, "@__01", "jav01");
	wherList = whereAdd(wherList, "@__02", document.<%=formName%>.tokenNmL.value);
	wherList = whereAdd(wherList, "@__03", document.<%=formName%>.docuNumb.value);
	wherList = whereAdd(wherList, "@__04", document.<%=formName%>.areaCode.value);
	wherList = whereAdd(wherList, "@__05", document.<%=formName%>.custCode.value);
	wherList = whereAdd(wherList, "@__06", "<%=loginIdM%>");  
	wherList = whereAdd(wherList, "@__07", "");  
	wherList = whereAdd(wherList, "@__08", "<%=randNumb%>");  
	wherList = whereAdd(wherList, "@__09", "<%=log.getUserType()%>");  
	var dataRecvd = setPrmNew("<%=formName%>", "tokenNmL", "MK_02014", "G", "DN", wherList, tgtFldNm); // added 05-Jan-17 

	if(dataRecvd)
	{
		$("#kt_modal_PrcShow").modal('hide');
		$("#kt_modal_PrcShow_1").modal('show');
		/*
		invalidA = 0;
		var brkUpArr = document.getElementById(tgtFldNm).innerText.split(splitChr);
		eval("document.<%=formName%>.brkUpArr" + varNumRw).value = document.getElementById(tgtFldNm).innerText;
		document.getElementById(tgtFldNm).innerText = "";
		tokenIdn = brkUpArr[0];
		isActive = brkUpArr[1];
		validDat = brkUpArr[2];
		scanndBy = brkUpArr[3];
		tokenVal = brkUpArr[4];
		*/
	}
}
async function finlSubmit()	
{
/* 	for(var i=1;i<validArr.length;i++){
		alert(validArr[i]);
	}
		
	for(var i=1;i<invalidArr.length;i++){
		alert(invalidArr[i]);
	}*/

//	if(confirm(msgeToJs1 + "<%=msgToFls1%> You have choosen to Submit Press OK to continue"))
//	{
	//alert(finlStat);
	/* */
		document.<%=formName%>.btnSaveExit.disabled = true;
		document.<%=formName%>.method = "post";
		document.<%=formName%>.action = "<%=formName%>S.jsp";
		document.<%=formName%>.submit();
		return true;
	
//	}
}


function handleBackLoc()
{
	deleteAllRows("prjTable", headingRowCnt);
	addrow1();
}

$(document).on("click", ".deleteButton", function() 
{
	if(document.<%=formName%>.abc1.length != null)
	{
		if(document.<%=formName%>.abc1.length == 1)
		{
			alert("Can't Delete Last Row");
			return false;
		}
		else
		{
			$(this).closest('.child_div').remove();
		}
	}
	else
	{
		alert("Can't Delete Last Row");
		return false;
	}
});


</script>

<form name="<%=formName%>" class="form p-4" onload="handleBackLoc()">
	<div class="row gy-5 g-xl-10">
		<!--begin::Col-->
		<div class="col-xl-12">
			<div class="row-fluid">
				<div class="card p-5 card-xl-stretch mb-xl-8">
				<div class=" pt-2 row">
				<!--begin::Col 6 -->												
	<div class="form-group col-md-4 col-12">
		<label class="control-label control-label">Area and Purchaser</label>
<% 
if(custLgdn)
{
	custCode = loginIdM; 
	out.println("<input type='hidden' name='custCode' value='" + custCode + "'>" + log.getArCode() + " " + custCode);
	out.println("<input type='hidden' name='areaCode' value='" + areaCode + "'></div>");
}			
else
{
%>
		<select name="areaCode" onchange="document.<%=formName%>.custCode.value=''"  class="form-control selectpicker">
			<%=WebSessBean.getArDesc(areaCode, true)%>  
		</select> 
 	 </div>
	<div class="form-group col-md-4 col-12">
		<!--begin::Input group-->
			<label class="d-flex align-items-center fs-5 fw-bold mb-2">
				<span class="required">Purchaser Code</span>
			</label>
			<div class="input-group input-group-solid mb-5">
				<input type="text" name="custCode" id="custCode" size="8" class="form-control" maxlength = "8" value="<%=custCode%>"  onClick="custCodeGet('G')" onchange="return custCodeChng(this)" autocomplete="on" onfocus='setAccessKey(this, "srchcustCode")' <%=disabledFlg%>  aria-label="Recipient's username" aria-describedby="basic-addon2"> 
				<!-- <input type="text" class="form-control" value="459661P451" aria-label="Recipient's username" aria-describedby="basic-addon2"/> -->
				<span class="input-group-text cursor-pointer" id="basic-addon2">
					<i class="fas fa-search-plus fs-4" onClick="custCodeHlpLoc('L')" onChange="custCodeHlpLoc('G')" <%=disabledFlg%>></i>
				</span>
			</div>
			<!--end::Input group-->
	</div>
	
	<!-- 
	<div class="form-group col-md-3 col-12">
		<div class="input-group mb-3">
			
		<div class="input-group-append">
			<input type='button' name='srchcustCode' class='searchBtnApp' onClick="custCodeHlpLoc('L')" onChange="custCodeHlpLoc('G')" <%=disabledFlg%>>
		</div>
		</div>
	 </div> -->
<%
} 
%>
	<div class="form-group col-md-3">
		<div id="custCodeDiv" style="display:none"></div>
		<div id='SMSDummDiv'></div>
	</div>
 	 </div>
		
		<input type='hidden' name='SMSDumm' value=''>
		<input type='hidden' name='totAmPay' value='0'>
		<input type='hidden' name='tokenNmL' value="">
		<input type='hidden' name='tdsAmDed' value='0'>
		<input type='hidden' name='netAmPay' value='0'>
		<input type='hidden' name='randNumb' value='<%=randNumb%>'>
<% 
try 
{  
%>
		<%//=!(userType.equals("R") || userType.equals("I")) ? "Dear Purchasers Please Note Scanning Credit Note will be generated at the end of the day of cummulative value for whole Day. " : ""%>
<div class="row d-flex justify-content-center mt-4">
	<div class="accordion" id="accordionExample">
		<div id="addblock" class="addblock">
		</div>
	</div>
</div>
<div class="separator separator-dashed my-5"></div>

<div class="row mt-12 token-button">
	<div class="col-12 col-md-4 col-lg-5 token-count-1">
		<div class="badge badge-light-primary fs-4 fw-bolder">
			Token Counts : <span id='rowLenDiv'>&nbsp;&nbsp;&nbsp;&nbsp; </span> 
			
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Value : <span id='totAmDiv'></span>
		</div>
	</div>
	<div class="col-12 col-md-8 col-lg-7 text-end">																
		<input type="button" value='Add' onclick="addrow1()" class="btn btn-success me-5 mb-2"> 
		<!-- <input type="button" name='Delete' value='Delete' class="btn btn-danger me-5 mb-2" onClick="deleter1()"> -->
		<input type="button" name="btnSaveExit" value="Submit" class='btn btn-primary me-5 mb-2' onClick="return submitFilter()">

		<input type="button" name="btnSaveExit" value="Report" class='btn btn-danger me-5 mb-2' onclick="openClickWind('<%=tknScanVw%>?fromFlag=Y', 600, 800, 'Y')">
<%
if(!mobilApp && adminRol)
{
%>
	<input type="button" value='<%=readBtTx%>' onclick="openExcelWindLoc()" class="btn btn-warning me-5 mb-2" name='ReadBtn' <%=readBtDs%>> 
<%
}
%>
	</div>
</div>
<%	
}
catch(Exception e)
{
	throw new Exception("error in " + pageAddress + e);
} 
finally
{
	rset = WebSessBean.closeRset(rset);
}
%>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!--begin::Modal - Offer A Deal-->
		<div class="modal fade" id="kt_modal_PrcShow" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" tabindex="-1" aria-hidden="true">
			<!--begin::Modal dialog-->
			<div class="modal-dialog modal-dialog-centered mw-400px">
				<!--begin::Modal content-->
				<div class="modal-content">
					<!--begin::Modal header-->
					<div class="modal-header py-7 d-flex flex-column mb-8 fv-row">
						<!--begin::Modal title-->
						<h2 id="modlHead">Token Scan Summary</h2>
					<!--end::Modal title-->
				</div>
				<!--begin::Modal header-->
				<!--begin::Modal body-->
				<div class="modal-body scroll-y m-3">
					<!--begin::Stepper-->
					<div class="stepper stepper-links d-flex flex-column" id="kt_modal_PrcShow_stepper">
					  <div class="container-fluid">
						<div class="row justify-content-center">
							<table id="border">
									<tr id="border" bgcolor="#F8EEEC">
										<th style="font-size:20px;color:blue;">Total Scan</th>
										<td id="totalTknScan" align="center" style="font-size:25px;color:blue;"></td>
									</tr>
									<tr id="border" bgcolor="#F8EEEC">
										<th style="font-size:20px;color:green;">Valid Scan</th>
										<td id="validScanDiv" align="center" style="font-size:25px;color:green;"></td>
									</tr>
									<tr id="border" bgcolor="#F8EEEC">
										<th style="font-size:20px;color:green;">Expired Token</th>
										<td id="expirdScn" align="center" style="font-size:25px;color:green;"></td>
									</tr>
									<tr id="border" bgcolor="#F8EEEC">
										<th style="font-size:20px;color:green;">Already Scanned</th>
										<td id="alrdyScn" align="center" style="font-size:25px;color:green;"></td>
									</tr>
									<tr id="border" bgcolor="#F8EEEC">
										<th style="font-size:20px;color:red;">Invalid Scan</th>
										<td id="invalidScanDiv" align="center" style="font-size:25px;color:red;"></td>
									</tr>
									<tr id="border" bgcolor="#F8EEEC">
										<th style="font-size:20px;color:#8B8000;">Total Amount</th>
										<td id="netPay" align="center" style="font-size:20px;color:#8B8000;"></td>
									</tr>
							</table>
						</div>
					 </div>
					</div>
					<!--begin::Stepper finlSbt()-->
				</div>
				<!--begin::Modal body-->
				<div class="modal-footer">
					<button type="button" class="btn btn-light" data-bs-dismiss="modal" id="clsBtn">Close</button>
					<button type="button" class="btn btn-primary" id="clsBtn1" onClick="return finlSubmitAjx()">Save</button>
				</div>
			</div>
		</div>


<div class="modal fade" id="kt_modal_PrcShow_1" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered mw-400px">
		<div class="modal-content">
			<div class="modal-header py-7 d-flex flex-column mb-8 fv-row">
				<h2 id="modlHead">Token Scan Submit Status</h2>
		</div>
		<div class="modal-body scroll-y m-3">
			<div class="stepper stepper-links d-flex flex-column" id="kt_modal_PrcShow_1_stepper">
			  <div class="container-fluid">
				<div class="row justify-content-center">
			 		<div id='tokenNmLDiv'></div>    
				</div>
	 		   </div>
	 		 </div>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-light" data-bs-dismiss="modal" id="clsBtn" onClick="return toknScnPg()">Close& Rescan</button>
			<button type="button" class="btn btn-primary" id="clsBtn1" onClick="return goHomePg()">Home</button>
		</div>
	</div>
</div>

<style>
#border
{
	border:0.5px solid #EED5D2;
}
i 
{
    color: #009ef7 !important;
}
</style>
	<!--end::Modal - Offer A Deal--> 
<!-- Footer Starts -->
<jsp:include page="/Envr/JSP/FooterCom.jsp" flush="true"/>
<!-- Footer Ends -->
<!-- /BirlaWhite/Trans/Token/TokenRecd.jsp -->
<script>
// alert(performance.navigation.type);
 if (window.performance && window.performance.navigation.type == window.performance.navigation.TYPE_BACK_FORWARD) 
 {
	//alert('hello world');
 }

 function goHomePg()
 {
	location.href = "/Envr/JSP/LoggedInCom.jsp";
 }
 function toknScnPg()
 {
	location.href = "/BirlaWhite/Trans/Token/TokenRecd.jsp";
 }
</script>


<%@ include file="/Envr/JSP/SecurityCom.jsp"%>
<%@ include file="/Envr/Login/LYPEnvrSet.jsp"%>

<%
CallableStatement cstmt = null;
ResultSet rset = null;

boolean dbSubmit = false,
		sysOutFl = true;

if (sysOutFl)
{
	LypSessBean.setSqlToDsp(true);
//	WebSessBean.setSqlToDsp(true);
}

if (sysOutFl) // System.out.println("In Token Scanning 1");

String  sql = "",
		custCode = XssFilter.parSmGet("custCode"),
		tokenNum = "",
		areaCode = log.getArCode(),
		inflCode = "INF00000",
		inflName = "Anuhit",
		mobileNo = "9798000000",
		naration = "",
		cheqNumb = "",
		dbTknNum = "",
		tokenNuH = "",
		randNumb = "",
		cheqDate = "",
		cnDnTyCd = "",
		refDocNo = "",
		exprFlag = "",
		locMsgDs = "",
		tokenNumStr = "",
		inflCodeStr = "",
		srNumber[] = XssFilter.parArGet("srNumber"),
		dpTKNIns = (String) session.getAttribute("dpTKNIns");

int 	trnIndex = 0;
		String trnTrail = "";

		String  msg = "",
				procType = "",
				docuType = "TKN",
				cdnDocTy = "CRN",
				tokenVld = "",
				tokenIdn = "",
				wrongStr = "",
				rightStr = "",
				custAcCd = "01",
				deducStr = "",
				docuNumb = "",
				bcTknTyp = "",
				dbActSts = "",
				invDocNo = "",
				invnSrNo = "",
				bcTknSav = "",
				mdOfDisb = "",
				scnMlStt = "",
				updIdAct = "",
				updIdMlt = "",
				updateId = "",
				tralhist = "",
				toknHsty = "",
				statFlag = "A",
				prodCodeArr[] = {"","","","","","","",""}, 
				docuDate = WebSessBean.mnthEnDtGet(docuType);
		int 	wrongEnt = 0,
				rightEnt = 0,
				rightCnt = 0,
				scnMlCnt = 0,
				scnMlAlw = 0,
				sysOutId = 0,
				alrdyScn = 0,
				prodCode = 0,
				prdCount = 0,
				prodCodeHd = 0,
				wrongCnt = 0;

		double  payblAmt = 0,
				basTknAm = 0,
				handAmnt = 0,
				tokenVal = 0,
				scnDedAm = 0,
				scnrDdLf = 0,
				handRate = 0,
				scnrDdRt = 0,
				scDdAmCl = 0,
				discQnty = 0,
				discRate = 0,
				tdsTotAm = 0,
				tokEndVl = 0;

		boolean prdFound = false,
				webLogin = false;


if(XssFilter.parSmGet("areaCode") != null)
	areaCode = XssFilter.parSmGet("areaCode");

if(XssFilter.parSmGet("randNumb") != null)
	randNumb = XssFilter.parSmGet("randNumb");

 //// System.out.println("In Token Scanning 1 " + custCode);
if (sysOutFl) 
	// System.out.println("In Token Scanning 2 " + custCode);
try
{
	if (sysOutFl) // System.out.println("In Token Scanning 3 " + loginIdM + " dpTKNIns : " + dpTKNIns);

	if(dpTKNIns == null || (dpTKNIns != null && dpTKNIns.equals("Y")))
	{
		dbSubmit = true;
		throw new Exception("Duplicate Entry, please open fresh page from menu and try again " + loginIdM);
	}

	if (sysOutFl) // System.out.println("In Token Scanning 4 " + loginIdM + " " + dbSubmit);

	session.setAttribute("dpTKNIns", "Y");
	sql = "set dateformat YMD";
	LypSessBean.updateRecord(sql);
	
	areaCode = log.getArCode();
	userType = log.getUserType();


	LypSessBean.setAutoCommit(false);
//	WebSessBean.setAutoCommit(false);

	if (sysOutFl) // System.out.println("In Token Scanning 5 " + loginIdM + " " + dbSubmit);
	docuNumb = WebSessBean.getDocumentNo(docuType, areaCode);
//	WebSessBean.setAutoCommit(false);
	
	if(!randNumb.equals(""))
	{
		sql = "update dptTknTestg set docuNumb = '" + docuNumb + "' where uniqueId = '" + randNumb + "' and createDt > getdate()-1 ";
		LypSessBean.updateRecord(sql);
	}
	if (sysOutFl) // System.out.println("In Token Scanning 6 " + loginIdM + " " + dbSubmit);
	for(int i=0; i<srNumber.length; i++)
	{
		if(XssFilter.parSmGet("tokenNum" + srNumber[i]) != null)
		{
			tokenNum = XssFilter.parSmGet("tokenNum" + srNumber[i]).trim();
			
			if(!tokenNuH.equals("") && tokenNuH.equals(tokenNum))	// Added By Rajendra For Cross Duplicate Validation
			{
				tokenNum = ""; 
			}
			tokenNuH = tokenNum;
		}
		else 
			tokenNum = "";
		
		if (sysOutFl)// System.out.println( "inflCode" + inflCode );

		if(!tokenNum.equals(""))
		{
			tralhist += " <br> Token No : " + tokenNum;
			toknHsty += "," + tokenNum;
			sql = " insert into dpmTknTestg (docuNumb, tokenNum,mobileNo,inflName,inflCode,createId,createDt) values("  
				+ " '" + docuNumb + "',"
				+ " '" + tokenNum + "',"
				+ " '" + mobileNo + "',"
				+ " '" + inflName + "',"
				+ " '" + inflCode + "',"
				+ " '" + loginIdM + "',"
				+ " getdate())";
	//		// System.out.println(sql);
			LypSessBean.updateRecord(sql);

			bcTknTyp = "";
			bcTknSav = "";
			updateId = "";
			prodCode = 0;
			tokenVal = 0;
			handRate = 0;
			scnrDdRt = 0;
			tokEndVl = 0;
		//	// System.out.println("3");
			
			sql = "exec bwlive.dbo.dppToknProc 'jav01', '" + tokenNum + "', 0";
			rset = LypSessBean.selectRecord(sql);
			if(rset.next())
			{
				bcTknTyp = rset.getString(1);
				tokenVal = rset.getDouble(2);
				handRate = rset.getDouble(3);
				scnrDdRt = rset.getDouble(4);
				tokEndVl = rset.getDouble(5);
				prodCode = rset.getInt(6);
				updateId = rset.getString(7);
				dbActSts = rset.getString(8);
				exprFlag = rset.getString(9);

				bcTknSav = bcTknTyp;
				if (sysOutFl)// System.out.println((++sysOutId) + " In Rset . bcTknTyp : " + bcTknTyp + ". tokenVal : " + tokenVal + ". prodCode : " + prodCode + ". updateId : " + updateId);
			}
			trnTrail += "\n" + (++trnIndex) + ". Token Valid Flag Java " + tokenVld;
			 /** Changes Done by RajendrA 19 Dec 2022 **/
			
			
			tralhist += " <br> bcTknTyp No : " + bcTknTyp;

			scnMlStt = "";
			scnMlCnt = 0;

		   if(!exprFlag.equals("Y"))
		   {
				sql = "select b.isActive, b.scnMlCnt, b.scnMlAlw, isNull(b.updateId, '') from dpmToknMlSc b with (nolock) where b.tokenNum = '" + tokenNum + "' and b.isActive='Y' and b.scnMlCnt < b.scnMlAlw";
				rset = LypSessBean.selectRecord(sql);
			//	// System.out.println(sql);
				if(rset.next())
				{
					scnMlStt = rset.getString(1);
					scnMlCnt = rset.getInt(2);
					scnMlAlw = rset.getInt(3);
					updIdMlt = rset.getString(4).trim();

					if(updateId.equals(loginIdM) && scnMlStt.equals("Y"))
					{
						scnMlStt = "";
						scnMlCnt = 0;
					}
				}

				sql = "update dpmTokenNos set isActive = 'Z', updateId = '" + loginIdM + "', updateDt=getdate() where tokenNum = '" + tokenNum + "' and case when getdate() > dbo.dpfTknValDt('" + bcTknSav + "','" + areaCode + "') then cast(getdate() - printgDt as smallint) else 1 end <= validDay + dbo.dpfTknValDy('" + bcTknSav + "','" + areaCode + "') "; 

				if(scnMlCnt == 0)
					sql += "and isActive = 'Y'";
				else
					sql += "and isActive = 'Z'";

				int updatCnt = LypSessBean.updateRecord(sql);
				trnTrail += "\n" + (++trnIndex) + ". Token Master updated " + updatCnt + " " + sql;
			//	// System.out.println(sql);
				if(updatCnt > 0 || !scnMlStt.equals(""))
				{
					/** Changes Done by RajendrA 19 Dec 2022 **/
					if(!scnMlStt.equals(""))
					{
						scnMlCnt++;
						if(scnMlCnt == scnMlAlw)
							scnMlStt = "Z";
						else
							scnMlStt = "Y";

						sql = "update dpmToknMlSc set isActive = '" + scnMlStt + "', scnMlCnt = '" + scnMlCnt + "', updateId = '" + loginIdM + "', updateDt = getdate() where tokenNum = '" + tokenNum + "' and isActive='Y'"; 
						updatCnt = LypSessBean.updateRecord(sql);
					//	// System.out.println("11");
						if(updatCnt <= 0)
						{
							trnTrail += "\n" + (++trnIndex) + ". dpmToknMlSc not updated " + updatCnt + " " + sql;
							throw new Exception("Please Contact to IT Birlawhite, Token Status not updated for Token No " + tokenNum);
						}
					}
					
					if(prodCode > 0)
					{
						trnTrail += "\n" + (++trnIndex) + ". Token Master selected " + sql;

						basTknAm += tokenVal;
						payblAmt += tokEndVl;
						handAmnt += handRate;
						scDdAmCl += scnrDdRt;
						tokenVld = "Y";
						rightEnt++;
					}
					else
					{
						throw new Exception("Please Contact to IT Birlawhite, Token Rate not updated for Token No " + tokenNum);
					}
				}
				else
				{
					// Added By Rajendra / Navin for Remove block of already scan token

					sql = " select tokenNum from dpmTokenNos with (nolock) where tokenNum = '" + tokenNum + "' and isActive in ('Z','X','Y') union all select tokenNum from dpaTokenNos with (nolock) where tokenNum = '" + tokenNum + "' and isActive in ('Z','X','Y') ";
					rset = LypSessBean.selectRecord(sql);
				//	// System.out.println("12");
					if(rset.next())
					{
						dbTknNum = rset.getString(1);
					}
					
					if(dbTknNum.equals(""))
					{
						wrongEnt++;		
						dbTknNum = "";
					}
					else
					{
						alrdyScn++;
					}
					wrongStr += ", " + tokenNum;
					tokenVld = "N";
				}
		   }
		   else
		   {
			   tokenVld = "N";
			 //  tokenVal = 0;
			 //  handRate = 0;
			 //  tokEndVl = 0;
		   }
			tralhist += " <br> insert into dptTokenRecDtl before ";
			
			sql = "insert into dptTokenRecDtl (docuNumb, tokenNum, tokenVld, exprFlag, toknStat, bcTknTyp, tokenVal, handRate, tokEndVl, prodCode, inflCode, statFlag, createId, createDt) values ("
				+ "'" +	docuNumb + "', "
				+ "'" + tokenNum + "', "
				+ "'" + tokenVld + "', "
				+ "'" + exprFlag + "', "
				+ "'" + dbActSts + "', "
				+ "'" + bcTknTyp + "', "
				+ "'" + tokenVal + "', "
				+ "'" + handRate + "', "
				+ "'" + tokEndVl + "', "
				+ "'" + prodCode + "', "
				+ "'" + inflCode + "', "
				+ "'" + statFlag + "', "
				+ "'" + loginIdM + "', "
				+ "getdate())";

			LypSessBean.updateRecord(sql);
			tralhist += " <br> inserted into dptTokenRecDtl ";
		//	// System.out.println(sql);
			trnTrail += "\n" + (++trnIndex) + ". Detail Inserted " + sql;
		}
		payblAmt -= scnDedAm;
		prodCodeHd = prodCode;
	}

	sql = "insert into cdtTokenRec (docuNumb, docuDate, tokenTyp, cdnDocTy, custCode, prodCode, recptQty, basTknAm, handAmnt, scnDedAm, payblAmt, statFlag, createId, createDt) values("
		+ "'" +	docuNumb + "', "
		+ "'" +	LypSessBean.dmyTOymd(docuDate) + "', "
		+ "'BC', "
		+ "'" + cdnDocTy + "', "
		+ "'" + custCode + "', "
		+ "0, 0, 0, 0, "
		+ "0, 0, "
		+ "'" + statFlag + "', "
		+ "'" + loginIdM + "', "
		+ "getdate())";
	LypSessBean.updateRecord(sql);
//	// System.out.println(sql);

	sql = "update cdtTokenRec set recptQty = " + rightEnt + ", basTknAm = " + basTknAm + ", handAmnt = " + handAmnt + ", payblAmt = " + payblAmt + ", scnDedAm = " + scnDedAm + ", prodCode = " + prodCodeHd + ", updateId = '" + loginIdM + "', updateDt = getdate()   where docuNumb = '" + docuNumb + "'";
	int j = LypSessBean.updateRecord(sql);

	if (j < 1)
	{
		throw new Exception("No Record found in Header, Contact IT Dept, Birla White");
			//trnTrail += "\n" + (++trnIndex) + ". Header Updated after Detail Insertion " + loginIdM + " " + sql;
	}

	if(userType.equals("R"))
		mdOfDisb = "01";
	else
		mdOfDisb = "04";
			
	if(payblAmt > 0)
	{
		discQnty = rightEnt;
		discRate = tokEndVl;
		cnDnTyCd = "11";
		naration = "Paper Token Receipt Entry for " + rightEnt + " Qty";
		mdOfDisb = mdOfDisb;
		
		if(bcTknTyp.equals("E1"))
		{
			refDocNo = "NA";
		}
		
		sql = "insert into cdtCusToPay (docuNumb, custCode, custAcCd, cdnDocTy, invDocNo, invnSrNo, prodCode, strtDate, endgDate, discQnty, discRate, dtlSbTot, deducAmt, tdsTotAm, cnDnTyCd, naration, mdOfDisb, statFlag, createId, createDt, cheqNumb, cheqDate, refDocNo) values ("
			+ "'" + docuNumb + "', "
			+ "'" + custCode + "', "
			+ "'" + custAcCd + "', "
			+ "'" + cdnDocTy + "', "
			+ "'" + invDocNo + "', "
			+ "'" + invnSrNo + "', "
			+ "'" + prodCode + "', "
			+ "'" + LypSessBean.dmyTOymd(docuDate) + "', "
			+ "'" + LypSessBean.dmyTOymd(docuDate) + "', "
			+ "'" + discQnty + "', "
			+ "'" + discRate + "', "
			+ "'" + (payblAmt + scnDedAm) + "', "
			+ "'" + scnDedAm + "', "
			+ "'" + tdsTotAm + "', "
			+ "'" + cnDnTyCd + "', "
			+ "'" + naration + "', "
			+ "'" + mdOfDisb + "', "
			+ "'" + statFlag + "', "
			+ "'" + loginIdM + "', ";

		sql += "getdate(), ";

		if (cheqNumb.equals(""))
			sql += "null, ";
		else
			sql += "'" + cheqNumb + "', ";

		if (cheqDate.equals(""))
			sql += "null, ";
		else
			sql += "'" + cheqDate + "', ";

		if (refDocNo.equals(""))
			sql += "null, ";
		else
			sql += "'" + refDocNo + "', ";

	//	sql = sql.substring(0, sql.length() - 2) + ")";
	//	WebSessBean.updateRecord(sql);
	//	// System.out.println(sql);
	}
	
	/*
	sql = "select isNull(sum(case when b.tokenVld = 'Y' then 1 else 0 end), 0) as rightCnt, isNull(sum(case when b.tokenVld <> 'Y' then 1 else 0 end), 0) as wrongCnt from cdtTokenRec a with (nolock), dptTokenRecDtl b with (nolock) where a.docuNumb = b.docuNumb and a.docuNumb = '" + docuNumb + "' and b.statFlag not in ('C', 'R')";
	rset = WebSessBean.selectRecord(sql);
	if(rset.next())
	{
		rightCnt = rset.getInt(1);
		wrongCnt = rset.getInt(2);
	}
			
	trnTrail += "\n" + (++trnIndex) + ". rightEnt " + rightEnt + ". rightCnt " + rightCnt + ". wrongEnt " + wrongEnt + ". wrongCnt " + wrongCnt;
	*/		
	WebSessBean.setDocumentNo(docuType, areaCode);

	if(scnDedAm > 0) // for Retailer and customer both
	{
		sql = "insert into dptToknScnrDtl (docuNumb, docuDate, userCode, docuNarr, vouDrAmt, vouCrAmt, statFlag, createId, createDt) values ("
		+ "'" +	docuNumb + "', " 
		//+ "'" + dmyTOymd(docuDate) + "', "
		+ "'" + custCode + "', "
		+ "'Dedc. against Scanner Issued, amount left " + scnrDdLf + "', "
		+ " 0, "
		+ " " + scnDedAm + ", "
		+ " 'N', "
		+ "'" + loginIdM + "', "
		+ "getdate())";
		LypSessBean.updateRecord(sql);
	//	// System.out.println(sql);
		deducStr = ",Amount deducted for scanner " + scnDedAm + ", remaining amount " + scnrDdLf;
	}

	trnTrail += "\n" + (++trnIndex) + ". Header Updated after Detail Insertion " + sql;

	if(wrongEnt > 10)
	{
		sql = "update wcmUserCred set blckedDt = getdate(), updateId = '" + loginIdM + "', updateDt = getdate() where loginIdM ='" + loginIdM + "'";
		LypSessBean.updateRecord(sql);
	}
		
	if(wrongStr.trim().equals(""))
		wrongStr = "None";


	msg += "@br@ Your Batch No is : " + docuNumb + " @br@ Token Value is " + basTknAm + " @br@ Right Entries  : " + rightEnt + " @br@ Wrong Entries : " + alrdyScn + deducStr + " @br@ Payble Amt " + payblAmt; 

	if (sysOutFl) // System.out.println("msg" + msg);
	msg = "@br@Your Request has been Processed! @br@" + msg;
	

	if(!userType.equals("R")) 	
	{
		msg += ", @br@Credit Note will be generated at the end of the day.";
	}
	// // System.out.println(trnTrail);
	
	tralhist += " <br> End ";

//	if(rightCnt != rightEnt)
//	{
//		 sql = "insert into cotMailSend (sentFlag, emailTos, emailCcs, emailBcc, emailSub, emailBdy, bodyFrmt, createDt)"
//			 + " select 'N', 'rajendra.sikhwal@adityabirla.com', '', '', 'Token Scanning of : " + loginIdM + ". Document No //: " + docuNumb + "', '" + tralhist + " <br> " + toknHsty + "', 'HTML', getdate() ";
//		
//	 //// System.out.println(sql);
//		WebSessBean.updateRecord(sql);
//	}

//	if(rightCnt != rightEnt)
//	{
//		WebSessBean.rollbackConn();
//		LypSessBean.rollbackConn();
//		throw new Exception("Due to some technical issue, Data not Saved. Please re-scan and check. Birla White");
//	//	trnTrail += "\n" + (++trnIndex) + ". Header Updated after Detail Insertion " + loginIdM + " " + sql;
//	}
//	// System.out.println("Transaction End " + docuNumb);
//	WebSessBean.setDocumentNo(docuType, areaCode);

	// WebSessBean.rollbackConn();
	// LypSessBean.rollbackConn();


//	WebSessBean.commitConn();
	LypSessBean.commitConn();
//	WebSessBean.commitConn();
	
	locMsgDs += "\n" + (++trnIndex) + ". commited with message " + msg;
	trnIndex = 0;
	response.sendRedirect("TknScanDtl.jsp?savPagFl=Y&erMsgRtn=" + msg + "");
	//response.sendRedirect(errorPage + "?message=" + msg);
}
catch (Exception e)
{
	//if (!dbSubmit) // Commented 03-Feb-20 To review for Header Fields not updated in cdtTokenRec 
	WebSessBean.rollbackConn();
	LypSessBean.rollbackConn();
	session.setAttribute("dpTKNIns", "N");
	locMsgDs += "\n" + (++trnIndex) + ". Rollback with Error " + e.toString();
	throw new Exception("Error in updating details in " + pageAddress + e.toString());
}
finally
{
//	WebSessBean.rollbackConn();
//	LypSessBean.rollbackConn();

//	if(trnIndex > 0)
//		JSPMail.setAll("sqladmn@adityabirla.com", "vaibhav.jain@adityabirla.com", "", "Bar Code Token Scanning of : " + loginIdM, LypSessBean.trnTrailGet() +  locMsgDs, "", "");
	UtilBean.sessMgmtRst();
}
%>
