// Controllers/SmsUaeController.cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using sparshWebService.DataAccess; // DatabaseHelper
using System;
using System.Collections.Generic;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
using System.Linq;

#nullable enable

namespace sparshWebService.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public sealed class SmsUaeController : ControllerBase
    {
        private readonly IConfiguration _cfg;
        private readonly ILogger<SmsUaeController> _log;
        private readonly DatabaseHelper _db;

        public SmsUaeController(IConfiguration cfg, ILogger<SmsUaeController> log, DatabaseHelper db)
        {
            _cfg = cfg;
            _log = log;
            _db = db;
        }

        // ===== Request models =====
        public sealed class SmsUaeRequest
        {
            public string MobileNo { get; set; } = "";   // e.g. "971521302203" or "521302203"
            public string Message { get; set; } = "";   // e.g. "Dear User Your OTP is : 123456 Birla White (RAK)"
            public string Priority { get; set; } = "High";
            public string CountryCode { get; set; } = "ALL";
        }

        public sealed class RouteByMobileRequest
        {
            public string MobileNo { get; set; } = "";
        }

        public sealed class InfluencerDetailsResponse
        {
            // Core
            public string? InflCode { get; set; }
            public string? InflType { get; set; }   // "PN" = Painter, else Contractor
            public string? Route { get; set; }      // "painter" | "contractor"
            public string? AreaCode { get; set; }

            // Names / contact
            public string? FirstName { get; set; }
            public string? MiddleName { get; set; }
            public string? LastName { get; set; }
            public string? MobileNumber { get; set; }
            public string? Address { get; set; }    // inflAdd1
            public string? Emirates { get; set; }

            // Painter-specific (varchar 255)
            public string? EmiratesIdNumber { get; set; } // emiridno
            public string? IdName { get; set; }           // idholder
            public string? Nationality { get; set; }      // nationty
            public string? CompanyDetails { get; set; }   // employer
            public string? IssueDate { get; set; }        // issudate
            public string? ExpiryDate { get; set; }       // expirydt
            public string? Occupation { get; set; }       // occupatn
            public string? BankAddress { get; set; }      // bankaddr

            // Contractor/shared 255s
            public string? ContractorType { get; set; }    // contrtyp
            public string? AccountHolderName { get; set; } // bankApNm
            public string? IbanNumber { get; set; }        // ibannumb
            public string? BankName { get; set; }          // bankBnNm
            public string? BranchName { get; set; }        // bankBnDs

            // VAT
            public string? FirmName { get; set; }               // vatfrmnm
            public string? VatAddress { get; set; }             // vatraddr
            public string? TaxRegistrationNumber { get; set; }  // vattxreg
            public string? VatEffectiveDate { get; set; }       // vatefdt

            // License cluster
            public string? LicenseNumber { get; set; }     // comlcnno
            public string? IssuingAuthority { get; set; }  // comissau
            public string? LicenseType { get; set; }       // comlctyp
            public string? EstablishmentDate { get; set; } // comestdt
            public string? LicenseExpiryDate { get; set; } // comexpdt
            public string? TradeName { get; set; }         // comtrdnm
            public string? ResponsiblePerson { get; set; } // comrespn
            public string? LicenseAddress { get; set; }    // comraddr
            public string? EffectiveDate { get; set; }     // comeffdt
        }

        // ===== Kyoto options (override via appsettings:SmsUae) =====
        private sealed class SmsUaeOptions
        {
            public string BaseUrl { get; set; } = "http://sms.kyoto-tech.com/sendurl.aspx";
            public string User { get; set; } = "RAK1976487";
            public string Password { get; set; } = "******";
            public string SenderId { get; set; } = "RAKWHITE";

            public bool UseProxy { get; set; } = true;
            public string ProxyHost { get; set; } = "185.46.212.90";
            public int ProxyPort { get; set; } = 80;
            public string ProxyUser { get; set; } = "******";
            public string ProxyPassword { get; set; } = "******";

            // Only relevant if you switch BaseUrl to HTTPS
            public bool TrustAllSsl { get; set; } = true;
        }

        private SmsUaeOptions LoadOptions()
        {
            var opt = new SmsUaeOptions();
            var section = _cfg.GetSection("SmsUae");
            if (section.Exists()) section.Bind(opt);
            return opt;
        }

        // --- Forwarding options (override via appsettings:SmsForward) ---
        private sealed class SmsForwardOptions
        {
            public string TargetUrl { get; set; } =
                "https://www.birlawhite.com:55230/api/SmsUae/send";

            public bool TrustAllSsl { get; set; } = false;
            public int TimeoutSeconds { get; set; } = 30;
        }

        private SmsForwardOptions LoadForwardOptions()
        {
            var opt = new SmsForwardOptions();
            var section = _cfg.GetSection("SmsForward");
            if (section.Exists()) section.Bind(opt);
            return opt;
        }

        // ===== Health =====
        [HttpGet("health")]
        public IActionResult Health() => Ok(new { status = "OK", utc = DateTime.UtcNow });

        // ===== Helpers =====
        private static string Digits(string? s)
        {
            if (string.IsNullOrEmpty(s)) return "";
            var sb = new StringBuilder(s.Length);
            foreach (var ch in s)
                if (ch >= '0' && ch <= '9') sb.Append(ch);
            return sb.ToString();
        }

        private static string LastNDigits(string s, int n)
        {
            var d = Digits(s);
            return d.Length <= n ? d : d.Substring(d.Length - n);
        }

        private static string SqlDigitsExpr(string column)
        {
            // Remove space, +, -, (, ) in SQL side
            return $"REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(ISNULL({column},''),' ',''),'-',''),'+',''),'(',''),')','')";
        }

        private static string NormalizeToMsisdn(string raw)
        {
            // For Kyoto: ensure "971" + 9 digits
            var d9 = LastNDigits(raw, 9);
            return "971" + d9;
        }

        private (bool found, string inflType) FindInflTypeByMobile(string mobileInput)
        {
            // Accept any input; compare on digits-only using 9 and 11 last digits
            var m9 = LastNDigits(mobileInput, 9);
            var m11 = LastNDigits(mobileInput, 11);
            if (string.IsNullOrEmpty(m9)) return (false, "");

            var digitsSql = SqlDigitsExpr("mobileNo");

            var sql = $@"
SELECT TOP 1 inflType
FROM dbo.ctmInfluncr WITH (NOLOCK)
WHERE RIGHT({digitsSql}, 9)  = @m9
   OR RIGHT({digitsSql}, 11) = @m11
   OR mobileNo = @m9
   OR mobileNo = @m11
ORDER BY ISNULL(createDt, '1900-01-01') DESC;";

            var prms = new Dictionary<string, object?>
            {
                ["@m9"] = m9,
                ["@m11"] = m11
            };

            var rows = _db.QaEWebBean(sql, prms) ?? new List<Dictionary<string, object>>();
            if (rows.Count == 0) return (false, "");

            var inflType = (rows[0]["inflType"]?.ToString() ?? "").Trim().ToUpperInvariant();
            return (true, inflType);
        }

        private InfluencerDetailsResponse? FetchFullDetailsByMobile(string mobileInput, string routeFromType)
        {
            var m9 = LastNDigits(mobileInput, 9);
            var m11 = LastNDigits(mobileInput, 11);
            var digitsSql = SqlDigitsExpr("mobileNo");

            var sql = $@"
SELECT TOP 1
    inflCode, inflType, areaCode,
    frstname, middname, lastname,
    mobileNo, inflAdd1, emirates,

    -- painter 255s
    emiridno, idholder, nationty, employer, issudate, expirydt, occupatn, bankaddr,

    -- contractor/shared 255s
    contrtyp, bankApNm, ibannumb, bankBnNm, bankBnDs,

    -- VAT
    vatfrmnm, vatraddr, vattxreg, vatefdt,

    -- license cluster
    comlcnno, comissau, comlctyp, comestdt, comexpdt,
    comtrdnm, comrespn, comraddr, comeffdt
FROM dbo.ctmInfluncr WITH (NOLOCK)
WHERE RIGHT({digitsSql}, 9)  = @m9
   OR RIGHT({digitsSql}, 11) = @m11
   OR mobileNo = @m9
   OR mobileNo = @m11
ORDER BY ISNULL(updateDt, createDt) DESC, createDt DESC;";

            var rows = _db.QaEWebBean(sql, new Dictionary<string, object?>
            {
                ["@m9"] = m9,
                ["@m11"] = m11
            });

            var row = rows?.FirstOrDefault();
            if (row == null) return null;

            return new InfluencerDetailsResponse
            {
                InflCode = row["inflCode"]?.ToString(),
                InflType = (row["inflType"]?.ToString() ?? "").Trim().ToUpperInvariant(),
                Route = routeFromType,
                AreaCode = row["areaCode"]?.ToString(),

                FirstName = row["frstname"]?.ToString(),
                MiddleName = row["middname"]?.ToString(),
                LastName = row["lastname"]?.ToString(),
                MobileNumber = row["mobileNo"]?.ToString(),
                Address = row["inflAdd1"]?.ToString(),
                Emirates = row["emirates"]?.ToString(),

                EmiratesIdNumber = row["emiridno"]?.ToString(),
                IdName = row["idholder"]?.ToString(),
                Nationality = row["nationty"]?.ToString(),
                CompanyDetails = row["employer"]?.ToString(),
                IssueDate = row["issudate"]?.ToString(),
                ExpiryDate = row["expirydt"]?.ToString(),
                Occupation = row["occupatn"]?.ToString(),
                BankAddress = row["bankaddr"]?.ToString(),

                ContractorType = row["contrtyp"]?.ToString(),
                AccountHolderName = row["bankApNm"]?.ToString(),
                IbanNumber = row["ibannumb"]?.ToString(),
                BankName = row["bankBnNm"]?.ToString(),
                BranchName = row["bankBnDs"]?.ToString(),

                FirmName = row["vatfrmnm"]?.ToString(),
                VatAddress = row["vatraddr"]?.ToString(),
                TaxRegistrationNumber = row["vattxreg"]?.ToString(),
                VatEffectiveDate = row["vatefdt"]?.ToString(),

                LicenseNumber = row["comlcnno"]?.ToString(),
                IssuingAuthority = row["comissau"]?.ToString(),
                LicenseType = row["comlctyp"]?.ToString(),
                EstablishmentDate = row["comestdt"]?.ToString(),
                LicenseExpiryDate = row["comexpdt"]?.ToString(),
                TradeName = row["comtrdnm"]?.ToString(),
                ResponsiblePerson = row["comrespn"]?.ToString(),
                LicenseAddress = row["comraddr"]?.ToString(),
                EffectiveDate = row["comeffdt"]?.ToString()
            };
        }

        // ===== 1) Verify: /api/SmsUae/verify-mobile =====
        [HttpPost("verify-mobile")]
        public IActionResult VerifyMobile([FromBody] RouteByMobileRequest req)
        {
            try
            {
                if (req == null || string.IsNullOrWhiteSpace(req.MobileNo))
                    return BadRequest(new { success = false, message = "MobileNo is required." });

                var (found, inflType) = FindInflTypeByMobile(req.MobileNo);
                if (!found)
                    return NotFound(new { success = false, exists = false, message = "Mobile not registered." });

                return Ok(new { success = true, exists = true, inflType });
            }
            catch (Exception ex)
            {
                _log.LogError(ex, "verify-mobile failed");
                return StatusCode(500, new { success = false, message = "Error verifying mobile.", error = ex.Message });
            }
        }

        // ===== 2) Route + FULL DETAILS: /api/SmsUae/route-by-mobile =====
        [HttpPost("route-by-mobile")]
        public IActionResult RouteByMobile([FromBody] RouteByMobileRequest req)
        {
            try
            {
                if (req == null || string.IsNullOrWhiteSpace(req.MobileNo))
                    return BadRequest(new { success = false, message = "MobileNo is required." });

                var (found, inflType) = FindInflTypeByMobile(req.MobileNo);
                if (!found)
                    return NotFound(new { success = false, exists = false, message = "Mobile not registered." });

                var route = inflType == "PN" ? "painter" : "contractor";
                var data = FetchFullDetailsByMobile(req.MobileNo, route);
                if (data == null)
                    return NotFound(new { success = false, exists = false, message = "Mobile found but profile not resolved." });

                return Ok(new
                {
                    success = true,
                    exists = true,
                    inflType = data.InflType,
                    route = data.Route,
                    data
                });
            }
            catch (Exception ex)
            {
                _log.LogError(ex, "route-by-mobile (details) failed");
                return StatusCode(500, new { success = false, message = "Error deciding route / fetching details.", error = ex.Message });
            }
        }

        // ===== 3) Direct Send (Forward JSON to external API): /api/SmsUae/send =====
        [HttpPost("send")]
        public async Task<IActionResult> Send([FromBody] SmsUaeRequest req, CancellationToken ct)
        {
            if (req is null ||
                string.IsNullOrWhiteSpace(req.MobileNo) ||
                string.IsNullOrWhiteSpace(req.Message))
            {
                return BadRequest(new { success = false, message = "mobileNo and message are required." });
            }

            var fwd = LoadForwardOptions();

            // Build HttpClient handler (proxy/trust settings if needed)
            var handler = new HttpClientHandler();
            if (fwd.TrustAllSsl)
            {
                handler.ServerCertificateCustomValidationCallback =
                    HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;
            }

            try
            {
                using var http = new HttpClient(handler, disposeHandler: true)
                {
                    Timeout = TimeSpan.FromSeconds(fwd.TimeoutSeconds <= 0 ? 30 : fwd.TimeoutSeconds)
                };

                // Serialize with camelCase to match external API keys
                var json = JsonSerializer.Serialize(req, new JsonSerializerOptions
                {
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                });

                // Use explicit request + headers (helps avoid WAF 406)
                using var msg = new HttpRequestMessage(HttpMethod.Post, fwd.TargetUrl)
                {
                    Content = new StringContent(json, Encoding.UTF8, "application/json")
                };
                msg.Headers.TryAddWithoutValidation("User-Agent", "BW-QA-Gateway/1.0");
                msg.Headers.TryAddWithoutValidation("Accept", "application/json, */*;q=0.8");
                msg.Headers.ExpectContinue = false;

                var resp = await http.SendAsync(msg, ct);
                var respBody = await resp.Content.ReadAsStringAsync(ct);

                // Pass-through style response (plus meta for debugging)
                return StatusCode((int)resp.StatusCode, new
                {
                    success = resp.IsSuccessStatusCode,
                    statusCode = (int)resp.StatusCode,
                    forwardedTo = fwd.TargetUrl,
                    requestBody = req,          // echoes what we sent
                    response = respBody
                });
            }
            catch (TaskCanceledException tex) when (!ct.IsCancellationRequested)
            {
                // Timeout
                _log.LogError(tex, "SmsUaeController.send timed out");
                return StatusCode(504, new { success = false, message = "Upstream timeout.", error = tex.Message });
            }
            catch (Exception ex)
            {
                _log.LogError(ex, "SmsUaeController.send failed");
                return StatusCode(500, new { success = false, message = "Error forwarding SMS.", error = ex.Message });
            }
        }

        // ===== 4) Verify + Send (Kyoto form-post): /api/SmsUae/send-if-registered =====
        [HttpPost("send-if-registered")]
        public async Task<IActionResult> SendIfRegistered([FromBody] SmsUaeRequest req, CancellationToken ct)
        {
            try
            {
                if (req is null || string.IsNullOrWhiteSpace(req.MobileNo) || string.IsNullOrWhiteSpace(req.Message))
                    return BadRequest(new { success = false, message = "MobileNo and Message are required." });

                // 1) verify
                var (found, inflType) = FindInflTypeByMobile(req.MobileNo);
                if (!found)
                    return NotFound(new { success = false, exists = false, message = "Mobile not registered." });

                // 2) normalize to MSISDN for Kyoto (971 + last 9)
                var msisdn = NormalizeToMsisdn(req.MobileNo);

                // forward to Kyoto with normalized number
                var toSend = new SmsUaeRequest
                {
                    MobileNo = msisdn,
                    Message = req.Message,
                    Priority = string.IsNullOrWhiteSpace(req.Priority) ? "High" : req.Priority,
                    CountryCode = string.IsNullOrWhiteSpace(req.CountryCode) ? "ALL" : req.CountryCode
                };

                var opt = LoadOptions();

                static string FormEnc(string s) => Uri.EscapeDataString(s ?? string.Empty);
                var sb = new StringBuilder();
                sb.Append("user=").Append(FormEnc(opt.User))
                  .Append("&pwd=").Append(FormEnc(opt.Password))
                  .Append("&senderid=").Append(FormEnc(opt.SenderId))
                  .Append("&mobileno=").Append(FormEnc(toSend.MobileNo))
                  .Append("&msgtext=").Append(FormEnc(toSend.Message))
                  .Append("&priority=").Append(FormEnc(toSend.Priority))
                  .Append("&CountryCode=").Append(FormEnc(toSend.CountryCode));
                var formBody = sb.ToString();

                var handler = new HttpClientHandler();
                if (opt.UseProxy && !string.IsNullOrWhiteSpace(opt.ProxyHost))
                {
                    var proxy = new WebProxy(opt.ProxyHost, opt.ProxyPort)
                    {
                        BypassProxyOnLocal = false,
                        Credentials = new NetworkCredential(opt.ProxyUser, opt.ProxyPassword)
                    };
                    handler.Proxy = proxy;
                    handler.UseProxy = true;
                }
                if (opt.TrustAllSsl)
                {
                    handler.ServerCertificateCustomValidationCallback =
                        HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;
                }

                using var http = new HttpClient(handler, disposeHandler: true);
                using var content = new StringContent(formBody, Encoding.UTF8, "application/x-www-form-urlencoded");
                var resp = await http.PostAsync(opt.BaseUrl, content, ct);
                var body = await resp.Content.ReadAsStringAsync(ct);

                var route = inflType == "PN" ? "painter" : "contractor";
                return Ok(new
                {
                    success = true,
                    exists = true,
                    inflType,
                    route,
                    kyotoStatus = (int)resp.StatusCode,
                    kyotoResponse = body
                });
            }
            catch (Exception ex)
            {
                _log.LogError(ex, "send-if-registered failed");
                return StatusCode(500, new { success = false, message = "Error sending SMS.", error = ex.Message });
            }
        }
    }
}
